{
    "type": "module",
    "label": "from datetime import datetime\n\nimport pytest\nfrom prisma.models import CreditTransaction\n\nfrom backend.blocks.llm import AITextGeneratorBlock\nfrom backend.data.credit import UserCredit\nfrom backend.data.user import DEFAULT_USER_ID\nfrom backend.integrations.credentials_store import openai_credentials\nfrom backend.util.test import SpinTestServer\n\nREFILL_VALUE = 1000\nuser_credit = UserCredit(REFILL_VALUE)\n\n\n@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n\n\n@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_top_up(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100\n\n\n@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit\n\n\n@pytest.mark.asyncio(scope=\"session\")\nasync def test_credit_refill(server: SpinTestServer):\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE\n",
    "children": [
        {
            "type": "import_from_statement",
            "label": "from datetime import datetime",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "datetime",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "datetime",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "datetime",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "datetime",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_statement",
            "label": "import pytest",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "pytest",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "pytest",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from prisma.models import CreditTransaction",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "prisma.models",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "prisma",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "models",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "CreditTransaction",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "CreditTransaction",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from backend.blocks.llm import AITextGeneratorBlock",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "backend.blocks.llm",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "backend",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "blocks",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "llm",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "AITextGeneratorBlock",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "AITextGeneratorBlock",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from backend.data.credit import UserCredit",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "backend.data.credit",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "backend",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "data",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "credit",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "UserCredit",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "UserCredit",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from backend.data.user import DEFAULT_USER_ID",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "backend.data.user",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "backend",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "data",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "user",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "DEFAULT_USER_ID",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "DEFAULT_USER_ID",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from backend.integrations.credentials_store import openai_credentials",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "backend.integrations.credentials_store",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "backend",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "integrations",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "credentials_store",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "openai_credentials",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "openai_credentials",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "import_from_statement",
            "label": "from backend.util.test import SpinTestServer",
            "children": [
                {
                    "type": "dotted_name",
                    "label": "backend.util.test",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "backend",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "util",
                            "children": []
                        },
                        {
                            "type": "identifier",
                            "label": "test",
                            "children": []
                        }
                    ]
                },
                {
                    "type": "dotted_name",
                    "label": "SpinTestServer",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "SpinTestServer",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "expression_statement",
            "label": "REFILL_VALUE = 1000",
            "children": [
                {
                    "type": "assignment",
                    "label": "REFILL_VALUE = 1000",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "REFILL_VALUE",
                            "children": []
                        },
                        {
                            "type": "integer",
                            "label": "1000",
                            "children": []
                        }
                    ]
                }
            ]
        },
        {
            "type": "expression_statement",
            "label": "user_credit = UserCredit(REFILL_VALUE)",
            "children": [
                {
                    "type": "assignment",
                    "label": "user_credit = UserCredit(REFILL_VALUE)",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "user_credit",
                            "children": []
                        },
                        {
                            "type": "call",
                            "label": "UserCredit(REFILL_VALUE)",
                            "children": [
                                {
                                    "type": "identifier",
                                    "label": "UserCredit",
                                    "children": []
                                },
                                {
                                    "type": "argument_list",
                                    "label": "(REFILL_VALUE)",
                                    "children": [
                                        {
                                            "type": "identifier",
                                            "label": "REFILL_VALUE",
                                            "children": []
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "type": "decorated_definition",
            "label": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2",
            "children": [
                {
                    "type": "decorator",
                    "label": "@pytest.mark.asyncio(scope=\"session\")",
                    "children": [
                        {
                            "type": "call",
                            "label": "pytest.mark.asyncio(scope=\"session\")",
                            "children": [
                                {
                                    "type": "attribute",
                                    "label": "pytest.mark.asyncio",
                                    "children": [
                                        {
                                            "type": "attribute",
                                            "label": "pytest.mark",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "pytest",
                                                    "children": []
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "mark",
                                                    "children": []
                                                }
                                            ]
                                        },
                                        {
                                            "type": "identifier",
                                            "label": "asyncio",
                                            "children": []
                                        }
                                    ]
                                },
                                {
                                    "type": "argument_list",
                                    "label": "(scope=\"session\")",
                                    "children": [
                                        {
                                            "type": "keyword_argument",
                                            "label": "scope=\"session\"",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "scope",
                                                    "children": []
                                                },
                                                {
                                                    "type": "string",
                                                    "label": "\"session\"",
                                                    "children": [
                                                        {
                                                            "type": "string_start",
                                                            "label": "\"",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_content",
                                                            "label": "session",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_end",
                                                            "label": "\"",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "function_definition",
                    "label": "async def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "test_block_credit_usage",
                            "children": []
                        },
                        {
                            "type": "parameters",
                            "label": "(server: SpinTestServer)",
                            "children": [
                                {
                                    "type": "typed_parameter",
                                    "label": "server: SpinTestServer",
                                    "children": [
                                        {
                                            "type": "identifier",
                                            "label": "server",
                                            "children": []
                                        },
                                        {
                                            "type": "type",
                                            "label": "SpinTestServer",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "SpinTestServer",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "type": "block",
                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2",
                            "children": [
                                {
                                    "type": "expression_statement",
                                    "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "current_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "spending_amount_1",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.spend_credits",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "spend_credits",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "current_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "attribute",
                                                                            "label": "AITextGeneratorBlock().id",
                                                                            "children": [
                                                                                {
                                                                                    "type": "call",
                                                                                    "label": "AITextGeneratorBlock()",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "label": "AITextGeneratorBlock",
                                                                                            "children": []
                                                                                        },
                                                                                        {
                                                                                            "type": "argument_list",
                                                                                            "label": "()",
                                                                                            "children": []
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "id",
                                                                                    "children": []
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "type": "dictionary",
                                                                            "label": "{\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        }",
                                                                            "children": [
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"model\": \"gpt-4-turbo\"",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"model\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "model",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"gpt-4-turbo\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "gpt-4-turbo",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            }",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"credentials\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "credentials",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "dictionary",
                                                                                            "label": "{\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            }",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "label": "\"id\": openai_credentials.id",
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "label": "\"id\"",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "string_start",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_content",
                                                                                                                    "label": "id",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_end",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "attribute",
                                                                                                            "label": "openai_credentials.id",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "openai_credentials",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "id",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "label": "\"provider\": openai_credentials.provider",
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "label": "\"provider\"",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "string_start",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_content",
                                                                                                                    "label": "provider",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_end",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "attribute",
                                                                                                            "label": "openai_credentials.provider",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "openai_credentials",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "provider",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "label": "\"type\": openai_credentials.type",
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "label": "\"type\"",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "string_start",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_content",
                                                                                                                    "label": "type",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_end",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "attribute",
                                                                                                            "label": "openai_credentials.type",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "openai_credentials",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "type",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        }
                                                                                                    ]
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "type": "float",
                                                                            "label": "0.0",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "float",
                                                                            "label": "0.0",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "keyword_argument",
                                                                            "label": "validate_balance=False",
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "validate_balance",
                                                                                    "children": []
                                                                                },
                                                                                {
                                                                                    "type": "false",
                                                                                    "label": "False",
                                                                                    "children": []
                                                                                }
                                                                            ]
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert spending_amount_1 > 0",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "spending_amount_1 > 0",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "spending_amount_1",
                                                    "children": []
                                                },
                                                {
                                                    "type": "integer",
                                                    "label": "0",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "spending_amount_2",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.spend_credits",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "spend_credits",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "current_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "attribute",
                                                                            "label": "AITextGeneratorBlock().id",
                                                                            "children": [
                                                                                {
                                                                                    "type": "call",
                                                                                    "label": "AITextGeneratorBlock()",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "label": "AITextGeneratorBlock",
                                                                                            "children": []
                                                                                        },
                                                                                        {
                                                                                            "type": "argument_list",
                                                                                            "label": "()",
                                                                                            "children": []
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "id",
                                                                                    "children": []
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "type": "dictionary",
                                                                            "label": "{\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"}",
                                                                            "children": [
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"model\": \"gpt-4-turbo\"",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"model\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "model",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"gpt-4-turbo\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "gpt-4-turbo",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"api_key\": \"owned_api_key\"",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"api_key\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "api_key",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"owned_api_key\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "owned_api_key",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "type": "float",
                                                                            "label": "0.0",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "float",
                                                                            "label": "0.0",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "keyword_argument",
                                                                            "label": "validate_balance=False",
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "validate_balance",
                                                                                    "children": []
                                                                                },
                                                                                {
                                                                                    "type": "false",
                                                                                    "label": "False",
                                                                                    "children": []
                                                                                }
                                                                            ]
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert spending_amount_2 == 0",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "spending_amount_2 == 0",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "spending_amount_2",
                                                    "children": []
                                                },
                                                {
                                                    "type": "integer",
                                                    "label": "0",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "new_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert new_credit == current_credit - spending_amount_1 - spending_amount_2",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "new_credit == current_credit - spending_amount_1 - spending_amount_2",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "new_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "binary_operator",
                                                    "label": "current_credit - spending_amount_1 - spending_amount_2",
                                                    "children": [
                                                        {
                                                            "type": "binary_operator",
                                                            "label": "current_credit - spending_amount_1",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "current_credit",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "spending_amount_1",
                                                                    "children": []
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "label": "spending_amount_2",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "type": "decorated_definition",
            "label": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_top_up(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100",
            "children": [
                {
                    "type": "decorator",
                    "label": "@pytest.mark.asyncio(scope=\"session\")",
                    "children": [
                        {
                            "type": "call",
                            "label": "pytest.mark.asyncio(scope=\"session\")",
                            "children": [
                                {
                                    "type": "attribute",
                                    "label": "pytest.mark.asyncio",
                                    "children": [
                                        {
                                            "type": "attribute",
                                            "label": "pytest.mark",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "pytest",
                                                    "children": []
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "mark",
                                                    "children": []
                                                }
                                            ]
                                        },
                                        {
                                            "type": "identifier",
                                            "label": "asyncio",
                                            "children": []
                                        }
                                    ]
                                },
                                {
                                    "type": "argument_list",
                                    "label": "(scope=\"session\")",
                                    "children": [
                                        {
                                            "type": "keyword_argument",
                                            "label": "scope=\"session\"",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "scope",
                                                    "children": []
                                                },
                                                {
                                                    "type": "string",
                                                    "label": "\"session\"",
                                                    "children": [
                                                        {
                                                            "type": "string_start",
                                                            "label": "\"",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_content",
                                                            "label": "session",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_end",
                                                            "label": "\"",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "function_definition",
                    "label": "async def test_block_credit_top_up(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "test_block_credit_top_up",
                            "children": []
                        },
                        {
                            "type": "parameters",
                            "label": "(server: SpinTestServer)",
                            "children": [
                                {
                                    "type": "typed_parameter",
                                    "label": "server: SpinTestServer",
                                    "children": [
                                        {
                                            "type": "identifier",
                                            "label": "server",
                                            "children": []
                                        },
                                        {
                                            "type": "type",
                                            "label": "SpinTestServer",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "SpinTestServer",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "type": "block",
                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100",
                            "children": [
                                {
                                    "type": "expression_statement",
                                    "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "current_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                    "children": [
                                        {
                                            "type": "await",
                                            "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                            "children": [
                                                {
                                                    "type": "call",
                                                    "label": "user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                                    "children": [
                                                        {
                                                            "type": "attribute",
                                                            "label": "user_credit.top_up_credits",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "user_credit",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "top_up_credits",
                                                                    "children": []
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "label": "(DEFAULT_USER_ID, 100)",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "DEFAULT_USER_ID",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "100",
                                                                    "children": []
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "new_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert new_credit == current_credit + 100",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "new_credit == current_credit + 100",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "new_credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "binary_operator",
                                                    "label": "current_credit + 100",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "current_credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "integer",
                                                            "label": "100",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "type": "decorated_definition",
            "label": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit",
            "children": [
                {
                    "type": "decorator",
                    "label": "@pytest.mark.asyncio(scope=\"session\")",
                    "children": [
                        {
                            "type": "call",
                            "label": "pytest.mark.asyncio(scope=\"session\")",
                            "children": [
                                {
                                    "type": "attribute",
                                    "label": "pytest.mark.asyncio",
                                    "children": [
                                        {
                                            "type": "attribute",
                                            "label": "pytest.mark",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "pytest",
                                                    "children": []
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "mark",
                                                    "children": []
                                                }
                                            ]
                                        },
                                        {
                                            "type": "identifier",
                                            "label": "asyncio",
                                            "children": []
                                        }
                                    ]
                                },
                                {
                                    "type": "argument_list",
                                    "label": "(scope=\"session\")",
                                    "children": [
                                        {
                                            "type": "keyword_argument",
                                            "label": "scope=\"session\"",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "scope",
                                                    "children": []
                                                },
                                                {
                                                    "type": "string",
                                                    "label": "\"session\"",
                                                    "children": [
                                                        {
                                                            "type": "string_start",
                                                            "label": "\"",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_content",
                                                            "label": "session",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_end",
                                                            "label": "\"",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "function_definition",
                    "label": "async def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "test_block_credit_reset",
                            "children": []
                        },
                        {
                            "type": "parameters",
                            "label": "(server: SpinTestServer)",
                            "children": [
                                {
                                    "type": "typed_parameter",
                                    "label": "server: SpinTestServer",
                                    "children": [
                                        {
                                            "type": "identifier",
                                            "label": "server",
                                            "children": []
                                        },
                                        {
                                            "type": "type",
                                            "label": "SpinTestServer",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "SpinTestServer",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "type": "block",
                            "label": "month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit",
                            "children": [
                                {
                                    "type": "expression_statement",
                                    "label": "month1 = datetime(2022, 1, 15)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "month1 = datetime(2022, 1, 15)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "month1",
                                                    "children": []
                                                },
                                                {
                                                    "type": "call",
                                                    "label": "datetime(2022, 1, 15)",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "datetime",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "label": "(2022, 1, 15)",
                                                            "children": [
                                                                {
                                                                    "type": "integer",
                                                                    "label": "2022",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "1",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "15",
                                                                    "children": []
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "month2 = datetime(2022, 2, 15)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "month2 = datetime(2022, 2, 15)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "month2",
                                                    "children": []
                                                },
                                                {
                                                    "type": "call",
                                                    "label": "datetime(2022, 2, 15)",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "datetime",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "label": "(2022, 2, 15)",
                                                            "children": [
                                                                {
                                                                    "type": "integer",
                                                                    "label": "2022",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "2",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "15",
                                                                    "children": []
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "user_credit.time_now = lambda: month2",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "user_credit.time_now = lambda: month2",
                                            "children": [
                                                {
                                                    "type": "attribute",
                                                    "label": "user_credit.time_now",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "user_credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "label": "time_now",
                                                            "children": []
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "lambda",
                                                    "label": "lambda: month2",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "month2",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "month2credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "comment",
                                    "label": "# Month 1 result should only affect month 1",
                                    "children": []
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "user_credit.time_now = lambda: month1",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "user_credit.time_now = lambda: month1",
                                            "children": [
                                                {
                                                    "type": "attribute",
                                                    "label": "user_credit.time_now",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "user_credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "label": "time_now",
                                                            "children": []
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "lambda",
                                                    "label": "lambda: month1",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "month1",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "month1credit",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                    "children": [
                                        {
                                            "type": "await",
                                            "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                            "children": [
                                                {
                                                    "type": "call",
                                                    "label": "user_credit.top_up_credits(DEFAULT_USER_ID, 100)",
                                                    "children": [
                                                        {
                                                            "type": "attribute",
                                                            "label": "user_credit.top_up_credits",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "user_credit",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "top_up_credits",
                                                                    "children": []
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "label": "(DEFAULT_USER_ID, 100)",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "DEFAULT_USER_ID",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "label": "100",
                                                                    "children": []
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100",
                                            "children": [
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "binary_operator",
                                                    "label": "month1credit + 100",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "month1credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "integer",
                                                            "label": "100",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "comment",
                                    "label": "# Month 2 balance is unaffected",
                                    "children": []
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "user_credit.time_now = lambda: month2",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "user_credit.time_now = lambda: month2",
                                            "children": [
                                                {
                                                    "type": "attribute",
                                                    "label": "user_credit.time_now",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "user_credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "label": "time_now",
                                                            "children": []
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "lambda",
                                                    "label": "lambda: month2",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "month2",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit",
                                            "children": [
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "month2credit",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "type": "decorated_definition",
            "label": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_credit_refill(server: SpinTestServer):\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE",
            "children": [
                {
                    "type": "decorator",
                    "label": "@pytest.mark.asyncio(scope=\"session\")",
                    "children": [
                        {
                            "type": "call",
                            "label": "pytest.mark.asyncio(scope=\"session\")",
                            "children": [
                                {
                                    "type": "attribute",
                                    "label": "pytest.mark.asyncio",
                                    "children": [
                                        {
                                            "type": "attribute",
                                            "label": "pytest.mark",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "pytest",
                                                    "children": []
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "mark",
                                                    "children": []
                                                }
                                            ]
                                        },
                                        {
                                            "type": "identifier",
                                            "label": "asyncio",
                                            "children": []
                                        }
                                    ]
                                },
                                {
                                    "type": "argument_list",
                                    "label": "(scope=\"session\")",
                                    "children": [
                                        {
                                            "type": "keyword_argument",
                                            "label": "scope=\"session\"",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "scope",
                                                    "children": []
                                                },
                                                {
                                                    "type": "string",
                                                    "label": "\"session\"",
                                                    "children": [
                                                        {
                                                            "type": "string_start",
                                                            "label": "\"",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_content",
                                                            "label": "session",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "string_end",
                                                            "label": "\"",
                                                            "children": []
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "function_definition",
                    "label": "async def test_credit_refill(server: SpinTestServer):\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE",
                    "children": [
                        {
                            "type": "identifier",
                            "label": "test_credit_refill",
                            "children": []
                        },
                        {
                            "type": "parameters",
                            "label": "(server: SpinTestServer)",
                            "children": [
                                {
                                    "type": "typed_parameter",
                                    "label": "server: SpinTestServer",
                                    "children": [
                                        {
                                            "type": "identifier",
                                            "label": "server",
                                            "children": []
                                        },
                                        {
                                            "type": "type",
                                            "label": "SpinTestServer",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "SpinTestServer",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "type": "comment",
                            "label": "# Clear all transactions within the month",
                            "children": []
                        },
                        {
                            "type": "block",
                            "label": "await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE",
                            "children": [
                                {
                                    "type": "expression_statement",
                                    "label": "await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )",
                                    "children": [
                                        {
                                            "type": "await",
                                            "label": "await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )",
                                            "children": [
                                                {
                                                    "type": "call",
                                                    "label": "CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )",
                                                    "children": [
                                                        {
                                                            "type": "attribute",
                                                            "label": "CreditTransaction.prisma().update_many",
                                                            "children": [
                                                                {
                                                                    "type": "call",
                                                                    "label": "CreditTransaction.prisma()",
                                                                    "children": [
                                                                        {
                                                                            "type": "attribute",
                                                                            "label": "CreditTransaction.prisma",
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "CreditTransaction",
                                                                                    "children": []
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "label": "prisma",
                                                                                    "children": []
                                                                                }
                                                                            ]
                                                                        },
                                                                        {
                                                                            "type": "argument_list",
                                                                            "label": "()",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "update_many",
                                                                    "children": []
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "label": "(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )",
                                                            "children": [
                                                                {
                                                                    "type": "keyword_argument",
                                                                    "label": "where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        }",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "where",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "dictionary",
                                                                            "label": "{\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        }",
                                                                            "children": [
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"userId\": DEFAULT_USER_ID",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"userId\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "userId",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "label": "DEFAULT_USER_ID",
                                                                                            "children": []
                                                                                        }
                                                                                    ]
                                                                                },
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            }",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"createdAt\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "createdAt",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "dictionary",
                                                                                            "label": "{\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            }",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "label": "\"gte\": datetime(2022, 2, 1)",
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "label": "\"gte\"",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "string_start",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_content",
                                                                                                                    "label": "gte",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_end",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "call",
                                                                                                            "label": "datetime(2022, 2, 1)",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "datetime",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "argument_list",
                                                                                                                    "label": "(2022, 2, 1)",
                                                                                                                    "children": [
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "2022",
                                                                                                                            "children": []
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "2",
                                                                                                                            "children": []
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "1",
                                                                                                                            "children": []
                                                                                                                        }
                                                                                                                    ]
                                                                                                                }
                                                                                                            ]
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "label": "\"lt\": datetime(2022, 3, 1)",
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "label": "\"lt\"",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "string_start",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_content",
                                                                                                                    "label": "lt",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "string_end",
                                                                                                                    "label": "\"",
                                                                                                                    "children": []
                                                                                                                }
                                                                                                            ]
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "call",
                                                                                                            "label": "datetime(2022, 3, 1)",
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "identifier",
                                                                                                                    "label": "datetime",
                                                                                                                    "children": []
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "argument_list",
                                                                                                                    "label": "(2022, 3, 1)",
                                                                                                                    "children": [
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "2022",
                                                                                                                            "children": []
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "3",
                                                                                                                            "children": []
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "integer",
                                                                                                                            "label": "1",
                                                                                                                            "children": []
                                                                                                                        }
                                                                                                                    ]
                                                                                                                }
                                                                                                            ]
                                                                                                        }
                                                                                                    ]
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "keyword_argument",
                                                                    "label": "data={\"isActive\": False}",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "data",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "dictionary",
                                                                            "label": "{\"isActive\": False}",
                                                                            "children": [
                                                                                {
                                                                                    "type": "pair",
                                                                                    "label": "\"isActive\": False",
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "string",
                                                                                            "label": "\"isActive\"",
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string_start",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_content",
                                                                                                    "label": "isActive",
                                                                                                    "children": []
                                                                                                },
                                                                                                {
                                                                                                    "type": "string_end",
                                                                                                    "label": "\"",
                                                                                                    "children": []
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        {
                                                                                            "type": "false",
                                                                                            "label": "False",
                                                                                            "children": []
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "user_credit.time_now = lambda: datetime(2022, 2, 15)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "user_credit.time_now = lambda: datetime(2022, 2, 15)",
                                            "children": [
                                                {
                                                    "type": "attribute",
                                                    "label": "user_credit.time_now",
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "label": "user_credit",
                                                            "children": []
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "label": "time_now",
                                                            "children": []
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "lambda",
                                                    "label": "lambda: datetime(2022, 2, 15)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "datetime(2022, 2, 15)",
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "label": "datetime",
                                                                    "children": []
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(2022, 2, 15)",
                                                                    "children": [
                                                                        {
                                                                            "type": "integer",
                                                                            "label": "2022",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "label": "2",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "label": "15",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "expression_statement",
                                    "label": "balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "label": "balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "balance",
                                                    "children": []
                                                },
                                                {
                                                    "type": "await",
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)",
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "label": "user_credit.get_or_refill_credit",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "user_credit",
                                                                            "children": []
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "get_or_refill_credit",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "label": "(DEFAULT_USER_ID)",
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "label": "DEFAULT_USER_ID",
                                                                            "children": []
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "type": "assert_statement",
                                    "label": "assert balance == REFILL_VALUE",
                                    "children": [
                                        {
                                            "type": "comparison_operator",
                                            "label": "balance == REFILL_VALUE",
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "label": "balance",
                                                    "children": []
                                                },
                                                {
                                                    "type": "identifier",
                                                    "label": "REFILL_VALUE",
                                                    "children": []
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}