{
    "type": "module",
    "start_token": 0,
    "end_token": 129,
    "children": [
        {
            "type": "import_from_statement",
            "start_token": 0,
            "end_token": 3,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 0,
                    "end_token": 1,
                    "children": [],
                    "label": "from datetime"
                },
                {
                    "type": "identifier",
                    "start_token": 3,
                    "end_token": 3,
                    "children": [],
                    "label": "datetime"
                }
            ],
            "label": "from datetime import datetime"
        },
        {
            "type": "import_statement",
            "start_token": 6,
            "end_token": 7,
            "children": [
                {
                    "type": "identifier",
                    "start_token": 7,
                    "end_token": 7,
                    "children": [],
                    "label": "pytest"
                }
            ],
            "label": "import pytest"
        },
        {
            "type": "import_from_statement",
            "start_token": 9,
            "end_token": 14,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 9,
                    "end_token": 12,
                    "children": [],
                    "label": "from prisma.models"
                },
                {
                    "type": "identifier",
                    "start_token": 14,
                    "end_token": 14,
                    "children": [],
                    "label": "CreditTransaction"
                }
            ],
            "label": "from prisma.models import CreditTransaction"
        },
        {
            "type": "import_from_statement",
            "start_token": 17,
            "end_token": 24,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 17,
                    "end_token": 22,
                    "children": [],
                    "label": "from backend.blocks.llm"
                },
                {
                    "type": "identifier",
                    "start_token": 24,
                    "end_token": 24,
                    "children": [],
                    "label": "AITextGeneratorBlock"
                }
            ],
            "label": "from backend.blocks.llm import AITextGeneratorBlock"
        },
        {
            "type": "import_from_statement",
            "start_token": 26,
            "end_token": 33,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 26,
                    "end_token": 31,
                    "children": [],
                    "label": "from backend.data.credit"
                },
                {
                    "type": "identifier",
                    "start_token": 33,
                    "end_token": 33,
                    "children": [],
                    "label": "UserCredit"
                }
            ],
            "label": "from backend.data.credit import UserCredit"
        },
        {
            "type": "import_from_statement",
            "start_token": 35,
            "end_token": 42,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 35,
                    "end_token": 40,
                    "children": [],
                    "label": "from backend.data.user"
                },
                {
                    "type": "identifier",
                    "start_token": 42,
                    "end_token": 42,
                    "children": [],
                    "label": "DEFAULT_USER_ID"
                }
            ],
            "label": "from backend.data.user import DEFAULT_USER_ID"
        },
        {
            "type": "import_from_statement",
            "start_token": 44,
            "end_token": 51,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 44,
                    "end_token": 49,
                    "children": [],
                    "label": "from backend.integrations.credentials_store"
                },
                {
                    "type": "identifier",
                    "start_token": 51,
                    "end_token": 51,
                    "children": [],
                    "label": "openai_credentials"
                }
            ],
            "label": "from backend.integrations.credentials_store import openai_credentials"
        },
        {
            "type": "import_from_statement",
            "start_token": 53,
            "end_token": 60,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 53,
                    "end_token": 58,
                    "children": [],
                    "label": "from backend.util.test"
                },
                {
                    "type": "identifier",
                    "start_token": 60,
                    "end_token": 60,
                    "children": [],
                    "label": "SpinTestServer"
                }
            ],
            "label": "from backend.util.test import SpinTestServer"
        },
        {
            "type": "assignment",
            "start_token": 63,
            "end_token": 65,
            "children": [
                {
                    "type": "identifier",
                    "start_token": 63,
                    "end_token": 63,
                    "children": [],
                    "label": "REFILL_VALUE"
                },
                {
                    "type": "integer",
                    "start_token": 65,
                    "end_token": 65,
                    "children": [],
                    "label": "1000"
                }
            ],
            "label": "REFILL_VALUE = 1000"
        },
        {
            "type": "assignment",
            "start_token": 67,
            "end_token": 72,
            "children": [
                {
                    "type": "identifier",
                    "start_token": 67,
                    "end_token": 67,
                    "children": [],
                    "label": "user_credit"
                },
                {
                    "type": "call",
                    "start_token": 69,
                    "end_token": 72,
                    "children": [
                        {
                            "type": "identifier",
                            "start_token": 69,
                            "end_token": 69,
                            "children": [],
                            "label": "UserCredit"
                        },
                        {
                            "type": "argument_list",
                            "start_token": 70,
                            "end_token": 72,
                            "children": [
                                {
                                    "type": "identifier",
                                    "start_token": 71,
                                    "end_token": 71,
                                    "children": [],
                                    "label": "REFILL_VALUE"
                                }
                            ],
                            "label": "(REFILL_VALUE)"
                        }
                    ],
                    "label": "UserCredit(REFILL_VALUE)"
                }
            ],
            "label": "user_credit = UserCredit(REFILL_VALUE)"
        },
        {
            "type": "decorator",
            "start_token": 76,
            "end_token": 86,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 77,
                    "end_token": 81,
                    "children": [],
                    "label": "pytest.mark.asyncio"
                },
                {
                    "type": "argument_list",
                    "start_token": 82,
                    "end_token": 86,
                    "children": [
                        {
                            "type": "pair",
                            "start_token": 83,
                            "end_token": 85,
                            "children": [
                                {
                                    "type": "string",
                                    "start_token": 85,
                                    "end_token": 85,
                                    "children": [],
                                    "label": "\"session\""
                                }
                            ],
                            "label": "scope=\"session\""
                        }
                    ],
                    "label": "(scope=\"session\")"
                }
            ],
            "label": "@pytest.mark.asyncio(scope=\"session\")"
        },
        {
            "type": "decorator",
            "start_token": 90,
            "end_token": 100,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 91,
                    "end_token": 95,
                    "children": [],
                    "label": "pytest.mark.asyncio"
                },
                {
                    "type": "argument_list",
                    "start_token": 96,
                    "end_token": 100,
                    "children": [
                        {
                            "type": "pair",
                            "start_token": 97,
                            "end_token": 99,
                            "children": [
                                {
                                    "type": "string",
                                    "start_token": 99,
                                    "end_token": 99,
                                    "children": [],
                                    "label": "\"session\""
                                }
                            ],
                            "label": "scope=\"session\""
                        }
                    ],
                    "label": "(scope=\"session\")"
                }
            ],
            "label": "@pytest.mark.asyncio(scope=\"session\")"
        },
        {
            "type": "decorator",
            "start_token": 104,
            "end_token": 114,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 105,
                    "end_token": 109,
                    "children": [],
                    "label": "pytest.mark.asyncio"
                },
                {
                    "type": "argument_list",
                    "start_token": 110,
                    "end_token": 114,
                    "children": [
                        {
                            "type": "pair",
                            "start_token": 111,
                            "end_token": 113,
                            "children": [
                                {
                                    "type": "string",
                                    "start_token": 113,
                                    "end_token": 113,
                                    "children": [],
                                    "label": "\"session\""
                                }
                            ],
                            "label": "scope=\"session\""
                        }
                    ],
                    "label": "(scope=\"session\")"
                }
            ],
            "label": "@pytest.mark.asyncio(scope=\"session\")"
        },
        {
            "type": "decorator",
            "start_token": 118,
            "end_token": 128,
            "children": [
                {
                    "type": "dotted_name",
                    "start_token": 119,
                    "end_token": 123,
                    "children": [],
                    "label": "pytest.mark.asyncio"
                },
                {
                    "type": "argument_list",
                    "start_token": 124,
                    "end_token": 128,
                    "children": [
                        {
                            "type": "pair",
                            "start_token": 125,
                            "end_token": 127,
                            "children": [
                                {
                                    "type": "string",
                                    "start_token": 127,
                                    "end_token": 127,
                                    "children": [],
                                    "label": "\"session\""
                                }
                            ],
                            "label": "scope=\"session\""
                        }
                    ],
                    "label": "(scope=\"session\")"
                }
            ],
            "label": "@pytest.mark.asyncio(scope=\"session\")"
        },
        {
            "type": "function_placeholder",
            "name": "test_block_credit_usage",
            "start_line": 17,
            "end_line": 50,
            "children": [
                {
                    "type": "module",
                    "start_token": 0,
                    "end_token": 178,
                    "children": [
                        {
                            "type": "decorated_definition",
                            "start_token": 0,
                            "end_token": 178,
                            "children": [
                                {
                                    "type": "await",
                                    "start_token": 0,
                                    "end_token": 178,
                                    "children": [
                                        {
                                            "type": "function_definition",
                                            "start_token": 0,
                                            "end_token": 178,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 1,
                                                    "end_token": 1,
                                                    "children": [],
                                                    "label": "def"
                                                },
                                                {
                                                    "type": "identifier",
                                                    "start_token": 2,
                                                    "end_token": 2,
                                                    "children": [],
                                                    "label": "test_block_credit_usage"
                                                },
                                                {
                                                    "type": "parameters",
                                                    "start_token": 3,
                                                    "end_token": 7,
                                                    "children": [
                                                        {
                                                            "type": "typed_parameter",
                                                            "start_token": 4,
                                                            "end_token": 6,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 4,
                                                                    "end_token": 4,
                                                                    "children": [],
                                                                    "label": "server"
                                                                },
                                                                {
                                                                    "type": "type",
                                                                    "start_token": 6,
                                                                    "end_token": 6,
                                                                    "children": [],
                                                                    "label": "SpinTestServer"
                                                                }
                                                            ],
                                                            "label": "server: SpinTestServer"
                                                        }
                                                    ],
                                                    "label": "(server: SpinTestServer)"
                                                },
                                                {
                                                    "type": "block",
                                                    "start_token": 9,
                                                    "end_token": 178,
                                                    "children": [
                                                        {
                                                            "type": "assignment",
                                                            "start_token": 10,
                                                            "end_token": 18,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 10,
                                                                    "end_token": 10,
                                                                    "children": [],
                                                                    "label": "current_credit"
                                                                },
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 12,
                                                                    "end_token": 18,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 13,
                                                                            "end_token": 18,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 13,
                                                                                    "end_token": 15,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 13,
                                                                                            "end_token": 13,
                                                                                            "children": [],
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 15,
                                                                                            "end_token": 15,
                                                                                            "children": [],
                                                                                            "label": "get_or_refill_credit"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.get_or_refill_credit"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 16,
                                                                                    "end_token": 18,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 17,
                                                                                            "end_token": 17,
                                                                                            "children": [],
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(DEFAULT_USER_ID)"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        },
                                                        {
                                                            "type": "assignment",
                                                            "start_token": 21,
                                                            "end_token": 95,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 21,
                                                                    "end_token": 21,
                                                                    "children": [],
                                                                    "label": "spending_amount_1"
                                                                },
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 23,
                                                                    "end_token": 95,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 24,
                                                                            "end_token": 95,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 24,
                                                                                    "end_token": 26,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 24,
                                                                                            "end_token": 24,
                                                                                            "children": [],
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 26,
                                                                                            "end_token": 26,
                                                                                            "children": [],
                                                                                            "label": "spend_credits"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.spend_credits"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 27,
                                                                                    "end_token": 95,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 29,
                                                                                            "end_token": 29,
                                                                                            "children": [],
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 32,
                                                                                            "end_token": 32,
                                                                                            "children": [],
                                                                                            "label": "current_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "attribute",
                                                                                            "start_token": 35,
                                                                                            "end_token": 39,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 35,
                                                                                                    "end_token": 35,
                                                                                                    "children": [],
                                                                                                    "label": "AITextGeneratorBlock"
                                                                                                },
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 39,
                                                                                                    "end_token": 39,
                                                                                                    "children": [],
                                                                                                    "label": "id"
                                                                                                }
                                                                                            ],
                                                                                            "label": "AITextGeneratorBlock().id"
                                                                                        },
                                                                                        {
                                                                                            "type": "dictionary",
                                                                                            "start_token": 42,
                                                                                            "end_token": 77,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "start_token": 44,
                                                                                                    "end_token": 46,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 44,
                                                                                                            "end_token": 44,
                                                                                                            "children": [],
                                                                                                            "label": "\"model\""
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 46,
                                                                                                            "end_token": 46,
                                                                                                            "children": [],
                                                                                                            "label": "\"gpt-4-turbo\""
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "\"model\": \"gpt-4-turbo\""
                                                                                                },
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "start_token": 49,
                                                                                                    "end_token": 74,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 49,
                                                                                                            "end_token": 49,
                                                                                                            "children": [],
                                                                                                            "label": "\"credentials\""
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "dictionary",
                                                                                                            "start_token": 51,
                                                                                                            "end_token": 74,
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "pair",
                                                                                                                    "start_token": 53,
                                                                                                                    "end_token": 55,
                                                                                                                    "children": [
                                                                                                                        {
                                                                                                                            "type": "string",
                                                                                                                            "start_token": 53,
                                                                                                                            "end_token": 53,
                                                                                                                            "children": [],
                                                                                                                            "label": "\"id\""
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "attribute",
                                                                                                                            "start_token": 55,
                                                                                                                            "end_token": 57,
                                                                                                                            "children": [
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 55,
                                                                                                                                    "end_token": 55,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "openai_credentials"
                                                                                                                                },
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 57,
                                                                                                                                    "end_token": 57,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "id"
                                                                                                                                }
                                                                                                                            ],
                                                                                                                            "label": "openai_credentials.id"
                                                                                                                        }
                                                                                                                    ],
                                                                                                                    "label": "\"id\": openai_credentials"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "pair",
                                                                                                                    "start_token": 60,
                                                                                                                    "end_token": 62,
                                                                                                                    "children": [
                                                                                                                        {
                                                                                                                            "type": "string",
                                                                                                                            "start_token": 60,
                                                                                                                            "end_token": 60,
                                                                                                                            "children": [],
                                                                                                                            "label": "\"provider\""
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "attribute",
                                                                                                                            "start_token": 62,
                                                                                                                            "end_token": 64,
                                                                                                                            "children": [
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 62,
                                                                                                                                    "end_token": 62,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "openai_credentials"
                                                                                                                                },
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 64,
                                                                                                                                    "end_token": 64,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "provider"
                                                                                                                                }
                                                                                                                            ],
                                                                                                                            "label": "openai_credentials.provider"
                                                                                                                        }
                                                                                                                    ],
                                                                                                                    "label": "\"provider\": openai_credentials"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "pair",
                                                                                                                    "start_token": 67,
                                                                                                                    "end_token": 69,
                                                                                                                    "children": [
                                                                                                                        {
                                                                                                                            "type": "string",
                                                                                                                            "start_token": 67,
                                                                                                                            "end_token": 67,
                                                                                                                            "children": [],
                                                                                                                            "label": "\"type\""
                                                                                                                        },
                                                                                                                        {
                                                                                                                            "type": "attribute",
                                                                                                                            "start_token": 69,
                                                                                                                            "end_token": 71,
                                                                                                                            "children": [
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 69,
                                                                                                                                    "end_token": 69,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "openai_credentials"
                                                                                                                                },
                                                                                                                                {
                                                                                                                                    "type": "identifier",
                                                                                                                                    "start_token": 71,
                                                                                                                                    "end_token": 71,
                                                                                                                                    "children": [],
                                                                                                                                    "label": "type"
                                                                                                                                }
                                                                                                                            ],
                                                                                                                            "label": "openai_credentials.type"
                                                                                                                        }
                                                                                                                    ],
                                                                                                                    "label": "\"type\": openai_credentials"
                                                                                                                }
                                                                                                            ],
                                                                                                            "label": "{\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            }"
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "\"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            }"
                                                                                                }
                                                                                            ],
                                                                                            "label": "{\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        }"
                                                                                        },
                                                                                        {
                                                                                            "type": "float",
                                                                                            "start_token": 80,
                                                                                            "end_token": 82,
                                                                                            "children": [],
                                                                                            "label": "0.0"
                                                                                        },
                                                                                        {
                                                                                            "type": "float",
                                                                                            "start_token": 85,
                                                                                            "end_token": 87,
                                                                                            "children": [],
                                                                                            "label": "0.0"
                                                                                        },
                                                                                        {
                                                                                            "type": "assignment",
                                                                                            "start_token": 90,
                                                                                            "end_token": 92,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 90,
                                                                                                    "end_token": 90,
                                                                                                    "children": [],
                                                                                                    "label": "validate_balance"
                                                                                                },
                                                                                                {
                                                                                                    "type": "false",
                                                                                                    "start_token": 92,
                                                                                                    "end_token": 92,
                                                                                                    "children": [],
                                                                                                    "label": "False"
                                                                                                }
                                                                                            ],
                                                                                            "label": "validate_balance=False"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                }
                                                            ],
                                                            "label": "spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                        },
                                                        {
                                                            "type": "assert_statement",
                                                            "start_token": 97,
                                                            "end_token": 101,
                                                            "children": [
                                                                {
                                                                    "type": "comparison_operator",
                                                                    "start_token": 98,
                                                                    "end_token": 100,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 98,
                                                                            "end_token": 98,
                                                                            "children": [],
                                                                            "label": "spending_amount_1"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 100,
                                                                            "end_token": 100,
                                                                            "children": [],
                                                                            "label": "0"
                                                                        }
                                                                    ],
                                                                    "label": "spending_amount_1 > 0"
                                                                }
                                                            ],
                                                            "label": "assert spending_amount_1 > 0\n"
                                                        },
                                                        {
                                                            "type": "assignment",
                                                            "start_token": 103,
                                                            "end_token": 150,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 103,
                                                                    "end_token": 103,
                                                                    "children": [],
                                                                    "label": "spending_amount_2"
                                                                },
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 105,
                                                                    "end_token": 150,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 106,
                                                                            "end_token": 150,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 106,
                                                                                    "end_token": 108,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 106,
                                                                                            "end_token": 106,
                                                                                            "children": [],
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 108,
                                                                                            "end_token": 108,
                                                                                            "children": [],
                                                                                            "label": "spend_credits"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.spend_credits"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 109,
                                                                                    "end_token": 150,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 111,
                                                                                            "end_token": 111,
                                                                                            "children": [],
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 114,
                                                                                            "end_token": 114,
                                                                                            "children": [],
                                                                                            "label": "current_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "attribute",
                                                                                            "start_token": 117,
                                                                                            "end_token": 121,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 117,
                                                                                                    "end_token": 117,
                                                                                                    "children": [],
                                                                                                    "label": "AITextGeneratorBlock"
                                                                                                },
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 121,
                                                                                                    "end_token": 121,
                                                                                                    "children": [],
                                                                                                    "label": "id"
                                                                                                }
                                                                                            ],
                                                                                            "label": "AITextGeneratorBlock().id"
                                                                                        },
                                                                                        {
                                                                                            "type": "dictionary",
                                                                                            "start_token": 124,
                                                                                            "end_token": 132,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "start_token": 125,
                                                                                                    "end_token": 127,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 125,
                                                                                                            "end_token": 125,
                                                                                                            "children": [],
                                                                                                            "label": "\"model\""
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 127,
                                                                                                            "end_token": 127,
                                                                                                            "children": [],
                                                                                                            "label": "\"gpt-4-turbo\""
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "\"model\": \"gpt-4-turbo\""
                                                                                                },
                                                                                                {
                                                                                                    "type": "pair",
                                                                                                    "start_token": 129,
                                                                                                    "end_token": 131,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 129,
                                                                                                            "end_token": 129,
                                                                                                            "children": [],
                                                                                                            "label": "\"api_key\""
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "string",
                                                                                                            "start_token": 131,
                                                                                                            "end_token": 131,
                                                                                                            "children": [],
                                                                                                            "label": "\"owned_api_key\""
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "\"api_key\": \"owned_api_key\""
                                                                                                }
                                                                                            ],
                                                                                            "label": "{\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"}"
                                                                                        },
                                                                                        {
                                                                                            "type": "float",
                                                                                            "start_token": 135,
                                                                                            "end_token": 137,
                                                                                            "children": [],
                                                                                            "label": "0.0"
                                                                                        },
                                                                                        {
                                                                                            "type": "float",
                                                                                            "start_token": 140,
                                                                                            "end_token": 142,
                                                                                            "children": [],
                                                                                            "label": "0.0"
                                                                                        },
                                                                                        {
                                                                                            "type": "assignment",
                                                                                            "start_token": 145,
                                                                                            "end_token": 147,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "identifier",
                                                                                                    "start_token": 145,
                                                                                                    "end_token": 145,
                                                                                                    "children": [],
                                                                                                    "label": "validate_balance"
                                                                                                },
                                                                                                {
                                                                                                    "type": "false",
                                                                                                    "start_token": 147,
                                                                                                    "end_token": 147,
                                                                                                    "children": [],
                                                                                                    "label": "False"
                                                                                                }
                                                                                            ],
                                                                                            "label": "validate_balance=False"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                                }
                                                            ],
                                                            "label": "spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )"
                                                        },
                                                        {
                                                            "type": "assert_statement",
                                                            "start_token": 152,
                                                            "end_token": 157,
                                                            "children": [
                                                                {
                                                                    "type": "comparison_operator",
                                                                    "start_token": 153,
                                                                    "end_token": 156,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 153,
                                                                            "end_token": 153,
                                                                            "children": [],
                                                                            "label": "spending_amount_2"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 156,
                                                                            "end_token": 156,
                                                                            "children": [],
                                                                            "label": "0"
                                                                        }
                                                                    ],
                                                                    "label": "spending_amount_2 == 0"
                                                                }
                                                            ],
                                                            "label": "assert spending_amount_2 == 0\n"
                                                        },
                                                        {
                                                            "type": "assignment",
                                                            "start_token": 159,
                                                            "end_token": 168,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 159,
                                                                    "end_token": 159,
                                                                    "children": [],
                                                                    "label": "new_credit"
                                                                },
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 161,
                                                                    "end_token": 168,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 162,
                                                                            "end_token": 168,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 162,
                                                                                    "end_token": 164,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 162,
                                                                                            "end_token": 162,
                                                                                            "children": [],
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 164,
                                                                                            "end_token": 164,
                                                                                            "children": [],
                                                                                            "label": "get_or_refill_credit"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.get_or_refill_credit"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 165,
                                                                                    "end_token": 167,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 166,
                                                                                            "end_token": 166,
                                                                                            "children": [],
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(DEFAULT_USER_ID)"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
                                                                }
                                                            ],
                                                            "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
                                                        },
                                                        {
                                                            "type": "assert_statement",
                                                            "start_token": 169,
                                                            "end_token": 178,
                                                            "children": [
                                                                {
                                                                    "type": "comparison_operator",
                                                                    "start_token": 170,
                                                                    "end_token": 178,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 170,
                                                                            "end_token": 170,
                                                                            "children": [],
                                                                            "label": "new_credit"
                                                                        },
                                                                        {
                                                                            "type": "binary_operator",
                                                                            "start_token": 173,
                                                                            "end_token": 177,
                                                                            "children": [
                                                                                {
                                                                                    "type": "binary_operator",
                                                                                    "start_token": 173,
                                                                                    "end_token": 175,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 173,
                                                                                            "end_token": 173,
                                                                                            "children": [],
                                                                                            "label": "current_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 175,
                                                                                            "end_token": 175,
                                                                                            "children": [],
                                                                                            "label": "spending_amount_1"
                                                                                        }
                                                                                    ],
                                                                                    "label": "current_credit - spending_amount_1"
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 177,
                                                                                    "end_token": 177,
                                                                                    "children": [],
                                                                                    "label": "spending_amount_2"
                                                                                }
                                                                            ],
                                                                            "label": "current_credit - spending_amount_1 - spending_amount_2"
                                                                        }
                                                                    ],
                                                                    "label": "new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                                                                }
                                                            ],
                                                            "label": "assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                                                        }
                                                    ],
                                                    "label": "\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                                                }
                                            ],
                                            "label": "async def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                                        }
                                    ],
                                    "label": "async def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                                }
                            ],
                            "label": "async def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                        }
                    ],
                    "label": "async def test_block_credit_usage(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_1 > 0\n\n    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n    assert spending_amount_2 == 0\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
                }
            ]
        },
        {
            "type": "function_placeholder",
            "name": "test_block_credit_top_up",
            "start_line": 54,
            "end_line": 60,
            "children": [
                {
                    "type": "module",
                    "start_token": 0,
                    "end_token": 49,
                    "children": [
                        {
                            "type": "function_definition",
                            "start_token": 0,
                            "end_token": 49,
                            "children": [
                                {
                                    "type": "identifier",
                                    "start_token": 0,
                                    "end_token": 0,
                                    "children": [],
                                    "label": "async"
                                },
                                {
                                    "type": "identifier",
                                    "start_token": 1,
                                    "end_token": 1,
                                    "children": [],
                                    "label": "def"
                                },
                                {
                                    "type": "parameters",
                                    "start_token": 3,
                                    "end_token": 7,
                                    "children": [
                                        {
                                            "type": "parameter",
                                            "start_token": 4,
                                            "end_token": 6,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 4,
                                                    "end_token": 4,
                                                    "children": [],
                                                    "label": "server"
                                                },
                                                {
                                                    "type": "type",
                                                    "start_token": 6,
                                                    "end_token": 6,
                                                    "children": [],
                                                    "label": "SpinTestServer"
                                                }
                                            ],
                                            "label": "server: SpinTestServer"
                                        }
                                    ],
                                    "label": "(server: SpinTestServer)"
                                },
                                {
                                    "type": "block",
                                    "start_token": 9,
                                    "end_token": 49,
                                    "children": [
                                        {
                                            "type": "assignment",
                                            "start_token": 10,
                                            "end_token": 18,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 10,
                                                    "end_token": 10,
                                                    "children": [],
                                                    "label": "current_credit"
                                                },
                                                {
                                                    "type": "await",
                                                    "start_token": 12,
                                                    "end_token": 18,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 13,
                                                            "end_token": 18,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 13,
                                                                    "end_token": 15,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 13,
                                                                            "end_token": 13,
                                                                            "children": [],
                                                                            "label": "user_credit"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 15,
                                                                            "end_token": 15,
                                                                            "children": [],
                                                                            "label": "get_or_refill_credit"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.get_or_refill_credit"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 16,
                                                                    "end_token": 18,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 17,
                                                                            "end_token": 17,
                                                                            "children": [],
                                                                            "label": "DEFAULT_USER_ID"
                                                                        }
                                                                    ],
                                                                    "label": "(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        }
                                                    ],
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                }
                                            ],
                                            "label": "current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                        },
                                        {
                                            "type": "expression_statement",
                                            "start_token": 21,
                                            "end_token": 29,
                                            "children": [
                                                {
                                                    "type": "await",
                                                    "start_token": 21,
                                                    "end_token": 29,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 22,
                                                            "end_token": 29,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 22,
                                                                    "end_token": 24,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 22,
                                                                            "end_token": 22,
                                                                            "children": [],
                                                                            "label": "user_credit"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 24,
                                                                            "end_token": 24,
                                                                            "children": [],
                                                                            "label": "top_up_credits"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.top_up_credits"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 25,
                                                                    "end_token": 29,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 26,
                                                                            "end_token": 26,
                                                                            "children": [],
                                                                            "label": "DEFAULT_USER_ID"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 28,
                                                                            "end_token": 28,
                                                                            "children": [],
                                                                            "label": "100"
                                                                        }
                                                                    ],
                                                                    "label": "(DEFAULT_USER_ID, 100)"
                                                                }
                                                            ],
                                                            "label": "user_credit.top_up_credits(DEFAULT_USER_ID, 100)"
                                                        }
                                                    ],
                                                    "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)"
                                                }
                                            ],
                                            "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)"
                                        },
                                        {
                                            "type": "assignment",
                                            "start_token": 32,
                                            "end_token": 40,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 32,
                                                    "end_token": 32,
                                                    "children": [],
                                                    "label": "new_credit"
                                                },
                                                {
                                                    "type": "await",
                                                    "start_token": 34,
                                                    "end_token": 40,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 35,
                                                            "end_token": 40,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 35,
                                                                    "end_token": 37,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 35,
                                                                            "end_token": 35,
                                                                            "children": [],
                                                                            "label": "user_credit"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 37,
                                                                            "end_token": 37,
                                                                            "children": [],
                                                                            "label": "get_or_refill_credit"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.get_or_refill_credit"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 38,
                                                                    "end_token": 40,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 39,
                                                                            "end_token": 39,
                                                                            "children": [],
                                                                            "label": "DEFAULT_USER_ID"
                                                                        }
                                                                    ],
                                                                    "label": "(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        }
                                                    ],
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                }
                                            ],
                                            "label": "new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                        },
                                        {
                                            "type": "assert_statement",
                                            "start_token": 42,
                                            "end_token": 48,
                                            "children": [
                                                {
                                                    "type": "comparison_operator",
                                                    "start_token": 43,
                                                    "end_token": 48,
                                                    "children": [
                                                        {
                                                            "type": "binary_operator",
                                                            "start_token": 46,
                                                            "end_token": 48,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 46,
                                                                    "end_token": 46,
                                                                    "children": [],
                                                                    "label": "current_credit"
                                                                },
                                                                {
                                                                    "type": "integer",
                                                                    "start_token": 48,
                                                                    "end_token": 48,
                                                                    "children": [],
                                                                    "label": "100"
                                                                }
                                                            ],
                                                            "label": "current_credit + 100"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 43,
                                                            "end_token": 43,
                                                            "children": [],
                                                            "label": "new_credit"
                                                        }
                                                    ],
                                                    "label": "new_credit == current_credit + 100"
                                                },
                                                {
                                                    "type": "identifier",
                                                    "start_token": 45,
                                                    "end_token": 46,
                                                    "children": [],
                                                    "label": "= current_credit"
                                                }
                                            ],
                                            "label": "assert new_credit == current_credit + 100"
                                        }
                                    ],
                                    "label": "\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100\n"
                                }
                            ],
                            "label": "async def test_block_credit_top_up(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100\n"
                        }
                    ],
                    "label": "async def test_block_credit_top_up(server: SpinTestServer):\n    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n\n    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100\n"
                }
            ]
        },
        {
            "type": "function_placeholder",
            "name": "test_block_credit_reset",
            "start_line": 64,
            "end_line": 79,
            "children": [
                {
                    "type": "module",
                    "start_token": 0,
                    "end_token": 130,
                    "children": [
                        {
                            "type": "decorated_definition",
                            "start_token": 0,
                            "end_token": 130,
                            "children": [
                                {
                                    "type": "block",
                                    "start_token": 0,
                                    "end_token": 130,
                                    "children": [
                                        {
                                            "type": "function_definition",
                                            "start_token": 0,
                                            "end_token": 8,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 1,
                                                    "end_token": 1,
                                                    "label": "def"
                                                },
                                                {
                                                    "type": "identifier",
                                                    "start_token": 2,
                                                    "end_token": 2,
                                                    "label": "test_block_credit_reset"
                                                },
                                                {
                                                    "type": "parameters",
                                                    "start_token": 3,
                                                    "end_token": 7,
                                                    "children": [
                                                        {
                                                            "type": "typed_parameter",
                                                            "start_token": 4,
                                                            "end_token": 6,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 4,
                                                                    "end_token": 4,
                                                                    "label": "server"
                                                                },
                                                                {
                                                                    "type": "type",
                                                                    "start_token": 6,
                                                                    "end_token": 6,
                                                                    "label": "SpinTestServer"
                                                                }
                                                            ],
                                                            "label": "server: SpinTestServer"
                                                        }
                                                    ],
                                                    "label": "(server: SpinTestServer)"
                                                }
                                            ],
                                            "label": "async def test_block_credit_reset(server: SpinTestServer):"
                                        },
                                        {
                                            "type": "block",
                                            "start_token": 10,
                                            "end_token": 130,
                                            "children": [
                                                {
                                                    "type": "assignment",
                                                    "start_token": 10,
                                                    "end_token": 19,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 10,
                                                            "end_token": 10,
                                                            "label": "month1"
                                                        },
                                                        {
                                                            "type": "call",
                                                            "start_token": 12,
                                                            "end_token": 19,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 12,
                                                                    "end_token": 12,
                                                                    "label": "datetime"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 13,
                                                                    "end_token": 19,
                                                                    "children": [
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 14,
                                                                            "end_token": 14,
                                                                            "label": "2022"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 16,
                                                                            "end_token": 16,
                                                                            "label": "1"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 18,
                                                                            "end_token": 18,
                                                                            "label": "15"
                                                                        }
                                                                    ],
                                                                    "label": "(2022, 1, 15)"
                                                                }
                                                            ],
                                                            "label": "datetime(2022, 1, 15)"
                                                        }
                                                    ],
                                                    "label": "month1 = datetime(2022, 1, 15)"
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 21,
                                                    "end_token": 30,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 21,
                                                            "end_token": 21,
                                                            "label": "month2"
                                                        },
                                                        {
                                                            "type": "call",
                                                            "start_token": 23,
                                                            "end_token": 30,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 23,
                                                                    "end_token": 23,
                                                                    "label": "datetime"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 24,
                                                                    "end_token": 30,
                                                                    "children": [
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 25,
                                                                            "end_token": 25,
                                                                            "label": "2022"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 27,
                                                                            "end_token": 27,
                                                                            "label": "2"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 29,
                                                                            "end_token": 29,
                                                                            "label": "15"
                                                                        }
                                                                    ],
                                                                    "label": "(2022, 2, 15)"
                                                                }
                                                            ],
                                                            "label": "datetime(2022, 2, 15)"
                                                        }
                                                    ],
                                                    "label": "month2 = datetime(2022, 2, 15)"
                                                },
                                                {
                                                    "type": "attribute",
                                                    "start_token": 33,
                                                    "end_token": 36,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 33,
                                                            "end_token": 33,
                                                            "label": "user_credit"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 35,
                                                            "end_token": 35,
                                                            "label": "time_now"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now ="
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 33,
                                                    "end_token": 40,
                                                    "children": [
                                                        {
                                                            "type": "lambda",
                                                            "start_token": 37,
                                                            "end_token": 40,
                                                            "label": "lambda: month2\n"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now = lambda: month2\n"
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 41,
                                                    "end_token": 49,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 41,
                                                            "end_token": 41,
                                                            "label": "month2credit"
                                                        },
                                                        {
                                                            "type": "await",
                                                            "start_token": 43,
                                                            "end_token": 49,
                                                            "children": [
                                                                {
                                                                    "type": "call",
                                                                    "start_token": 44,
                                                                    "end_token": 49,
                                                                    "children": [
                                                                        {
                                                                            "type": "attribute",
                                                                            "start_token": 44,
                                                                            "end_token": 46,
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 44,
                                                                                    "end_token": 44,
                                                                                    "label": "user_credit"
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 46,
                                                                                    "end_token": 46,
                                                                                    "label": "get_or_refill_credit"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit"
                                                                        },
                                                                        {
                                                                            "type": "argument_list",
                                                                            "start_token": 47,
                                                                            "end_token": 49,
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 48,
                                                                                    "end_token": 48,
                                                                                    "label": "DEFAULT_USER_ID"
                                                                                }
                                                                            ],
                                                                            "label": "(DEFAULT_USER_ID)"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        }
                                                    ],
                                                    "label": "month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                },
                                                {
                                                    "type": "comment",
                                                    "start_token": 52,
                                                    "end_token": 61,
                                                    "label": "# Month 1 result should only affect month 1\n"
                                                },
                                                {
                                                    "type": "attribute",
                                                    "start_token": 62,
                                                    "end_token": 65,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 62,
                                                            "end_token": 62,
                                                            "label": "user_credit"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 64,
                                                            "end_token": 64,
                                                            "label": "time_now"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now ="
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 62,
                                                    "end_token": 69,
                                                    "children": [
                                                        {
                                                            "type": "lambda",
                                                            "start_token": 66,
                                                            "end_token": 69,
                                                            "label": "lambda: month1\n"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now = lambda: month1\n"
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 70,
                                                    "end_token": 78,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 70,
                                                            "end_token": 70,
                                                            "label": "month1credit"
                                                        },
                                                        {
                                                            "type": "await",
                                                            "start_token": 72,
                                                            "end_token": 78,
                                                            "children": [
                                                                {
                                                                    "type": "call",
                                                                    "start_token": 73,
                                                                    "end_token": 78,
                                                                    "children": [
                                                                        {
                                                                            "type": "attribute",
                                                                            "start_token": 73,
                                                                            "end_token": 75,
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 73,
                                                                                    "end_token": 73,
                                                                                    "label": "user_credit"
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 75,
                                                                                    "end_token": 75,
                                                                                    "label": "get_or_refill_credit"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit"
                                                                        },
                                                                        {
                                                                            "type": "argument_list",
                                                                            "start_token": 76,
                                                                            "end_token": 78,
                                                                            "children": [
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 77,
                                                                                    "end_token": 77,
                                                                                    "label": "DEFAULT_USER_ID"
                                                                                }
                                                                            ],
                                                                            "label": "(DEFAULT_USER_ID)"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        }
                                                    ],
                                                    "label": "month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                },
                                                {
                                                    "type": "await",
                                                    "start_token": 80,
                                                    "end_token": 88,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 81,
                                                            "end_token": 88,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 81,
                                                                    "end_token": 83,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 81,
                                                                            "end_token": 81,
                                                                            "label": "user_credit"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 83,
                                                                            "end_token": 83,
                                                                            "label": "top_up_credits"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.top_up_credits"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 84,
                                                                    "end_token": 88,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 85,
                                                                            "end_token": 85,
                                                                            "label": "DEFAULT_USER_ID"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 87,
                                                                            "end_token": 87,
                                                                            "label": "100"
                                                                        }
                                                                    ],
                                                                    "label": "(DEFAULT_USER_ID, 100)"
                                                                }
                                                            ],
                                                            "label": "user_credit.top_up_credits(DEFAULT_USER_ID, 100)"
                                                        }
                                                    ],
                                                    "label": "await user_credit.top_up_credits(DEFAULT_USER_ID, 100)"
                                                },
                                                {
                                                    "type": "assert_statement",
                                                    "start_token": 90,
                                                    "end_token": 103,
                                                    "children": [
                                                        {
                                                            "type": "binary_operator",
                                                            "start_token": 91,
                                                            "end_token": 102,
                                                            "children": [
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 91,
                                                                    "end_token": 97,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 92,
                                                                            "end_token": 97,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 92,
                                                                                    "end_token": 94,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 92,
                                                                                            "end_token": 92,
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 94,
                                                                                            "end_token": 94,
                                                                                            "label": "get_or_refill_credit"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.get_or_refill_credit"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 95,
                                                                                    "end_token": 97,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 96,
                                                                                            "end_token": 96,
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(DEFAULT_USER_ID)"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                },
                                                                {
                                                                    "type": "comparison_operator",
                                                                    "start_token": 98,
                                                                    "end_token": 99,
                                                                    "label": "=="
                                                                },
                                                                {
                                                                    "type": "binary_operator",
                                                                    "start_token": 100,
                                                                    "end_token": 102,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 100,
                                                                            "end_token": 100,
                                                                            "label": "month1credit"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 102,
                                                                            "end_token": 102,
                                                                            "label": "100"
                                                                        }
                                                                    ],
                                                                    "label": "month1credit + 100"
                                                                }
                                                            ],
                                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100"
                                                        }
                                                    ],
                                                    "label": "assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n"
                                                },
                                                {
                                                    "type": "comment",
                                                    "start_token": 105,
                                                    "end_token": 111,
                                                    "label": "# Month 2 balance is unaffected\n"
                                                },
                                                {
                                                    "type": "attribute",
                                                    "start_token": 112,
                                                    "end_token": 115,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 112,
                                                            "end_token": 112,
                                                            "label": "user_credit"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 114,
                                                            "end_token": 114,
                                                            "label": "time_now"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now ="
                                                },
                                                {
                                                    "type": "assignment",
                                                    "start_token": 112,
                                                    "end_token": 119,
                                                    "children": [
                                                        {
                                                            "type": "lambda",
                                                            "start_token": 116,
                                                            "end_token": 119,
                                                            "label": "lambda: month2\n"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now = lambda: month2\n"
                                                },
                                                {
                                                    "type": "assert_statement",
                                                    "start_token": 120,
                                                    "end_token": 130,
                                                    "children": [
                                                        {
                                                            "type": "binary_operator",
                                                            "start_token": 121,
                                                            "end_token": 130,
                                                            "children": [
                                                                {
                                                                    "type": "await",
                                                                    "start_token": 121,
                                                                    "end_token": 127,
                                                                    "children": [
                                                                        {
                                                                            "type": "call",
                                                                            "start_token": 122,
                                                                            "end_token": 127,
                                                                            "children": [
                                                                                {
                                                                                    "type": "attribute",
                                                                                    "start_token": 122,
                                                                                    "end_token": 124,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 122,
                                                                                            "end_token": 122,
                                                                                            "label": "user_credit"
                                                                                        },
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 124,
                                                                                            "end_token": 124,
                                                                                            "label": "get_or_refill_credit"
                                                                                        }
                                                                                    ],
                                                                                    "label": "user_credit.get_or_refill_credit"
                                                                                },
                                                                                {
                                                                                    "type": "argument_list",
                                                                                    "start_token": 125,
                                                                                    "end_token": 127,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "identifier",
                                                                                            "start_token": 126,
                                                                                            "end_token": 126,
                                                                                            "label": "DEFAULT_USER_ID"
                                                                                        }
                                                                                    ],
                                                                                    "label": "(DEFAULT_USER_ID)"
                                                                                }
                                                                            ],
                                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                        }
                                                                    ],
                                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                                },
                                                                {
                                                                    "type": "comparison_operator",
                                                                    "start_token": 128,
                                                                    "end_token": 129,
                                                                    "label": "=="
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 130,
                                                                    "end_token": 130,
                                                                    "label": "month2credit"
                                                                }
                                                            ],
                                                            "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                                                        }
                                                    ],
                                                    "label": "assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                                                }
                                            ],
                                            "label": "month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                                        }
                                    ],
                                    "label": "async def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                                }
                            ],
                            "label": "async def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                        }
                    ],
                    "label": "async def test_block_credit_reset(server: SpinTestServer):\n    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n\n    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n\n    # Month 1 result should only affect month 1\n    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n\n    # Month 2 balance is unaffected\n    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit"
                }
            ]
        },
        {
            "type": "function_placeholder",
            "name": "test_credit_refill",
            "start_line": 83,
            "end_line": 98,
            "children": [
                {
                    "type": "module",
                    "start_token": 0,
                    "end_token": 113,
                    "children": [
                        {
                            "type": "function_definition",
                            "start_token": 0,
                            "end_token": 113,
                            "children": [
                                {
                                    "type": "identifier",
                                    "start_token": 1,
                                    "end_token": 1,
                                    "children": [],
                                    "label": "def"
                                },
                                {
                                    "type": "parameters",
                                    "start_token": 3,
                                    "end_token": 7,
                                    "children": [
                                        {
                                            "type": "typed_parameter",
                                            "start_token": 4,
                                            "end_token": 6,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 4,
                                                    "end_token": 4,
                                                    "children": [],
                                                    "label": "server"
                                                },
                                                {
                                                    "type": "type",
                                                    "start_token": 6,
                                                    "end_token": 6,
                                                    "children": [],
                                                    "label": "SpinTestServer"
                                                }
                                            ],
                                            "label": "server: SpinTestServer"
                                        }
                                    ],
                                    "label": "(server: SpinTestServer)"
                                },
                                {
                                    "type": "block",
                                    "start_token": 9,
                                    "end_token": 113,
                                    "children": [
                                        {
                                            "type": "comment",
                                            "start_token": 10,
                                            "end_token": 16,
                                            "children": [],
                                            "label": "# Clear all transactions within the month"
                                        },
                                        {
                                            "type": "await",
                                            "start_token": 18,
                                            "end_token": 80,
                                            "children": [
                                                {
                                                    "type": "call",
                                                    "start_token": 19,
                                                    "end_token": 80,
                                                    "children": [
                                                        {
                                                            "type": "attribute",
                                                            "start_token": 19,
                                                            "end_token": 25,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 19,
                                                                    "end_token": 21,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 19,
                                                                            "end_token": 19,
                                                                            "children": [],
                                                                            "label": "CreditTransaction"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 21,
                                                                            "end_token": 21,
                                                                            "children": [],
                                                                            "label": "prisma"
                                                                        }
                                                                    ],
                                                                    "label": "CreditTransaction.prisma"
                                                                },
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 25,
                                                                    "end_token": 25,
                                                                    "children": [],
                                                                    "label": "update_many"
                                                                }
                                                            ],
                                                            "label": "CreditTransaction.prisma().update_many"
                                                        },
                                                        {
                                                            "type": "argument_list",
                                                            "start_token": 26,
                                                            "end_token": 80,
                                                            "children": [
                                                                {
                                                                    "type": "dictionary",
                                                                    "start_token": 28,
                                                                    "end_token": 68,
                                                                    "children": [
                                                                        {
                                                                            "type": "pair",
                                                                            "start_token": 32,
                                                                            "end_token": 35,
                                                                            "children": [
                                                                                {
                                                                                    "type": "string",
                                                                                    "start_token": 32,
                                                                                    "end_token": 32,
                                                                                    "children": [],
                                                                                    "label": "\"userId\""
                                                                                },
                                                                                {
                                                                                    "type": "identifier",
                                                                                    "start_token": 34,
                                                                                    "end_token": 34,
                                                                                    "children": [],
                                                                                    "label": "DEFAULT_USER_ID"
                                                                                }
                                                                            ],
                                                                            "label": "\"userId\": DEFAULT_USER_ID,"
                                                                        },
                                                                        {
                                                                            "type": "pair",
                                                                            "start_token": 37,
                                                                            "end_token": 63,
                                                                            "children": [
                                                                                {
                                                                                    "type": "string",
                                                                                    "start_token": 37,
                                                                                    "end_token": 37,
                                                                                    "children": [],
                                                                                    "label": "\"createdAt\""
                                                                                },
                                                                                {
                                                                                    "type": "dictionary",
                                                                                    "start_token": 39,
                                                                                    "end_token": 63,
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "pair",
                                                                                            "start_token": 41,
                                                                                            "end_token": 51,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string",
                                                                                                    "start_token": 41,
                                                                                                    "end_token": 41,
                                                                                                    "children": [],
                                                                                                    "label": "\"gte\""
                                                                                                },
                                                                                                {
                                                                                                    "type": "call",
                                                                                                    "start_token": 43,
                                                                                                    "end_token": 50,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "identifier",
                                                                                                            "start_token": 43,
                                                                                                            "end_token": 43,
                                                                                                            "children": [],
                                                                                                            "label": "datetime"
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "argument_list",
                                                                                                            "start_token": 44,
                                                                                                            "end_token": 50,
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 45,
                                                                                                                    "end_token": 45,
                                                                                                                    "children": [],
                                                                                                                    "label": "2022"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 47,
                                                                                                                    "end_token": 47,
                                                                                                                    "children": [],
                                                                                                                    "label": "2"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 49,
                                                                                                                    "end_token": 49,
                                                                                                                    "children": [],
                                                                                                                    "label": "1"
                                                                                                                }
                                                                                                            ],
                                                                                                            "label": "(2022, 2, 1)"
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "datetime(2022, 2, 1)"
                                                                                                }
                                                                                            ],
                                                                                            "label": "\"gte\": datetime(2022, 2, 1),"
                                                                                        },
                                                                                        {
                                                                                            "type": "pair",
                                                                                            "start_token": 53,
                                                                                            "end_token": 63,
                                                                                            "children": [
                                                                                                {
                                                                                                    "type": "string",
                                                                                                    "start_token": 53,
                                                                                                    "end_token": 53,
                                                                                                    "children": [],
                                                                                                    "label": "\"lt\""
                                                                                                },
                                                                                                {
                                                                                                    "type": "call",
                                                                                                    "start_token": 55,
                                                                                                    "end_token": 62,
                                                                                                    "children": [
                                                                                                        {
                                                                                                            "type": "identifier",
                                                                                                            "start_token": 55,
                                                                                                            "end_token": 55,
                                                                                                            "children": [],
                                                                                                            "label": "datetime"
                                                                                                        },
                                                                                                        {
                                                                                                            "type": "argument_list",
                                                                                                            "start_token": 56,
                                                                                                            "end_token": 62,
                                                                                                            "children": [
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 57,
                                                                                                                    "end_token": 57,
                                                                                                                    "children": [],
                                                                                                                    "label": "2022"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 59,
                                                                                                                    "end_token": 59,
                                                                                                                    "children": [],
                                                                                                                    "label": "3"
                                                                                                                },
                                                                                                                {
                                                                                                                    "type": "integer",
                                                                                                                    "start_token": 61,
                                                                                                                    "end_token": 61,
                                                                                                                    "children": [],
                                                                                                                    "label": "1"
                                                                                                                }
                                                                                                            ],
                                                                                                            "label": "(2022, 3, 1)"
                                                                                                        }
                                                                                                    ],
                                                                                                    "label": "datetime(2022, 3, 1)"
                                                                                                }
                                                                                            ],
                                                                                            "label": "\"lt\": datetime(2022, 3, 1),"
                                                                                        }
                                                                                    ],
                                                                                    "label": "{\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),"
                                                                                }
                                                                            ],
                                                                            "label": "\"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),"
                                                                        }
                                                                    ],
                                                                    "label": "where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        }"
                                                                },
                                                                {
                                                                    "type": "dictionary",
                                                                    "start_token": 71,
                                                                    "end_token": 77,
                                                                    "children": [
                                                                        {
                                                                            "type": "pair",
                                                                            "start_token": 74,
                                                                            "end_token": 76,
                                                                            "children": [
                                                                                {
                                                                                    "type": "string",
                                                                                    "start_token": 74,
                                                                                    "end_token": 74,
                                                                                    "children": [],
                                                                                    "label": "\"isActive\""
                                                                                },
                                                                                {
                                                                                    "type": "false",
                                                                                    "start_token": 76,
                                                                                    "end_token": 76,
                                                                                    "children": [],
                                                                                    "label": "False"
                                                                                }
                                                                            ],
                                                                            "label": "\"isActive\": False"
                                                                        }
                                                                    ],
                                                                    "label": "data={\"isActive\": False}"
                                                                }
                                                            ],
                                                            "label": "(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )"
                                                        }
                                                    ],
                                                    "label": "CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )"
                                                }
                                            ],
                                            "label": "await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )"
                                        },
                                        {
                                            "type": "assignment",
                                            "start_token": 82,
                                            "end_token": 95,
                                            "children": [
                                                {
                                                    "type": "attribute",
                                                    "start_token": 82,
                                                    "end_token": 84,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 82,
                                                            "end_token": 82,
                                                            "children": [],
                                                            "label": "user_credit"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 84,
                                                            "end_token": 84,
                                                            "children": [],
                                                            "label": "time_now"
                                                        }
                                                    ],
                                                    "label": "user_credit.time_now"
                                                },
                                                {
                                                    "type": "lambda",
                                                    "start_token": 86,
                                                    "end_token": 95,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 88,
                                                            "end_token": 95,
                                                            "children": [
                                                                {
                                                                    "type": "identifier",
                                                                    "start_token": 88,
                                                                    "end_token": 88,
                                                                    "children": [],
                                                                    "label": "datetime"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 89,
                                                                    "end_token": 95,
                                                                    "children": [
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 90,
                                                                            "end_token": 90,
                                                                            "children": [],
                                                                            "label": "2022"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 91,
                                                                            "end_token": 91,
                                                                            "children": [],
                                                                            "label": ","
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 92,
                                                                            "end_token": 92,
                                                                            "children": [],
                                                                            "label": "2"
                                                                        },
                                                                        {
                                                                            "type": "integer",
                                                                            "start_token": 94,
                                                                            "end_token": 94,
                                                                            "children": [],
                                                                            "label": "15"
                                                                        }
                                                                    ],
                                                                    "label": "(2022, 2, 15)"
                                                                }
                                                            ],
                                                            "label": "datetime(2022, 2, 15)"
                                                        }
                                                    ],
                                                    "label": "lambda: datetime(2022, 2, 15)"
                                                }
                                            ],
                                            "label": "user_credit.time_now = lambda: datetime(2022, 2, 15)"
                                        },
                                        {
                                            "type": "assignment",
                                            "start_token": 98,
                                            "end_token": 106,
                                            "children": [
                                                {
                                                    "type": "identifier",
                                                    "start_token": 98,
                                                    "end_token": 98,
                                                    "children": [],
                                                    "label": "balance"
                                                },
                                                {
                                                    "type": "await",
                                                    "start_token": 100,
                                                    "end_token": 106,
                                                    "children": [
                                                        {
                                                            "type": "call",
                                                            "start_token": 101,
                                                            "end_token": 106,
                                                            "children": [
                                                                {
                                                                    "type": "attribute",
                                                                    "start_token": 101,
                                                                    "end_token": 103,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 101,
                                                                            "end_token": 101,
                                                                            "children": [],
                                                                            "label": "user_credit"
                                                                        },
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 103,
                                                                            "end_token": 103,
                                                                            "children": [],
                                                                            "label": "get_or_refill_credit"
                                                                        }
                                                                    ],
                                                                    "label": "user_credit.get_or_refill_credit"
                                                                },
                                                                {
                                                                    "type": "argument_list",
                                                                    "start_token": 104,
                                                                    "end_token": 106,
                                                                    "children": [
                                                                        {
                                                                            "type": "identifier",
                                                                            "start_token": 105,
                                                                            "end_token": 105,
                                                                            "children": [],
                                                                            "label": "DEFAULT_USER_ID"
                                                                        }
                                                                    ],
                                                                    "label": "(DEFAULT_USER_ID)"
                                                                }
                                                            ],
                                                            "label": "user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                        }
                                                    ],
                                                    "label": "await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                                }
                                            ],
                                            "label": "balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)"
                                        },
                                        {
                                            "type": "assert_statement",
                                            "start_token": 108,
                                            "end_token": 112,
                                            "children": [
                                                {
                                                    "type": "comparison_operator",
                                                    "start_token": 109,
                                                    "end_token": 112,
                                                    "children": [
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 109,
                                                            "end_token": 109,
                                                            "children": [],
                                                            "label": "balance"
                                                        },
                                                        {
                                                            "type": "identifier",
                                                            "start_token": 112,
                                                            "end_token": 112,
                                                            "children": [],
                                                            "label": "REFILL_VALUE"
                                                        }
                                                    ],
                                                    "label": "balance == REFILL_VALUE"
                                                }
                                            ],
                                            "label": "assert balance == REFILL_VALUE"
                                        }
                                    ],
                                    "label": "\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE\n"
                                }
                            ],
                            "label": "async def test_credit_refill(server: SpinTestServer):\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE\n"
                        }
                    ],
                    "label": "async def test_credit_refill(server: SpinTestServer):\n    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n    user_credit.time_now = lambda: datetime(2022, 2, 15)\n\n    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE\n"
                }
            ]
        }
    ],
    "label": "from datetime import datetime\n\nimport pytest\nfrom prisma.models import CreditTransaction\n\nfrom backend.blocks.llm import AITextGeneratorBlock\nfrom backend.data.credit import UserCredit\nfrom backend.data.user import DEFAULT_USER_ID\nfrom backend.integrations.credentials_store import openai_credentials\nfrom backend.util.test import SpinTestServer\n\nREFILL_VALUE = 1000\nuser_credit = UserCredit(REFILL_VALUE)\n\n\n@pytest.mark.asyncio(scope=\"session\")\n\n\n@pytest.mark.asyncio(scope=\"session\")\n\n\n@pytest.mark.asyncio(scope=\"session\")\n\n\n@pytest.mark.asyncio(scope=\"session\")\n"
}