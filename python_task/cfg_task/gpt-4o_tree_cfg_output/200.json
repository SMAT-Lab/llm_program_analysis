{
  "name": "example_script",
  "type": "CFG",
  "blocks": [
    {
      "id": 1,
      "start_line": 1,
      "end_line": 24,
      "label": "import ipaddress\nimport re\nimport socket\nfrom typing import Callable\nfrom urllib.parse import urlparse, urlunparse\nimport idna\nimport requests as req\nfrom backend.util.settings import Config\n# List of IP networks to block\nBLOCKED_IP_NETWORKS = [\n    # --8<-- [start:BLOCKED_IP_NETWORKS]\n    ipaddress.ip_network(\"0.0.0.0/8\"),  # \"This\" Network\n    ipaddress.ip_network(\"10.0.0.0/8\"),  # Private-Use\n    ipaddress.ip_network(\"127.0.0.0/8\"),  # Loopback\n    ipaddress.ip_network(\"169.254.0.0/16\"),  # Link Local\n    ipaddress.ip_network(\"172.16.0.0/12\"),  # Private-Use\n    ipaddress.ip_network(\"192.168.0.0/16\"),  # Private-Use\n    ipaddress.ip_network(\"224.0.0.0/4\"),  # Multicast\n    ipaddress.ip_network(\"240.0.0.0/4\"),  # Reserved for Future Use\n    # --8<-- [end:BLOCKED_IP_NETWORKS]\n]\nALLOWED_SCHEMES = [\"http\", \"https\"]\nHOSTNAME_REGEX = re.compile(r\"^[A-Za-z0-9.-]+$\")  # Basic DNS-safe hostname pattern\nrequests = Requests(trusted_origins=Config().trust_endpoints_for_requests)",
      "successors": []
    }
  ],
  "functions": [
    {
      "name": "_canonicalize_url",
      "type": "CFG",
      "blocks": [
        {
          "id": 1,
          "start_line": 3,
          "end_line": 5,
          "label": "url = url.strip().strip(\"/\")\n    # Ensure the URL starts with http:// or https://\n    if not url.startswith((\"http://\", \"https://\")):",
          "successors": [
            {
              "id": 2,
              "start_line": 6,
              "end_line": 6,
              "label": "url = \"http://\" + url",
              "successors": []
            }
          ]
        },
        {
          "id": 3,
          "start_line": 8,
          "end_line": 9,
          "label": "url = url.replace(\"\\\\\", \"/\")\n    return url",
          "successors": []
        }
      ],
      "functions": [],
      "classes": []
    },
    {
      "name": "_is_ip_blocked",
      "type": "CFG",
      "blocks": [
        {
          "id": 1,
          "start_line": 1,
          "end_line": 6,
          "label": "def _is_ip_blocked(ip: str) -> bool:\n    \"\"\"\n    Checks if the IP address is in a blocked network.\n    \"\"\"\n    ip_addr = ipaddress.ip_address(ip)\n    return any(ip_addr in network for network in BLOCKED_IP_NETWORKS)",
          "successors": []
        }
      ],
      "functions": [],
      "classes": []
    },
    {
      "name": "validate_url",
      "type": "CFG",
      "blocks": [
        {
          "id": 1,
          "start_line": 1,
          "end_line": 8,
          "label": "def validate_url(url: str, trusted_origins: list[str]) -> str:\n    \"\"\"\n    Validates the URL to prevent SSRF attacks by ensuring it does not point to a private\n    or untrusted IP address, unless whitelisted.\n    \"\"\"\n    url = _canonicalize_url(url)\n    parsed = urlparse(url)\n    # Check scheme",
          "successors": [
            {
              "id": 2,
              "start_line": 9,
              "end_line": 9,
              "label": "if parsed.scheme not in ALLOWED_SCHEMES:",
              "successors": [
                {
                  "id": 3,
                  "start_line": 10,
                  "end_line": 12,
                  "label": "raise ValueError(\n            f\"Scheme '{parsed.scheme}' is not allowed. Only HTTP/HTTPS are supported.\"\n        )",
                  "successors": []
                }
              ]
            },
            {
              "id": 4,
              "start_line": 14,
              "end_line": 14,
              "label": "if not parsed.hostname:",
              "successors": [
                {
                  "id": 5,
                  "start_line": 15,
                  "end_line": 15,
                  "label": "raise ValueError(\"Invalid URL: No hostname found.\")",
                  "successors": []
                }
              ]
            },
            {
              "id": 6,
              "start_line": 17,
              "end_line": 17,
              "label": "try:",
              "successors": [
                {
                  "id": 7,
                  "start_line": 18,
                  "end_line": 18,
                  "label": "ascii_hostname = idna.encode(parsed.hostname).decode(\"ascii\")",
                  "successors": []
                },
                {
                  "id": 8,
                  "start_line": 19,
                  "end_line": 20,
                  "label": "except idna.IDNAError:\n        raise ValueError(\"Invalid hostname with unsupported characters.\")",
                  "successors": []
                }
              ]
            },
            {
              "id": 9,
              "start_line": 22,
              "end_line": 22,
              "label": "if not HOSTNAME_REGEX.match(ascii_hostname):",
              "successors": [
                {
                  "id": 10,
                  "start_line": 23,
                  "end_line": 23,
                  "label": "raise ValueError(\"Hostname contains invalid characters.\")",
                  "successors": []
                }
              ]
            },
            {
              "id": 11,
              "start_line": 25,
              "end_line": 28,
              "label": "parsed = parsed._replace(netloc=ascii_hostname)\n    url = str(urlunparse(parsed))\n    # Check if hostname is a trusted origin (exact match)\n    if ascii_hostname in trusted_origins:",
              "successors": [
                {
                  "id": 12,
                  "start_line": 29,
                  "end_line": 29,
                  "label": "return url",
                  "successors": []
                }
              ]
            },
            {
              "id": 13,
              "start_line": 31,
              "end_line": 31,
              "label": "try:",
              "successors": [
                {
                  "id": 14,
                  "start_line": 32,
                  "end_line": 32,
                  "label": "ip_addresses = {res[4][0] for res in socket.getaddrinfo(ascii_hostname, None)}",
                  "successors": []
                },
                {
                  "id": 15,
                  "start_line": 33,
                  "end_line": 34,
                  "label": "except socket.gaierror:\n        raise ValueError(f\"Unable to resolve IP address for hostname {ascii_hostname}\")",
                  "successors": []
                }
              ]
            },
            {
              "id": 16,
              "start_line": 35,
              "end_line": 36,
              "label": "if not ip_addresses:\n        raise ValueError(f\"No IP addresses found for {ascii_hostname}\")",
              "successors": []
            },
            {
              "id": 17,
              "start_line": 38,
              "end_line": 38,
              "label": "for ip in ip_addresses:",
              "successors": [
                {
                  "id": 18,
                  "start_line": 39,
                  "end_line": 39,
                  "label": "if _is_ip_blocked(ip):",
                  "successors": [
                    {
                      "id": 19,
                      "start_line": 40,
                      "end_line": 42,
                      "label": "raise ValueError(\n                f\"Access to private IP address {ip} for hostname {ascii_hostname} is not allowed.\"\n            )",
                      "successors": []
                    }
                  ]
                }
              ]
            },
            {
              "id": 20,
              "start_line": 43,
              "end_line": 43,
              "label": "return url",
              "successors": []
            }
          ]
        }
      ],
      "functions": [],
      "classes": []
    }
  ],
  "classes": [
    {
      "name": "Requests",
      "type": "CFG",
      "blocks": [],
      "functions": [
        {
          "name": "__init__",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 9,
              "label": "def __init__(\n        self,\n        trusted_origins: list[str] | None = None,\n        raise_for_status: bool = True,\n        extra_url_validator: Callable[[str], str] | None = None,\n        extra_headers: dict[str, str] | None = None,\n    ):\n        self.trusted_origins = []\n        for url in trusted_origins or []:",
              "successors": [
                {
                  "id": 2,
                  "start_line": 10,
                  "end_line": 11,
                  "label": "hostname = urlparse(url).hostname\n            if not hostname:",
                  "successors": [
                    {
                      "id": 3,
                      "start_line": 12,
                      "end_line": 13,
                      "label": "raise ValueError(f\"Invalid URL: Unable to determine hostname of {url}\")\n            self.trusted_origins.append(hostname)",
                      "successors": []
                    }
                  ]
                }
              ]
            },
            {
              "id": 4,
              "start_line": 14,
              "end_line": 16,
              "label": "self.raise_for_status = raise_for_status\n        self.extra_url_validator = extra_url_validator\n        self.extra_headers = extra_headers",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "request",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 3,
              "label": "def request(\n        self, method, url, headers=None, allow_redirects=False, *args, **kwargs\n    ) -> req.Response:",
              "successors": [
                {
                  "id": 2,
                  "start_line": 4,
                  "end_line": 4,
                  "label": "if self.extra_headers is not None:",
                  "successors": [
                    {
                      "id": 3,
                      "start_line": 5,
                      "end_line": 5,
                      "label": "headers = {**(headers or {}), **self.extra_headers}",
                      "successors": []
                    }
                  ]
                },
                {
                  "id": 4,
                  "start_line": 6,
                  "end_line": 6,
                  "label": "url = validate_url(url, self.trusted_origins)",
                  "successors": [
                    {
                      "id": 5,
                      "start_line": 7,
                      "end_line": 7,
                      "label": "if self.extra_url_validator is not None:",
                      "successors": [
                        {
                          "id": 6,
                          "start_line": 8,
                          "end_line": 8,
                          "label": "url = self.extra_url_validator(url)",
                          "successors": []
                        }
                      ]
                    },
                    {
                      "id": 7,
                      "start_line": 9,
                      "end_line": 16,
                      "label": "response = req.request(\n            method,\n            url,\n            headers=headers,\n            allow_redirects=allow_redirects,\n            *args,\n            **kwargs,\n        )",
                      "successors": [
                        {
                          "id": 8,
                          "start_line": 17,
                          "end_line": 17,
                          "label": "if self.raise_for_status:",
                          "successors": [
                            {
                              "id": 9,
                              "start_line": 18,
                              "end_line": 18,
                              "label": "response.raise_for_status()",
                              "successors": []
                            }
                          ]
                        },
                        {
                          "id": 10,
                          "start_line": 19,
                          "end_line": 19,
                          "label": "return response",
                          "successors": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "get",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def get(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"GET\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "post",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def post(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"POST\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "put",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def put(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"PUT\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "delete",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def delete(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"DELETE\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "head",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def head(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"HEAD\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "options",
          "type": "CFG",
          "blocks": [
            {
              "id": 1,
              "start_line": 1,
              "end_line": 2,
              "label": "def options(self, url, *args, **kwargs) -> req.Response:\n        return self.request(\"OPTIONS\", url, *args, **kwargs)",
              "successors": []
            }
          ],
          "functions": [],
          "classes": []
        },
        {
          "name": "patch",
          "type": "CFG",
          "blocks": [],
          "functions": [],
          "classes": []
        }
      ],
      "classes": []
    }
  ]
}