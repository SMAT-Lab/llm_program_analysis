{
    "nodes": [
        {
            "id": "chunk_0_GlobalBlock_1",
            "code": "import time\nfrom typing import Tuple\n"
        },
        {
            "id": "chunk_0_GlobalBlock_2",
            "code": "from redis import Redis\n"
        },
        {
            "id": "chunk_0_GlobalBlock_3",
            "code": "from .config import RATE_LIMIT_SETTINGS\n"
        },
        {
            "id": "chunk_1_RateLimiter_1",
            "code": "class RateLimiter:\n"
        },
        {
            "id": "chunk_1_RateLimiter_2",
            "code": "    def __init__(\n        self,\n        redis_host: str = RATE_LIMIT_SETTINGS.redis_host,\n        redis_port: str = RATE_LIMIT_SETTINGS.redis_port,\n        redis_password: str = RATE_LIMIT_SETTINGS.redis_password,\n        requests_per_minute: int = RATE_LIMIT_SETTINGS.requests_per_minute,\n    ):\n"
        },
        {
            "id": "chunk_1_RateLimiter_3",
            "code": "        self.redis = Redis(\n            host=redis_host,\n            port=int(redis_port),\n            password=redis_password,\n            decode_responses=True,\n        )\n"
        },
        {
            "id": "chunk_1_RateLimiter_4",
            "code": "        self.window = 60\n        self.max_requests = requests_per_minute\n"
        },
        {
            "id": "chunk_1_RateLimiter_5",
            "code": "    async def check_rate_limit(self, api_key_id: str) -> Tuple[bool, int, int]:\n        \"\"\"\n        Check if request is within rate limits.\n\n        Args:\n            api_key_id: The API key identifier to check\n\n        Returns:\n            Tuple of (is_allowed, remaining_requests, reset_time)\n        \"\"\"\n"
        },
        {
            "id": "chunk_1_RateLimiter_6",
            "code": "        now = time.time()\n        window_start = now - self.window\n        key = f\"ratelimit:{api_key_id}:1min\"\n"
        },
        {
            "id": "chunk_1_RateLimiter_7",
            "code": "        pipe = self.redis.pipeline()\n        pipe.zremrangebyscore(key, 0, window_start)\n        pipe.zadd(key, {str(now): now})\n        pipe.zcount(key, window_start, now)\n        pipe.expire(key, self.window)\n"
        },
        {
            "id": "chunk_1_RateLimiter_8",
            "code": "        _, _, request_count, _ = pipe.execute()\n"
        },
        {
            "id": "chunk_1_RateLimiter_9",
            "code": "        remaining = max(0, self.max_requests - request_count)\n        reset_time = int(now + self.window)\n"
        },
        {
            "id": "chunk_1_RateLimiter_10",
            "code": "        return request_count <= self.max_requests, remaining, reset_time\n"
        },
        {
            "id": "chunk_2___init___1",
            "code": "    def __init__(\n        self,\n        redis_host: str = RATE_LIMIT_SETTINGS.redis_host,\n        redis_port: str = RATE_LIMIT_SETTINGS.redis_port,\n        redis_password: str = RATE_LIMIT_SETTINGS.redis_password,\n        requests_per_minute: int = RATE_LIMIT_SETTINGS.requests_per_minute,\n    ):\n"
        },
        {
            "id": "chunk_2___init___2",
            "code": "        self.redis = Redis(\n            host=redis_host,\n            port=int(redis_port),\n            password=redis_password,\n            decode_responses=True,\n        )\n"
        },
        {
            "id": "chunk_2___init___3",
            "code": "        self.window = 60\n        self.max_requests = requests_per_minute\n"
        },
        {
            "id": "chunk_3_check_rate_limit_1",
            "code": "    async def check_rate_limit(self, api_key_id: str) -> Tuple[bool, int, int]:\n        \"\"\"\n        Check if request is within rate limits.\n\n        Args:\n            api_key_id: The API key identifier to check\n\n        Returns:\n            Tuple of (is_allowed, remaining_requests, reset_time)\n        \"\"\"\n"
        },
        {
            "id": "chunk_3_check_rate_limit_2",
            "code": "        now = time.time()\n        window_start = now - self.window\n        key = f\"ratelimit:{api_key_id}:1min\"\n\n"
        },
        {
            "id": "chunk_3_check_rate_limit_3",
            "code": "        pipe = self.redis.pipeline()\n        pipe.zremrangebyscore(key, 0, window_start)\n        pipe.zadd(key, {str(now): now})\n        pipe.zcount(key, window_start, now)\n        pipe.expire(key, self.window)\n\n"
        },
        {
            "id": "chunk_3_check_rate_limit_4",
            "code": "        _, _, request_count, _ = pipe.execute()\n\n"
        },
        {
            "id": "chunk_3_check_rate_limit_5",
            "code": "        remaining = max(0, self.max_requests - request_count)\n        reset_time = int(now + self.window)\n\n"
        },
        {
            "id": "chunk_3_check_rate_limit_6",
            "code": "        return request_count <= self.max_requests, remaining, reset_time\n"
        }
    ],
    "edges": [
        {
            "from": "chunk_0_GlobalBlock_1",
            "to": "chunk_0_GlobalBlock_2"
        },
        {
            "from": "chunk_0_GlobalBlock_2",
            "to": "chunk_0_GlobalBlock_3"
        },
        {
            "from": "chunk_1_RateLimiter_1",
            "to": "chunk_1_RateLimiter_2"
        },
        {
            "from": "chunk_1_RateLimiter_2",
            "to": "chunk_1_RateLimiter_3"
        },
        {
            "from": "chunk_1_RateLimiter_3",
            "to": "chunk_1_RateLimiter_4"
        },
        {
            "from": "chunk_1_RateLimiter_5",
            "to": "chunk_1_RateLimiter_6"
        },
        {
            "from": "chunk_1_RateLimiter_6",
            "to": "chunk_1_RateLimiter_7"
        },
        {
            "from": "chunk_1_RateLimiter_7",
            "to": "chunk_1_RateLimiter_8"
        },
        {
            "from": "chunk_1_RateLimiter_8",
            "to": "chunk_1_RateLimiter_9"
        },
        {
            "from": "chunk_1_RateLimiter_9",
            "to": "chunk_1_RateLimiter_10"
        },
        {
            "from": "chunk_2___init___1",
            "to": "chunk_2___init___2"
        },
        {
            "from": "chunk_2___init___2",
            "to": "chunk_2___init___3"
        },
        {
            "from": "chunk_3_check_rate_limit_1",
            "to": "chunk_3_check_rate_limit_2"
        },
        {
            "from": "chunk_3_check_rate_limit_2",
            "to": "chunk_3_check_rate_limit_3"
        },
        {
            "from": "chunk_3_check_rate_limit_3",
            "to": "chunk_3_check_rate_limit_4"
        },
        {
            "from": "chunk_3_check_rate_limit_4",
            "to": "chunk_3_check_rate_limit_5"
        },
        {
            "from": "chunk_3_check_rate_limit_5",
            "to": "chunk_3_check_rate_limit_6"
        }
    ]
}