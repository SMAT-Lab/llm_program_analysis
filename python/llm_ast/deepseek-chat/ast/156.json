{
    "type": "Program",
    "name": "Global",
    "range": [
        25,
        192
    ],
    "children": [
        {
            "type": "FunctionDecl",
            "name": "rate_limit_middleware",
            "range": [
                25,
                192
            ],
            "children": [
                {
                    "type": "AsyncKeyword",
                    "name": "async",
                    "range": [
                        25,
                        29
                    ],
                    "children": [],
                    "content": "async def rate_limit_middleware(request"
                },
                {
                    "type": "DefKeyword",
                    "name": "def",
                    "range": [
                        26,
                        29
                    ],
                    "children": [],
                    "content": "def rate_limit_middleware(request"
                },
                {
                    "type": "Identifier",
                    "name": "rate_limit_middleware",
                    "range": [
                        27,
                        47
                    ],
                    "children": [],
                    "content": "rate_limit_middleware(request:Request,call_next:RequestResponseEndpoint):\n\"\"\"FastAPI middleware for rate limiting API requests.\"\"\"\nlimiter=RateLimiter()"
                },
                {
                    "type": "ParameterList",
                    "name": "parameters",
                    "range": [
                        28,
                        36
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "request",
                            "range": [
                                29,
                                35
                            ],
                            "children": [],
                            "content": "request:Request,call_next:RequestResponseEndpoint"
                        },
                        {
                            "type": "Identifier",
                            "name": "call_next",
                            "range": [
                                33,
                                35
                            ],
                            "children": [],
                            "content": "call_next:RequestResponseEndpoint"
                        }
                    ],
                    "content": "(request:Request,call_next:RequestResponseEndpoint)"
                },
                {
                    "type": "Colon",
                    "name": ":",
                    "range": [
                        37,
                        38
                    ],
                    "children": [],
                    "content": ":\n"
                },
                {
                    "type": "Docstring",
                    "name": "docstring",
                    "range": [
                        39,
                        41
                    ],
                    "children": [],
                    "content": "\"\"\"FastAPI middleware for rate limiting API requests.\"\"\""
                },
                {
                    "type": "Assignment",
                    "name": "limiter",
                    "range": [
                        43,
                        47
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "limiter",
                            "range": [
                                43,
                                50
                            ],
                            "children": [],
                            "content": "limiter=RateLimiter()\n\nif"
                        },
                        {
                            "type": "CallExpression",
                            "name": "RateLimiter",
                            "range": [
                                45,
                                47
                            ],
                            "children": [],
                            "content": "RateLimiter()"
                        }
                    ],
                    "content": "limiter=RateLimiter()"
                },
                {
                    "type": "IfStatement",
                    "name": "if",
                    "range": [
                        50,
                        70
                    ],
                    "children": [
                        {
                            "type": "Condition",
                            "name": "condition",
                            "range": [
                                51,
                                61
                            ],
                            "children": [
                                {
                                    "type": "NotKeyword",
                                    "name": "not",
                                    "range": [
                                        51,
                                        54
                                    ],
                                    "children": [],
                                    "content": "not request.url"
                                },
                                {
                                    "type": "CallExpression",
                                    "name": "request.url.path.startswith",
                                    "range": [
                                        52,
                                        61
                                    ],
                                    "children": [],
                                    "content": "request.url.path.startswith(\"/api\")"
                                }
                            ],
                            "content": "not request.url.path.startswith(\"/api\")"
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return",
                            "range": [
                                64,
                                70
                            ],
                            "children": [
                                {
                                    "type": "AwaitKeyword",
                                    "name": "await",
                                    "range": [
                                        65,
                                        70
                                    ],
                                    "children": [],
                                    "content": "await call_next(request)\n"
                                },
                                {
                                    "type": "CallExpression",
                                    "name": "call_next",
                                    "range": [
                                        66,
                                        70
                                    ],
                                    "children": [],
                                    "content": "call_next(request)\n"
                                }
                            ],
                            "content": "return await call_next(request)\n"
                        }
                    ],
                    "content": "if not request.url.path.startswith(\"/api\"):\nreturn await call_next(request)\n"
                },
                {
                    "type": "Assignment",
                    "name": "api_key",
                    "range": [
                        72,
                        82
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "api_key",
                            "range": [
                                72,
                                79
                            ],
                            "children": [],
                            "content": "api_key=request.headers.get("
                        },
                        {
                            "type": "CallExpression",
                            "name": "request.headers.get",
                            "range": [
                                74,
                                82
                            ],
                            "children": [],
                            "content": "request.headers.get(\"Authorization\")\n"
                        }
                    ],
                    "content": "api_key=request.headers.get(\"Authorization\")\n"
                },
                {
                    "type": "IfStatement",
                    "name": "if",
                    "range": [
                        84,
                        94
                    ],
                    "children": [
                        {
                            "type": "Condition",
                            "name": "condition",
                            "range": [
                                85,
                                86
                            ],
                            "children": [
                                {
                                    "type": "NotKeyword",
                                    "name": "not",
                                    "range": [
                                        85,
                                        86
                                    ],
                                    "children": [],
                                    "content": "api_key:"
                                },
                                {
                                    "type": "Identifier",
                                    "name": "api_key",
                                    "range": [
                                        85,
                                        86
                                    ],
                                    "children": [],
                                    "content": "api_key:"
                                }
                            ],
                            "content": "api_key:"
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return",
                            "range": [
                                89,
                                94
                            ],
                            "children": [
                                {
                                    "type": "AwaitKeyword",
                                    "name": "await",
                                    "range": [
                                        90,
                                        94
                                    ],
                                    "children": [],
                                    "content": "call_next(request)\n"
                                },
                                {
                                    "type": "CallExpression",
                                    "name": "call_next",
                                    "range": [
                                        91,
                                        94
                                    ],
                                    "children": [],
                                    "content": "(request)\n"
                                }
                            ],
                            "content": "await call_next(request)\n"
                        }
                    ],
                    "content": "not api_key:\nreturn await call_next(request)\n"
                },
                {
                    "type": "Assignment",
                    "name": "api_key",
                    "range": [
                        96,
                        106
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "api_key",
                            "range": [
                                96,
                                103
                            ],
                            "children": [],
                            "content": "api_key=api_key.replace(\"Bearer \","
                        },
                        {
                            "type": "CallExpression",
                            "name": "api_key.replace",
                            "range": [
                                98,
                                106
                            ],
                            "children": [],
                            "content": "api_key.replace(\"Bearer \",\"\")\n"
                        }
                    ],
                    "content": "api_key=api_key.replace(\"Bearer \",\"\")\n"
                },
                {
                    "type": "Assignment",
                    "name": "is_allowed, remaining, reset_time",
                    "range": [
                        108,
                        121
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "is_allowed",
                            "range": [
                                108,
                                118
                            ],
                            "children": [],
                            "content": "is_allowed,remaining,reset_time=await limiter.check_rate_limit("
                        },
                        {
                            "type": "Identifier",
                            "name": "remaining",
                            "range": [
                                110,
                                118
                            ],
                            "children": [],
                            "content": "remaining,reset_time=await limiter.check_rate_limit("
                        },
                        {
                            "type": "Identifier",
                            "name": "reset_time",
                            "range": [
                                112,
                                121
                            ],
                            "children": [],
                            "content": "reset_time=await limiter.check_rate_limit(api_key)\n"
                        },
                        {
                            "type": "AwaitKeyword",
                            "name": "await",
                            "range": [
                                114,
                                119
                            ],
                            "children": [],
                            "content": "await limiter.check_rate_limit(api_key"
                        },
                        {
                            "type": "CallExpression",
                            "name": "limiter.check_rate_limit",
                            "range": [
                                115,
                                121
                            ],
                            "children": [],
                            "content": "limiter.check_rate_limit(api_key)\n"
                        }
                    ],
                    "content": "is_allowed,remaining,reset_time=await limiter.check_rate_limit(api_key)\n"
                },
                {
                    "type": "IfStatement",
                    "name": "if",
                    "range": [
                        123,
                        141
                    ],
                    "children": [
                        {
                            "type": "Condition",
                            "name": "condition",
                            "range": [
                                124,
                                125
                            ],
                            "children": [
                                {
                                    "type": "NotKeyword",
                                    "name": "not",
                                    "range": [
                                        124,
                                        125
                                    ],
                                    "children": [],
                                    "content": "not is_allowed"
                                },
                                {
                                    "type": "Identifier",
                                    "name": "is_allowed",
                                    "range": [
                                        124,
                                        125
                                    ],
                                    "children": [],
                                    "content": "not is_allowed"
                                }
                            ],
                            "content": "not is_allowed"
                        },
                        {
                            "type": "RaiseStatement",
                            "name": "raise",
                            "range": [
                                128,
                                141
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "HTTPException",
                                    "range": [
                                        129,
                                        141
                                    ],
                                    "children": [],
                                    "content": "HTTPException(\nstatus_code=429,detail=\"Rate limit exceeded. Please try again later.\"\n)\n"
                                }
                            ],
                            "content": "raise HTTPException(\nstatus_code=429,detail=\"Rate limit exceeded. Please try again later.\"\n)\n"
                        }
                    ],
                    "content": "if not is_allowed:\nraise HTTPException(\nstatus_code=429,detail=\"Rate limit exceeded. Please try again later.\"\n)\n"
                },
                {
                    "type": "Assignment",
                    "name": "response",
                    "range": [
                        143,
                        150
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "response",
                            "range": [
                                143,
                                150
                            ],
                            "children": [],
                            "content": "response=await call_next(request)\n"
                        },
                        {
                            "type": "AwaitKeyword",
                            "name": "await",
                            "range": [
                                145,
                                150
                            ],
                            "children": [],
                            "content": "await call_next(request)\n"
                        },
                        {
                            "type": "CallExpression",
                            "name": "call_next",
                            "range": [
                                146,
                                150
                            ],
                            "children": [],
                            "content": "call_next(request)\n"
                        }
                    ],
                    "content": "response=await call_next(request)\n"
                },
                {
                    "type": "Assignment",
                    "name": "response.headers[\"X-RateLimit-Limit\"]",
                    "range": [
                        151,
                        164
                    ],
                    "children": [
                        {
                            "type": "MemberExpression",
                            "name": "response.headers",
                            "range": [
                                151,
                                164
                            ],
                            "children": [],
                            "content": "response.headers[\"X-RateLimit-Limit\"]=str(limiter.max_requests)\n"
                        },
                        {
                            "type": "CallExpression",
                            "name": "str",
                            "range": [
                                158,
                                164
                            ],
                            "children": [],
                            "content": "str(limiter.max_requests)\n"
                        }
                    ],
                    "content": "response.headers[\"X-RateLimit-Limit\"]=str(limiter.max_requests)\n"
                },
                {
                    "type": "Assignment",
                    "name": "response.headers[\"X-RateLimit-Remaining\"]",
                    "range": [
                        165,
                        176
                    ],
                    "children": [
                        {
                            "type": "MemberExpression",
                            "name": "response.headers",
                            "range": [
                                165,
                                176
                            ],
                            "children": [],
                            "content": "response.headers[\"X-RateLimit-Remaining\"]=str(remaining)\n"
                        },
                        {
                            "type": "CallExpression",
                            "name": "str",
                            "range": [
                                172,
                                176
                            ],
                            "children": [],
                            "content": "str(remaining)\n"
                        }
                    ],
                    "content": "response.headers[\"X-RateLimit-Remaining\"]=str(remaining)\n"
                },
                {
                    "type": "Assignment",
                    "name": "response.headers[\"X-RateLimit-Reset\"]",
                    "range": [
                        177,
                        188
                    ],
                    "children": [
                        {
                            "type": "MemberExpression",
                            "name": "response.headers",
                            "range": [
                                177,
                                188
                            ],
                            "children": [],
                            "content": "response.headers[\"X-RateLimit-Reset\"]=str(reset_time)\n"
                        },
                        {
                            "type": "CallExpression",
                            "name": "str",
                            "range": [
                                184,
                                188
                            ],
                            "children": [],
                            "content": "str(reset_time)\n"
                        }
                    ],
                    "content": "response.headers[\"X-RateLimit-Reset\"]=str(reset_time)\n"
                },
                {
                    "type": "ReturnStatement",
                    "name": "return",
                    "range": [
                        190,
                        192
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "response",
                            "range": [
                                191,
                                192
                            ],
                            "children": [],
                            "content": "response\n"
                        }
                    ],
                    "content": "return response\n"
                }
            ],
            "content": "async def rate_limit_middleware(request:Request,call_next:RequestResponseEndpoint):\n\"\"\"FastAPI middleware for rate limiting API requests.\"\"\"\nlimiter=RateLimiter()\n\nif not request.url.path.startswith(\"/api\"):\nreturn await call_next(request)\n\napi_key=request.headers.get(\"Authorization\")\nif not api_key:\nreturn await call_next(request)\n\napi_key=api_key.replace(\"Bearer \",\"\")\n\nis_allowed,remaining,reset_time=await limiter.check_rate_limit(api_key)\n\nif not is_allowed:\nraise HTTPException(\nstatus_code=429,detail=\"Rate limit exceeded. Please try again later.\"\n)\n\nresponse=await call_next(request)\nresponse.headers[\"X-RateLimit-Limit\"]=str(limiter.max_requests)\nresponse.headers[\"X-RateLimit-Remaining\"]=str(remaining)\nresponse.headers[\"X-RateLimit-Reset\"]=str(reset_time)\n\nreturn response\n"
        }
    ],
    "content": "async def rate_limit_middleware(request:Request,call_next:RequestResponseEndpoint):\n\"\"\"FastAPI middleware for rate limiting API requests.\"\"\"\nlimiter=RateLimiter()\n\nif not request.url.path.startswith(\"/api\"):\nreturn await call_next(request)\n\napi_key=request.headers.get(\"Authorization\")\nif not api_key:\nreturn await call_next(request)\n\napi_key=api_key.replace(\"Bearer \",\"\")\n\nis_allowed,remaining,reset_time=await limiter.check_rate_limit(api_key)\n\nif not is_allowed:\nraise HTTPException(\nstatus_code=429,detail=\"Rate limit exceeded. Please try again later.\"\n)\n\nresponse=await call_next(request)\nresponse.headers[\"X-RateLimit-Limit\"]=str(limiter.max_requests)\nresponse.headers[\"X-RateLimit-Remaining\"]=str(remaining)\nresponse.headers[\"X-RateLimit-Reset\"]=str(reset_time)\n\nreturn response\n"
}