{
    "type": "Program",
    "name": "Global",
    "range": [
        0,
        1006
    ],
    "children": [
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                0,
                2
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "logging",
                    "range": [
                        1,
                        1
                    ],
                    "children": [],
                    "content": "logging"
                }
            ],
            "content": "import logging\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                4,
                19
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "google.auth.external_account_authorized_user",
                    "range": [
                        5,
                        9
                    ],
                    "children": [
                        {
                            "type": "ImportAlias",
                            "name": "Credentials",
                            "alias": "ExternalAccountCredentials",
                            "range": [
                                13,
                                15
                            ],
                            "children": [],
                            "content": "Credentials as ExternalAccountCredentials"
                        }
                    ],
                    "content": "google.auth.external_account_authorized_user"
                }
            ],
            "content": "from google.auth.external_account_authorized_user import(\nCredentials as ExternalAccountCredentials,\n)\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                20,
                32
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "google.auth.transport.requests",
                    "range": [
                        21,
                        27
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "AuthorizedSession",
                            "range": [
                                29,
                                29
                            ],
                            "children": [],
                            "content": "AuthorizedSession"
                        },
                        {
                            "type": "ImportSpecifier",
                            "name": "Request",
                            "range": [
                                31,
                                31
                            ],
                            "children": [],
                            "content": "Request"
                        }
                    ],
                    "content": "google.auth.transport.requests"
                }
            ],
            "content": "from google.auth.transport.requests import AuthorizedSession,Request\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                33,
                41
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "google.oauth2.credentials",
                    "range": [
                        34,
                        38
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "Credentials",
                            "range": [
                                40,
                                40
                            ],
                            "children": [],
                            "content": "Credentials"
                        }
                    ],
                    "content": "google.oauth2.credentials"
                }
            ],
            "content": "from google.oauth2.credentials import Credentials\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                42,
                48
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "google_auth_oauthlib.flow",
                    "range": [
                        43,
                        45
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "Flow",
                            "range": [
                                47,
                                47
                            ],
                            "children": [],
                            "content": "Flow"
                        }
                    ],
                    "content": "google_auth_oauthlib.flow"
                }
            ],
            "content": "from google_auth_oauthlib.flow import Flow\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                49,
                53
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "pydantic",
                    "range": [
                        50,
                        50
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "SecretStr",
                            "range": [
                                52,
                                52
                            ],
                            "children": [],
                            "content": "SecretStr"
                        }
                    ],
                    "content": "pydantic"
                }
            ],
            "content": "from pydantic import SecretStr\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                55,
                63
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "backend.data.model",
                    "range": [
                        56,
                        60
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "OAuth2Credentials",
                            "range": [
                                62,
                                62
                            ],
                            "children": [],
                            "content": "OAuth2Credentials"
                        }
                    ],
                    "content": "backend.data.model"
                }
            ],
            "content": "from backend.data.model import OAuth2Credentials\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                64,
                72
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": "backend.integrations.providers",
                    "range": [
                        65,
                        69
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "ProviderName",
                            "range": [
                                71,
                                71
                            ],
                            "children": [],
                            "content": "ProviderName"
                        }
                    ],
                    "content": "backend.integrations.providers"
                }
            ],
            "content": "from backend.integrations.providers import ProviderName\n"
        },
        {
            "type": "ImportDeclaration",
            "name": "",
            "range": [
                74,
                79
            ],
            "children": [
                {
                    "type": "ImportSpecifier",
                    "name": ".base",
                    "range": [
                        75,
                        76
                    ],
                    "children": [
                        {
                            "type": "ImportSpecifier",
                            "name": "BaseOAuthHandler",
                            "range": [
                                78,
                                78
                            ],
                            "children": [],
                            "content": "BaseOAuthHandler"
                        }
                    ],
                    "content": ".base"
                }
            ],
            "content": "from.base import BaseOAuthHandler\n"
        },
        {
            "type": "VariableDeclaration",
            "name": "logger",
            "range": [
                81,
                89
            ],
            "children": [
                {
                    "type": "AssignmentExpression",
                    "name": "",
                    "range": [
                        82,
                        88
                    ],
                    "children": [
                        {
                            "type": "CallExpression",
                            "name": "logging.getLogger",
                            "range": [
                                83,
                                87
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "__name__",
                                    "range": [
                                        87,
                                        87
                                    ],
                                    "children": [],
                                    "content": "__name__"
                                }
                            ],
                            "content": "logging.getLogger(__name__"
                        }
                    ],
                    "content": "=logging.getLogger(__name__)"
                }
            ],
            "content": "logger=logging.getLogger(__name__)\n"
        },
        {
            "type": "ClassDecl",
            "name": "GoogleOAuthHandler",
            "range": [
                105,
                111
            ],
            "children": [
                {
                    "type": "Inheritance",
                    "name": "BaseOAuthHandler",
                    "range": [
                        107,
                        109
                    ],
                    "children": [],
                    "content": "(BaseOAuthHandler)"
                },
                {
                    "type": "Docstring",
                    "name": "",
                    "range": [
                        112,
                        114
                    ],
                    "children": [],
                    "content": "\"\"\" \\n     Based on the documentation at https://developers.google.com/identity/protocols/oauth2/web-server \\n     \"\"\""
                },
                {
                    "type": "Comment",
                    "name": "# noqa",
                    "range": [
                        115,
                        117
                    ],
                    "children": [],
                    "content": "#noqa\n"
                }
            ],
            "content": "class GoogleOAuthHandler(BaseOAuthHandler):\n"
        },
        {
            "type": "VariableDecl",
            "name": "PROVIDER_NAME",
            "range": [
                119,
                124
            ],
            "children": [
                {
                    "type": "Assignment",
                    "name": "=",
                    "range": [
                        120,
                        121
                    ],
                    "children": [
                        {
                            "type": "Literal",
                            "name": "ProviderName.GOOGLE",
                            "range": [
                                121,
                                123
                            ],
                            "children": [],
                            "content": "ProviderName.GOOGLE"
                        }
                    ],
                    "content": "=ProviderName"
                }
            ],
            "content": "PROVIDER_NAME=ProviderName.GOOGLE\n"
        },
        {
            "type": "VariableDecl",
            "name": "EMAIL_ENDPOINT",
            "range": [
                125,
                128
            ],
            "children": [
                {
                    "type": "Assignment",
                    "name": "=",
                    "range": [
                        126,
                        127
                    ],
                    "children": [
                        {
                            "type": "Literal",
                            "name": "\"https://www.googleapis.com/oauth2/v2/userinfo\"",
                            "range": [
                                127,
                                127
                            ],
                            "children": [],
                            "content": "\"https://www.googleapis.com/oauth2/v2/userinfo\""
                        }
                    ],
                    "content": "=\"https://www.googleapis.com/oauth2/v2/userinfo\""
                }
            ],
            "content": "EMAIL_ENDPOINT=\"https://www.googleapis.com/oauth2/v2/userinfo\"\n"
        },
        {
            "type": "VariableDecl",
            "name": "DEFAULT_SCOPES",
            "range": [
                129,
                143
            ],
            "children": [
                {
                    "type": "Assignment",
                    "name": "=",
                    "range": [
                        130,
                        131
                    ],
                    "children": [
                        {
                            "type": "Array",
                            "name": "",
                            "range": [
                                131,
                                142
                            ],
                            "children": [
                                {
                                    "type": "Literal",
                                    "name": "\"https://www.googleapis.com/auth/userinfo.email\"",
                                    "range": [
                                        133,
                                        133
                                    ],
                                    "children": [],
                                    "content": "\"https://www.googleapis.com/auth/userinfo.email\""
                                },
                                {
                                    "type": "Literal",
                                    "name": "\"https://www.googleapis.com/auth/userinfo.profile\"",
                                    "range": [
                                        136,
                                        136
                                    ],
                                    "children": [],
                                    "content": "\"https://www.googleapis.com/auth/userinfo.profile\""
                                },
                                {
                                    "type": "Literal",
                                    "name": "\"openid\"",
                                    "range": [
                                        139,
                                        139
                                    ],
                                    "children": [],
                                    "content": "\"openid\""
                                }
                            ],
                            "content": "[\n\"https://www.googleapis.com/auth/userinfo.email\",\n\"https://www.googleapis.com/auth/userinfo.profile\",\n\"openid\",\n]"
                        }
                    ],
                    "content": "=["
                }
            ],
            "content": "DEFAULT_SCOPES=[\n\"https://www.googleapis.com/auth/userinfo.email\",\n\"https://www.googleapis.com/auth/userinfo.profile\",\n\"openid\",\n]\n"
        },
        {
            "type": "FunctionDecl",
            "name": "__init__",
            "range": [
                157,
                206
            ],
            "children": [
                {
                    "type": "ParameterList",
                    "name": "",
                    "range": [
                        159,
                        173
                    ],
                    "children": [
                        {
                            "type": "Parameter",
                            "name": "self",
                            "range": [
                                160,
                                160
                            ],
                            "children": [],
                            "content": "("
                        },
                        {
                            "type": "Parameter",
                            "name": "client_id",
                            "range": [
                                162,
                                164
                            ],
                            "children": [],
                            "content": ",client_id:"
                        },
                        {
                            "type": "Parameter",
                            "name": "client_secret",
                            "range": [
                                166,
                                168
                            ],
                            "children": [],
                            "content": ",client_secret:"
                        },
                        {
                            "type": "Parameter",
                            "name": "redirect_uri",
                            "range": [
                                170,
                                172
                            ],
                            "children": [],
                            "content": ",redirect_uri:"
                        }
                    ],
                    "content": "__init__(self,client_id:str,client_secret:str,redirect_uri:str"
                },
                {
                    "type": "BlockStatement",
                    "name": "",
                    "range": [
                        174,
                        206
                    ],
                    "children": [
                        {
                            "type": "AssignmentExpression",
                            "name": "=",
                            "range": [
                                176,
                                180
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": ".",
                                    "range": [
                                        176,
                                        178
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "self",
                                            "range": [
                                                176,
                                                176
                                            ],
                                            "children": [],
                                            "content": "\n"
                                        },
                                        {
                                            "type": "Identifier",
                                            "name": "client_id",
                                            "range": [
                                                178,
                                                178
                                            ],
                                            "children": [],
                                            "content": "."
                                        }
                                    ],
                                    "content": "\nself."
                                },
                                {
                                    "type": "Identifier",
                                    "name": "client_id",
                                    "range": [
                                        180,
                                        180
                                    ],
                                    "children": [],
                                    "content": "="
                                }
                            ],
                            "content": "\nself.client_id="
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "=",
                            "range": [
                                182,
                                186
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": ".",
                                    "range": [
                                        182,
                                        184
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "self",
                                            "range": [
                                                182,
                                                182
                                            ],
                                            "children": [],
                                            "content": "\n"
                                        },
                                        {
                                            "type": "Identifier",
                                            "name": "client_secret",
                                            "range": [
                                                184,
                                                184
                                            ],
                                            "children": [],
                                            "content": "."
                                        }
                                    ],
                                    "content": "\nself."
                                },
                                {
                                    "type": "Identifier",
                                    "name": "client_secret",
                                    "range": [
                                        186,
                                        186
                                    ],
                                    "children": [],
                                    "content": "="
                                }
                            ],
                            "content": "\nself.client_secret="
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "=",
                            "range": [
                                188,
                                192
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": ".",
                                    "range": [
                                        188,
                                        190
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "self",
                                            "range": [
                                                188,
                                                188
                                            ],
                                            "children": [],
                                            "content": "\n"
                                        },
                                        {
                                            "type": "Identifier",
                                            "name": "redirect_uri",
                                            "range": [
                                                190,
                                                190
                                            ],
                                            "children": [],
                                            "content": "."
                                        }
                                    ],
                                    "content": "\nself."
                                },
                                {
                                    "type": "Identifier",
                                    "name": "redirect_uri",
                                    "range": [
                                        192,
                                        192
                                    ],
                                    "children": [],
                                    "content": "="
                                }
                            ],
                            "content": "\nself.redirect_uri="
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "=",
                            "range": [
                                194,
                                198
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": ".",
                                    "range": [
                                        194,
                                        196
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "self",
                                            "range": [
                                                194,
                                                194
                                            ],
                                            "children": [],
                                            "content": "\n"
                                        },
                                        {
                                            "type": "Identifier",
                                            "name": "token_uri",
                                            "range": [
                                                196,
                                                196
                                            ],
                                            "children": [],
                                            "content": "."
                                        }
                                    ],
                                    "content": "\nself."
                                },
                                {
                                    "type": "Literal",
                                    "name": "\"https://oauth2.googleapis.com/token\"",
                                    "range": [
                                        198,
                                        198
                                    ],
                                    "children": [],
                                    "content": "="
                                }
                            ],
                            "content": "\nself.token_uri="
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "=",
                            "range": [
                                200,
                                204
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": ".",
                                    "range": [
                                        200,
                                        202
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "self",
                                            "range": [
                                                200,
                                                200
                                            ],
                                            "children": [],
                                            "content": "\n"
                                        },
                                        {
                                            "type": "Identifier",
                                            "name": "revoke_uri",
                                            "range": [
                                                202,
                                                202
                                            ],
                                            "children": [],
                                            "content": "."
                                        }
                                    ],
                                    "content": "\nself."
                                },
                                {
                                    "type": "Literal",
                                    "name": "\"https://oauth2.googleapis.com/revoke\"",
                                    "range": [
                                        204,
                                        204
                                    ],
                                    "children": [],
                                    "content": "="
                                }
                            ],
                            "content": "\nself.revoke_uri="
                        }
                    ],
                    "content": "):\nself.client_id=client_id\nself.client_secret=client_secret\nself.redirect_uri=redirect_uri\nself.token_uri=\"https://oauth2.googleapis.com/token\"\nself.revoke_uri=\"https://oauth2.googleapis.com/revoke\"\n"
                }
            ],
            "content": "\ndef __init__(self,client_id:str,client_secret:str,redirect_uri:str):\nself.client_id=client_id\nself.client_secret=client_secret\nself.redirect_uri=redirect_uri\nself.token_uri=\"https://oauth2.googleapis.com/token\"\nself.revoke_uri=\"https://oauth2.googleapis.com/revoke\"\n"
        },
        {
            "type": "FunctionDecl",
            "name": "get_login_url",
            "range": [
                207,
                226
            ],
            "children": [
                {
                    "type": "Parameter",
                    "name": "self",
                    "range": [
                        210,
                        210
                    ],
                    "children": [],
                    "content": "("
                },
                {
                    "type": "Parameter",
                    "name": "scopes",
                    "range": [
                        212,
                        217
                    ],
                    "children": [
                        {
                            "type": "TypeAnnotation",
                            "name": "list[str]",
                            "range": [
                                214,
                                217
                            ],
                            "children": [],
                            "content": ":list[str"
                        }
                    ],
                    "content": ",scopes:list[str"
                },
                {
                    "type": "Parameter",
                    "name": "state",
                    "range": [
                        219,
                        221
                    ],
                    "children": [
                        {
                            "type": "TypeAnnotation",
                            "name": "str",
                            "range": [
                                221,
                                221
                            ],
                            "children": [],
                            "content": ":"
                        }
                    ],
                    "content": ",state:"
                },
                {
                    "type": "ReturnType",
                    "name": "str",
                    "range": [
                        225,
                        225
                    ],
                    "children": [],
                    "content": ">"
                }
            ],
            "content": "\ndef get_login_url(self,scopes:list[str],state:str)->str"
        },
        {
            "type": "Block",
            "name": "FunctionBody",
            "range": [
                227,
                300
            ],
            "children": [
                {
                    "type": "VariableDecl",
                    "name": "all_scopes",
                    "range": [
                        228,
                        240
                    ],
                    "children": [
                        {
                            "type": "Assignment",
                            "name": "=",
                            "range": [
                                229,
                                229
                            ],
                            "children": [],
                            "content": "all_scopes"
                        },
                        {
                            "type": "CallExpression",
                            "name": "list(set(scopes + self.DEFAULT_SCOPES))",
                            "range": [
                                230,
                                240
                            ],
                            "children": [],
                            "content": "=list(set(scopes+self.DEFAULT_SCOPES)"
                        }
                    ],
                    "content": "\nall_scopes=list(set(scopes+self.DEFAULT_SCOPES)"
                },
                {
                    "type": "ExpressionStatement",
                    "name": "logger.debug",
                    "range": [
                        242,
                        248
                    ],
                    "children": [
                        {
                            "type": "CallExpression",
                            "name": "debug",
                            "range": [
                                244,
                                248
                            ],
                            "children": [
                                {
                                    "type": "Literal",
                                    "name": "f\"Setting up OAuth flow with scopes: {all_scopes}\"",
                                    "range": [
                                        246,
                                        247
                                    ],
                                    "children": [],
                                    "content": "(f"
                                }
                            ],
                            "content": ".debug(f \"Setting up OAuth flow with scopes: {all_scopes}\""
                        }
                    ],
                    "content": "\nlogger.debug(f \"Setting up OAuth flow with scopes: {all_scopes}\""
                },
                {
                    "type": "VariableDecl",
                    "name": "flow",
                    "range": [
                        250,
                        258
                    ],
                    "children": [
                        {
                            "type": "Assignment",
                            "name": "=",
                            "range": [
                                251,
                                251
                            ],
                            "children": [],
                            "content": "flow"
                        },
                        {
                            "type": "CallExpression",
                            "name": "self._setup_oauth_flow(all_scopes)",
                            "range": [
                                252,
                                258
                            ],
                            "children": [],
                            "content": "=self._setup_oauth_flow(all_scopes)"
                        }
                    ],
                    "content": "\nflow=self._setup_oauth_flow(all_scopes)"
                },
                {
                    "type": "ExpressionStatement",
                    "name": "flow.redirect_uri",
                    "range": [
                        259,
                        266
                    ],
                    "children": [
                        {
                            "type": "Assignment",
                            "name": "=",
                            "range": [
                                262,
                                262
                            ],
                            "children": [],
                            "content": "redirect_uri"
                        },
                        {
                            "type": "Identifier",
                            "name": "self.redirect_uri",
                            "range": [
                                263,
                                266
                            ],
                            "children": [],
                            "content": "=self.redirect_uri"
                        }
                    ],
                    "content": "\nflow.redirect_uri=self.redirect_uri"
                },
                {
                    "type": "VariableDecl",
                    "name": "authorization_url",
                    "range": [
                        267,
                        297
                    ],
                    "children": [
                        {
                            "type": "Assignment",
                            "name": "=",
                            "range": [
                                270,
                                270
                            ],
                            "children": [],
                            "content": "_"
                        },
                        {
                            "type": "CallExpression",
                            "name": "flow.authorization_url(access_type=\"offline\", include_granted_scopes=\"true\", state=state, prompt=\"consent\")",
                            "range": [
                                271,
                                297
                            ],
                            "children": [],
                            "content": "=flow.authorization_url(\naccess_type=\"offline\",\ninclude_granted_scopes=\"true\",\nstate=state,\nprompt=\"consent\",\n)"
                        }
                    ],
                    "content": "\nauthorization_url,_=flow.authorization_url(\naccess_type=\"offline\",\ninclude_granted_scopes=\"true\",\nstate=state,\nprompt=\"consent\",\n)"
                },
                {
                    "type": "ReturnStatement",
                    "name": "return",
                    "range": [
                        298,
                        300
                    ],
                    "children": [
                        {
                            "type": "Identifier",
                            "name": "authorization_url",
                            "range": [
                                299,
                                299
                            ],
                            "children": [],
                            "content": "return"
                        }
                    ],
                    "content": "\nreturn authorization_url"
                }
            ],
            "content": ":\nall_scopes=list(set(scopes+self.DEFAULT_SCOPES))\nlogger.debug(f \"Setting up OAuth flow with scopes: {all_scopes}\")\nflow=self._setup_oauth_flow(all_scopes)\nflow.redirect_uri=self.redirect_uri\nauthorization_url,_=flow.authorization_url(\naccess_type=\"offline\",\ninclude_granted_scopes=\"true\",\nstate=state,\nprompt=\"consent\",\n)\nreturn authorization_url"
        },
        {
            "type": "FunctionDecl",
            "name": "exchange_code_for_tokens",
            "range": [
                301,
                598
            ],
            "children": [
                {
                    "type": "ParameterList",
                    "name": "parameters",
                    "range": [
                        303,
                        318
                    ],
                    "children": [
                        {
                            "type": "Parameter",
                            "name": "self",
                            "range": [
                                305,
                                305
                            ],
                            "children": [],
                            "content": "("
                        },
                        {
                            "type": "Parameter",
                            "name": "code",
                            "range": [
                                307,
                                309
                            ],
                            "children": [],
                            "content": "self,code"
                        },
                        {
                            "type": "Parameter",
                            "name": "scopes",
                            "range": [
                                311,
                                316
                            ],
                            "children": [],
                            "content": "str,scopes:list["
                        }
                    ],
                    "content": "def exchange_code_for_tokens(\nself,code:str,scopes:list[str]"
                },
                {
                    "type": "ReturnType",
                    "name": "OAuth2Credentials",
                    "range": [
                        319,
                        321
                    ],
                    "children": [],
                    "content": "\n)-"
                },
                {
                    "type": "Block",
                    "name": "body",
                    "range": [
                        322,
                        598
                    ],
                    "children": [
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                324,
                                330
                            ],
                            "children": [],
                            "content": ":\nlogger.debug(f"
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "flow = self._setup_oauth_flow",
                            "range": [
                                342,
                                349
                            ],
                            "children": [],
                            "content": "request\nflow=self._setup_oauth_flow("
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "flow.redirect_uri = self.redirect_uri",
                            "range": [
                                351,
                                358
                            ],
                            "children": [],
                            "content": ")\nflow.redirect_uri=self."
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                360,
                                365
                            ],
                            "children": [],
                            "content": "\n\nlogger.debug("
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "flow.oauth2session.scope = None",
                            "range": [
                                375,
                                381
                            ],
                            "children": [],
                            "content": "fetch_token\nflow.oauth2session.scope"
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "token = flow.fetch_token",
                            "range": [
                                383,
                                392
                            ],
                            "children": [],
                            "content": "None\ntoken=flow.fetch_token(code="
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                394,
                                399
                            ],
                            "children": [],
                            "content": ")\nlogger.debug("
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "granted_scopes = token.get",
                            "range": [
                                411,
                                426
                            ],
                            "children": [],
                            "content": "Google\ngranted_scopes:list[str]=token.get(\"scope\",["
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                429,
                                435
                            ],
                            "children": [],
                            "content": "\n\nlogger.debug(f"
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "google_creds = flow.credentials",
                            "range": [
                                438,
                                443
                            ],
                            "children": [],
                            "content": "\n\ngoogle_creds=flow."
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                444,
                                450
                            ],
                            "children": [],
                            "content": "credentials\nlogger.debug(f"
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                453,
                                458
                            ],
                            "children": [],
                            "content": "\n\nlogger.debug("
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "username = self._request_email",
                            "range": [
                                460,
                                467
                            ],
                            "children": [],
                            "content": ")\nusername=self._request_email("
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                469,
                                475
                            ],
                            "children": [],
                            "content": ")\nlogger.debug(f"
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert google_creds.token",
                            "range": [
                                478,
                                482
                            ],
                            "children": [],
                            "content": "\n\nassert google_creds."
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert google_creds.refresh_token",
                            "range": [
                                483,
                                487
                            ],
                            "children": [],
                            "content": "token\nassert google_creds."
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert google_creds.expiry",
                            "range": [
                                488,
                                492
                            ],
                            "children": [],
                            "content": "refresh_token\nassert google_creds."
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert granted_scopes",
                            "range": [
                                493,
                                495
                            ],
                            "children": [],
                            "content": "expiry\nassert"
                        },
                        {
                            "type": "AssignmentExpression",
                            "name": "credentials = OAuth2Credentials",
                            "range": [
                                505,
                                583
                            ],
                            "children": [],
                            "content": "scopes\ncredentials=OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\ntitle=None,\nusername=username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=(SecretStr(google_creds.refresh_token)),\naccess_token_expires_at=(\nint(google_creds.expiry.timestamp())if google_creds.expiry else None\n),\nrefresh_token_expires_at=None,\nscopes=granted_scopes,"
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "logger.debug",
                            "range": [
                                585,
                                593
                            ],
                            "children": [],
                            "content": ")\nlogger.debug(\nf \"OAuth2Credentials object created successfully with scopes: {credentials.scopes}\""
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return credentials",
                            "range": [
                                596,
                                597
                            ],
                            "children": [],
                            "content": "\n\n"
                        }
                    ],
                    "content": ">OAuth2Credentials:\nlogger.debug(f \"Exchanging code for tokens with scopes: {scopes}\")\n\n#Use the scopes from the initial request\nflow=self._setup_oauth_flow(scopes)\nflow.redirect_uri=self.redirect_uri\n\nlogger.debug(\"Fetching token from Google\")\n\n#Disable scope check in fetch_token\nflow.oauth2session.scope=None\ntoken=flow.fetch_token(code=code)\nlogger.debug(\"Token fetched successfully\")\n\n#Get the actual scopes granted by Google\ngranted_scopes:list[str]=token.get(\"scope\",[])\n\nlogger.debug(f \"Scopes granted by Google: {granted_scopes}\")\n\ngoogle_creds=flow.credentials\nlogger.debug(f \"Received credentials: {google_creds}\")\n\nlogger.debug(\"Requesting user email\")\nusername=self._request_email(google_creds)\nlogger.debug(f \"User email retrieved: {username}\")\n\nassert google_creds.token\nassert google_creds.refresh_token\nassert google_creds.expiry\nassert granted_scopes\n\n#Create OAuth2Credentials with the granted scopes\ncredentials=OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\ntitle=None,\nusername=username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=(SecretStr(google_creds.refresh_token)),\naccess_token_expires_at=(\nint(google_creds.expiry.timestamp())if google_creds.expiry else None\n),\nrefresh_token_expires_at=None,\nscopes=granted_scopes,\n)\nlogger.debug(\nf \"OAuth2Credentials object created successfully with scopes: {credentials.scopes}\"\n)\n\nreturn"
                }
            ],
            "content": "\n\ndef exchange_code_for_tokens(\nself,code:str,scopes:list[str]\n)->OAuth2Credentials:\nlogger.debug(f \"Exchanging code for tokens with scopes: {scopes}\")\n\n#Use the scopes from the initial request\nflow=self._setup_oauth_flow(scopes)\nflow.redirect_uri=self.redirect_uri\n\nlogger.debug(\"Fetching token from Google\")\n\n#Disable scope check in fetch_token\nflow.oauth2session.scope=None\ntoken=flow.fetch_token(code=code)\nlogger.debug(\"Token fetched successfully\")\n\n#Get the actual scopes granted by Google\ngranted_scopes:list[str]=token.get(\"scope\",[])\n\nlogger.debug(f \"Scopes granted by Google: {granted_scopes}\")\n\ngoogle_creds=flow.credentials\nlogger.debug(f \"Received credentials: {google_creds}\")\n\nlogger.debug(\"Requesting user email\")\nusername=self._request_email(google_creds)\nlogger.debug(f \"User email retrieved: {username}\")\n\nassert google_creds.token\nassert google_creds.refresh_token\nassert google_creds.expiry\nassert granted_scopes\n\n#Create OAuth2Credentials with the granted scopes\ncredentials=OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\ntitle=None,\nusername=username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=(SecretStr(google_creds.refresh_token)),\naccess_token_expires_at=(\nint(google_creds.expiry.timestamp())if google_creds.expiry else None\n),\nrefresh_token_expires_at=None,\nscopes=granted_scopes,\n)\nlogger.debug(\nf \"OAuth2Credentials object created successfully with scopes: {credentials.scopes}\"\n)\n\nreturn"
        },
        {
            "type": "FunctionDecl",
            "name": "revoke_tokens",
            "range": [
                599,
                658
            ],
            "children": [
                {
                    "type": "ParameterList",
                    "name": "parameters",
                    "range": [
                        601,
                        607
                    ],
                    "children": [
                        {
                            "type": "Parameter",
                            "name": "self",
                            "range": [
                                602,
                                602
                            ],
                            "children": [],
                            "content": "def"
                        },
                        {
                            "type": "Parameter",
                            "name": "credentials",
                            "range": [
                                604,
                                606
                            ],
                            "children": [],
                            "content": "(self,"
                        }
                    ],
                    "content": "\ndef revoke_tokens(self,credentials"
                },
                {
                    "type": "ReturnType",
                    "name": "bool",
                    "range": [
                        610,
                        610
                    ],
                    "children": [],
                    "content": ")"
                },
                {
                    "type": "Block",
                    "name": "function_body",
                    "range": [
                        612,
                        658
                    ],
                    "children": [
                        {
                            "type": "VariableDecl",
                            "name": "session",
                            "range": [
                                613,
                                618
                            ],
                            "children": [
                                {
                                    "type": "Assignment",
                                    "name": "=",
                                    "range": [
                                        614,
                                        614
                                    ],
                                    "children": [],
                                    "content": ":"
                                },
                                {
                                    "type": "CallExpression",
                                    "name": "AuthorizedSession",
                                    "range": [
                                        615,
                                        618
                                    ],
                                    "children": [
                                        {
                                            "type": "ArgumentList",
                                            "name": "arguments",
                                            "range": [
                                                616,
                                                618
                                            ],
                                            "children": [
                                                {
                                                    "type": "Argument",
                                                    "name": "credentials",
                                                    "range": [
                                                        617,
                                                        617
                                                    ],
                                                    "children": [],
                                                    "content": "="
                                                }
                                            ],
                                            "content": "session=AuthorizedSession"
                                        }
                                    ],
                                    "content": "\nsession=AuthorizedSession"
                                }
                            ],
                            "content": "bool:\nsession=AuthorizedSession"
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "session.post",
                            "range": [
                                620,
                                654
                            ],
                            "children": [
                                {
                                    "type": "CallExpression",
                                    "name": "post",
                                    "range": [
                                        622,
                                        654
                                    ],
                                    "children": [
                                        {
                                            "type": "ArgumentList",
                                            "name": "arguments",
                                            "range": [
                                                623,
                                                654
                                            ],
                                            "children": [
                                                {
                                                    "type": "Argument",
                                                    "name": "self.revoke_uri",
                                                    "range": [
                                                        625,
                                                        627
                                                    ],
                                                    "children": [],
                                                    "content": "post(\n"
                                                },
                                                {
                                                    "type": "KeywordArgument",
                                                    "name": "params",
                                                    "range": [
                                                        630,
                                                        642
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Dictionary",
                                                            "name": "params",
                                                            "range": [
                                                                632,
                                                                642
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "KeyValuePair",
                                                                    "name": "token",
                                                                    "range": [
                                                                        633,
                                                                        641
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "CallExpression",
                                                                            "name": "get_secret_value",
                                                                            "range": [
                                                                                635,
                                                                                641
                                                                            ],
                                                                            "children": [
                                                                                {
                                                                                    "type": "MemberExpression",
                                                                                    "name": "access_token",
                                                                                    "range": [
                                                                                        635,
                                                                                        641
                                                                                    ],
                                                                                    "children": [
                                                                                        {
                                                                                            "type": "Identifier",
                                                                                            "name": "credentials",
                                                                                            "range": [
                                                                                                635,
                                                                                                641
                                                                                            ],
                                                                                            "children": [],
                                                                                            "content": "{\"token\":credentials.access_token."
                                                                                        }
                                                                                    ],
                                                                                    "content": "{\"token\":credentials.access_token."
                                                                                }
                                                                            ],
                                                                            "content": "{\"token\":credentials.access_token."
                                                                        }
                                                                    ],
                                                                    "content": "params={\"token\":credentials.access_token."
                                                                }
                                                            ],
                                                            "content": "\nparams={\"token\":credentials.access_token.get_secret_value"
                                                        }
                                                    ],
                                                    "content": "revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value"
                                                },
                                                {
                                                    "type": "KeywordArgument",
                                                    "name": "headers",
                                                    "range": [
                                                        645,
                                                        651
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Dictionary",
                                                            "name": "headers",
                                                            "range": [
                                                                647,
                                                                651
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "KeyValuePair",
                                                                    "name": "content-type",
                                                                    "range": [
                                                                        648,
                                                                        650
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "Literal",
                                                                            "name": "application/x-www-form-urlencoded",
                                                                            "range": [
                                                                                650,
                                                                                650
                                                                            ],
                                                                            "children": [],
                                                                            "content": "{"
                                                                        }
                                                                    ],
                                                                    "content": "headers={"
                                                                }
                                                            ],
                                                            "content": "\nheaders={\"content-type\""
                                                        }
                                                    ],
                                                    "content": "},\nheaders={\"content-type\""
                                                }
                                            ],
                                            "content": "session.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"}"
                                        }
                                    ],
                                    "content": "\nsession.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"}"
                                }
                            ],
                            "content": "credentials)\nsession.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"}"
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return",
                            "range": [
                                656,
                                657
                            ],
                            "children": [
                                {
                                    "type": "Literal",
                                    "name": "True",
                                    "range": [
                                        657,
                                        657
                                    ],
                                    "children": [],
                                    "content": ")"
                                }
                            ],
                            "content": "\n)"
                        }
                    ],
                    "content": ">bool:\nsession=AuthorizedSession(credentials)\nsession.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"},\n)\n"
                }
            ],
            "content": "credentials\n\ndef revoke_tokens(self,credentials:OAuth2Credentials)->bool:\nsession=AuthorizedSession(credentials)\nsession.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"},\n)\n"
        },
        {
            "type": "FunctionDecl",
            "name": "_request_email",
            "range": [
                659,
                726
            ],
            "children": [
                {
                    "type": "ParameterList",
                    "name": "parameters",
                    "range": [
                        661,
                        671
                    ],
                    "children": [
                        {
                            "type": "Parameter",
                            "name": "self",
                            "range": [
                                663,
                                663
                            ],
                            "children": [],
                            "content": "def"
                        },
                        {
                            "type": "Parameter",
                            "name": "creds",
                            "range": [
                                665,
                                669
                            ],
                            "children": [
                                {
                                    "type": "TypeAnnotation",
                                    "name": "Credentials | ExternalAccountCredentials",
                                    "range": [
                                        667,
                                        669
                                    ],
                                    "children": [],
                                    "content": "self,creds"
                                }
                            ],
                            "content": "(\nself,creds"
                        }
                    ],
                    "content": "\n\ndef _request_email(\nself,creds:Credentials"
                },
                {
                    "type": "ReturnType",
                    "name": "str | None",
                    "range": [
                        672,
                        676
                    ],
                    "children": [],
                    "content": "|ExternalAccountCredentials\n)-"
                },
                {
                    "type": "BlockStatement",
                    "name": "body",
                    "range": [
                        678,
                        726
                    ],
                    "children": [
                        {
                            "type": "VariableDecl",
                            "name": "session",
                            "range": [
                                679,
                                684
                            ],
                            "children": [
                                {
                                    "type": "AssignmentExpression",
                                    "name": "=",
                                    "range": [
                                        680,
                                        684
                                    ],
                                    "children": [
                                        {
                                            "type": "NewExpression",
                                            "name": "AuthorizedSession",
                                            "range": [
                                                681,
                                                684
                                            ],
                                            "children": [
                                                {
                                                    "type": "ArgumentList",
                                                    "name": "arguments",
                                                    "range": [
                                                        683,
                                                        684
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "creds",
                                                            "range": [
                                                                683,
                                                                683
                                                            ],
                                                            "children": [],
                                                            "content": "session"
                                                        }
                                                    ],
                                                    "content": "session="
                                                }
                                            ],
                                            "content": ":\nsession="
                                        }
                                    ],
                                    "content": "None:\nsession="
                                }
                            ],
                            "content": "|None:\nsession="
                        },
                        {
                            "type": "VariableDecl",
                            "name": "response",
                            "range": [
                                686,
                                695
                            ],
                            "children": [
                                {
                                    "type": "AssignmentExpression",
                                    "name": "=",
                                    "range": [
                                        687,
                                        695
                                    ],
                                    "children": [
                                        {
                                            "type": "CallExpression",
                                            "name": "get",
                                            "range": [
                                                690,
                                                695
                                            ],
                                            "children": [
                                                {
                                                    "type": "MemberExpression",
                                                    "name": "session.get",
                                                    "range": [
                                                        688,
                                                        690
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "session",
                                                            "range": [
                                                                688,
                                                                688
                                                            ],
                                                            "children": [],
                                                            "content": ")"
                                                        }
                                                    ],
                                                    "content": ")\nresponse"
                                                },
                                                {
                                                    "type": "ArgumentList",
                                                    "name": "arguments",
                                                    "range": [
                                                        692,
                                                        695
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "MemberExpression",
                                                            "name": "self.EMAIL_ENDPOINT",
                                                            "range": [
                                                                692,
                                                                694
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "self",
                                                                    "range": [
                                                                        692,
                                                                        692
                                                                    ],
                                                                    "children": [],
                                                                    "content": "session"
                                                                }
                                                            ],
                                                            "content": "session.get"
                                                        }
                                                    ],
                                                    "content": "session.get("
                                                }
                                            ],
                                            "content": "response=session.get("
                                        }
                                    ],
                                    "content": "creds)\nresponse=session.get("
                                }
                            ],
                            "content": "(creds)\nresponse=session.get("
                        },
                        {
                            "type": "IfStatement",
                            "name": "if",
                            "range": [
                                697,
                                715
                            ],
                            "children": [
                                {
                                    "type": "UnaryExpression",
                                    "name": "not",
                                    "range": [
                                        698,
                                        702
                                    ],
                                    "children": [
                                        {
                                            "type": "MemberExpression",
                                            "name": "response.ok",
                                            "range": [
                                                699,
                                                701
                                            ],
                                            "children": [
                                                {
                                                    "type": "Identifier",
                                                    "name": "response",
                                                    "range": [
                                                        699,
                                                        699
                                                    ],
                                                    "children": [],
                                                    "content": ")"
                                                }
                                            ],
                                            "content": ")\nif"
                                        }
                                    ],
                                    "content": "EMAIL_ENDPOINT)\nif not"
                                },
                                {
                                    "type": "BlockStatement",
                                    "name": "consequent",
                                    "range": [
                                        703,
                                        715
                                    ],
                                    "children": [
                                        {
                                            "type": "ExpressionStatement",
                                            "name": "logger.error",
                                            "range": [
                                                704,
                                                712
                                            ],
                                            "children": [
                                                {
                                                    "type": "CallExpression",
                                                    "name": "error",
                                                    "range": [
                                                        706,
                                                        712
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "MemberExpression",
                                                            "name": "logger.error",
                                                            "range": [
                                                                704,
                                                                706
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "logger",
                                                                    "range": [
                                                                        704,
                                                                        704
                                                                    ],
                                                                    "children": [],
                                                                    "content": "."
                                                                }
                                                            ],
                                                            "content": ".ok:"
                                                        },
                                                        {
                                                            "type": "ArgumentList",
                                                            "name": "arguments",
                                                            "range": [
                                                                708,
                                                                712
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "TemplateLiteral",
                                                                    "name": "f\"Failed to get user email. Status code: {response.status_code}\"",
                                                                    "range": [
                                                                        709,
                                                                        710
                                                                    ],
                                                                    "children": [],
                                                                    "content": ".error"
                                                                }
                                                            ],
                                                            "content": "logger.error(\n"
                                                        }
                                                    ],
                                                    "content": ":\nlogger.error(\n"
                                                }
                                            ],
                                            "content": ".ok:\nlogger.error(\n"
                                        },
                                        {
                                            "type": "ReturnStatement",
                                            "name": "return",
                                            "range": [
                                                714,
                                                715
                                            ],
                                            "children": [
                                                {
                                                    "type": "Identifier",
                                                    "name": "None",
                                                    "range": [
                                                        715,
                                                        715
                                                    ],
                                                    "children": [],
                                                    "content": "\n"
                                                }
                                            ],
                                            "content": "\"Failed to get user email. Status code: {response.status_code}\"\n"
                                        }
                                    ],
                                    "content": "response.ok:\nlogger.error(\nf \"Failed to get user email. Status code: {response.status_code}\"\n"
                                }
                            ],
                            "content": ".EMAIL_ENDPOINT)\nif not response.ok:\nlogger.error(\nf \"Failed to get user email. Status code: {response.status_code}\"\n"
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return",
                            "range": [
                                717,
                                726
                            ],
                            "children": [
                                {
                                    "type": "MemberExpression",
                                    "name": "response.json",
                                    "range": [
                                        718,
                                        720
                                    ],
                                    "children": [
                                        {
                                            "type": "Identifier",
                                            "name": "response",
                                            "range": [
                                                718,
                                                718
                                            ],
                                            "children": [],
                                            "content": "return"
                                        }
                                    ],
                                    "content": "return None\n"
                                },
                                {
                                    "type": "CallExpression",
                                    "name": "json",
                                    "range": [
                                        720,
                                        725
                                    ],
                                    "children": [
                                        {
                                            "type": "ArgumentList",
                                            "name": "arguments",
                                            "range": [
                                                722,
                                                725
                                            ],
                                            "children": [
                                                {
                                                    "type": "StringLiteral",
                                                    "name": "\"email\"",
                                                    "range": [
                                                        724,
                                                        724
                                                    ],
                                                    "children": [],
                                                    "content": "json"
                                                }
                                            ],
                                            "content": "response.json("
                                        }
                                    ],
                                    "content": "\nreturn response.json("
                                }
                            ],
                            "content": "\nreturn None\nreturn response.json()"
                        }
                    ],
                    "content": "str|None:\nsession=AuthorizedSession(creds)\nresponse=session.get(self.EMAIL_ENDPOINT)\nif not response.ok:\nlogger.error(\nf \"Failed to get user email. Status code: {response.status_code}\"\n)\nreturn None\nreturn response.json()"
                }
            ],
            "content": "return True\n\ndef _request_email(\nself,creds:Credentials|ExternalAccountCredentials\n)->str|None:\nsession=AuthorizedSession(creds)\nresponse=session.get(self.EMAIL_ENDPOINT)\nif not response.ok:\nlogger.error(\nf \"Failed to get user email. Status code: {response.status_code}\"\n)\nreturn None\nreturn response.json()"
        },
        {
            "type": "FunctionDecl",
            "name": "_refresh_tokens",
            "range": [
                728,
                937
            ],
            "children": [
                {
                    "type": "ParameterList",
                    "name": "parameters",
                    "range": [
                        730,
                        736
                    ],
                    "children": [
                        {
                            "type": "Parameter",
                            "name": "self",
                            "range": [
                                731,
                                731
                            ],
                            "children": [],
                            "content": "\n"
                        },
                        {
                            "type": "Parameter",
                            "name": "credentials",
                            "range": [
                                733,
                                735
                            ],
                            "children": [],
                            "content": "_refresh_tokens(self"
                        }
                    ],
                    "content": "\n\ndef _refresh_tokens(self,"
                },
                {
                    "type": "ReturnType",
                    "name": "OAuth2Credentials",
                    "range": [
                        737,
                        739
                    ],
                    "children": [],
                    "content": "credentials:OAuth2Credentials"
                },
                {
                    "type": "Block",
                    "name": "body",
                    "range": [
                        740,
                        937
                    ],
                    "children": [
                        {
                            "type": "Comment",
                            "name": "Google credentials should ALWAYS have a refresh token",
                            "range": [
                                742,
                                751
                            ],
                            "children": [],
                            "content": ">OAuth2Credentials:\n#Google credentials should ALWAYS have"
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert",
                            "range": [
                                752,
                                756
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "credentials.refresh_token",
                                    "range": [
                                        753,
                                        755
                                    ],
                                    "children": [],
                                    "content": "refresh token\n"
                                }
                            ],
                            "content": "a refresh token\nassert"
                        },
                        {
                            "type": "VariableDecl",
                            "name": "google_creds",
                            "range": [
                                758,
                                813
                            ],
                            "children": [
                                {
                                    "type": "Assignment",
                                    "name": "=",
                                    "range": [
                                        759,
                                        813
                                    ],
                                    "children": [
                                        {
                                            "type": "NewExpression",
                                            "name": "Credentials",
                                            "range": [
                                                760,
                                                813
                                            ],
                                            "children": [
                                                {
                                                    "type": "ArgumentList",
                                                    "name": "arguments",
                                                    "range": [
                                                        761,
                                                        813
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "token",
                                                            "range": [
                                                                763,
                                                                771
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "CallExpression",
                                                                    "name": "get_secret_value",
                                                                    "range": [
                                                                        765,
                                                                        771
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "Identifier",
                                                                            "name": "credentials.access_token",
                                                                            "range": [
                                                                                765,
                                                                                771
                                                                            ],
                                                                            "children": [],
                                                                            "content": "(\ntoken=credentials.access_token"
                                                                        }
                                                                    ],
                                                                    "content": "(\ntoken=credentials.access_token"
                                                                }
                                                            ],
                                                            "content": "=Credentials(\ntoken=credentials.access_token"
                                                        },
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "refresh_token",
                                                            "range": [
                                                                774,
                                                                782
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "CallExpression",
                                                                    "name": "get_secret_value",
                                                                    "range": [
                                                                        776,
                                                                        782
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "Identifier",
                                                                            "name": "credentials.refresh_token",
                                                                            "range": [
                                                                                776,
                                                                                782
                                                                            ],
                                                                            "children": [],
                                                                            "content": ",\nrefresh_token=credentials.refresh_token"
                                                                        }
                                                                    ],
                                                                    "content": ",\nrefresh_token=credentials.refresh_token"
                                                                }
                                                            ],
                                                            "content": "(),\nrefresh_token=credentials.refresh_token"
                                                        },
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "token_uri",
                                                            "range": [
                                                                785,
                                                                790
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "self.token_uri",
                                                                    "range": [
                                                                        787,
                                                                        790
                                                                    ],
                                                                    "children": [],
                                                                    "content": ",\ntoken_uri="
                                                                }
                                                            ],
                                                            "content": "(),\ntoken_uri="
                                                        },
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "client_id",
                                                            "range": [
                                                                792,
                                                                797
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "self.client_id",
                                                                    "range": [
                                                                        794,
                                                                        797
                                                                    ],
                                                                    "children": [],
                                                                    "content": ",\nclient_id="
                                                                }
                                                            ],
                                                            "content": ".token_uri,\nclient_id="
                                                        },
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "client_secret",
                                                            "range": [
                                                                799,
                                                                804
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "self.client_secret",
                                                                    "range": [
                                                                        801,
                                                                        804
                                                                    ],
                                                                    "children": [],
                                                                    "content": ",\nclient_secret="
                                                                }
                                                            ],
                                                            "content": ".client_id,\nclient_secret="
                                                        },
                                                        {
                                                            "type": "NamedArgument",
                                                            "name": "scopes",
                                                            "range": [
                                                                806,
                                                                811
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Identifier",
                                                                    "name": "credentials.scopes",
                                                                    "range": [
                                                                        808,
                                                                        811
                                                                    ],
                                                                    "children": [],
                                                                    "content": ",\nscopes="
                                                                }
                                                            ],
                                                            "content": ".client_secret,\nscopes="
                                                        }
                                                    ],
                                                    "content": "\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials."
                                                }
                                            ],
                                            "content": "\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials."
                                        }
                                    ],
                                    "content": "refresh_token\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials."
                                }
                            ],
                            "content": ".refresh_token\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials."
                        },
                        {
                            "type": "Comment",
                            "name": "Google's OAuth library is poorly typed so we need some of these:",
                            "range": [
                                815,
                                831
                            ],
                            "children": [],
                            "content": ",\n)\n#Google's OAuth library is poorly typed so we need some"
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert",
                            "range": [
                                832,
                                836
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "google_creds.refresh_token",
                                    "range": [
                                        833,
                                        835
                                    ],
                                    "children": [],
                                    "content": "these:\n"
                                }
                            ],
                            "content": "of these:\nassert"
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert",
                            "range": [
                                837,
                                841
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "google_creds.scopes",
                                    "range": [
                                        838,
                                        840
                                    ],
                                    "children": [],
                                    "content": ".refresh_token\n"
                                }
                            ],
                            "content": "google_creds.refresh_token\nassert"
                        },
                        {
                            "type": "ExpressionStatement",
                            "name": "google_creds.refresh",
                            "range": [
                                843,
                                850
                            ],
                            "children": [
                                {
                                    "type": "CallExpression",
                                    "name": "refresh",
                                    "range": [
                                        845,
                                        850
                                    ],
                                    "children": [
                                        {
                                            "type": "ArgumentList",
                                            "name": "arguments",
                                            "range": [
                                                846,
                                                850
                                            ],
                                            "children": [
                                                {
                                                    "type": "NewExpression",
                                                    "name": "Request",
                                                    "range": [
                                                        847,
                                                        849
                                                    ],
                                                    "children": [],
                                                    "content": "google_creds.refresh"
                                                }
                                            ],
                                            "content": "\ngoogle_creds.refresh("
                                        }
                                    ],
                                    "content": "\n\ngoogle_creds.refresh("
                                }
                            ],
                            "content": ".scopes\n\ngoogle_creds.refresh("
                        },
                        {
                            "type": "AssertStatement",
                            "name": "assert",
                            "range": [
                                852,
                                856
                            ],
                            "children": [
                                {
                                    "type": "Identifier",
                                    "name": "google_creds.expiry",
                                    "range": [
                                        853,
                                        855
                                    ],
                                    "children": [],
                                    "content": "))\n"
                                }
                            ],
                            "content": "())\nassert"
                        },
                        {
                            "type": "ReturnStatement",
                            "name": "return",
                            "range": [
                                858,
                                937
                            ],
                            "children": [
                                {
                                    "type": "NewExpression",
                                    "name": "OAuth2Credentials",
                                    "range": [
                                        859,
                                        936
                                    ],
                                    "children": [
                                        {
                                            "type": "ArgumentList",
                                            "name": "arguments",
                                            "range": [
                                                860,
                                                936
                                            ],
                                            "children": [
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "provider",
                                                    "range": [
                                                        862,
                                                        867
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "self.PROVIDER_NAME",
                                                            "range": [
                                                                864,
                                                                867
                                                            ],
                                                            "children": [],
                                                            "content": "(\nprovider="
                                                        }
                                                    ],
                                                    "content": "return OAuth2Credentials(\nprovider="
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "id",
                                                    "range": [
                                                        869,
                                                        874
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "credentials.id",
                                                            "range": [
                                                                871,
                                                                874
                                                            ],
                                                            "children": [],
                                                            "content": ",\nid="
                                                        }
                                                    ],
                                                    "content": ".PROVIDER_NAME,\nid="
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "title",
                                                    "range": [
                                                        876,
                                                        881
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "credentials.title",
                                                            "range": [
                                                                878,
                                                                881
                                                            ],
                                                            "children": [],
                                                            "content": ",\ntitle="
                                                        }
                                                    ],
                                                    "content": ".id,\ntitle="
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "username",
                                                    "range": [
                                                        883,
                                                        888
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "credentials.username",
                                                            "range": [
                                                                885,
                                                                888
                                                            ],
                                                            "children": [],
                                                            "content": ",\nusername="
                                                        }
                                                    ],
                                                    "content": ".title,\nusername="
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "access_token",
                                                    "range": [
                                                        890,
                                                        897
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "NewExpression",
                                                            "name": "SecretStr",
                                                            "range": [
                                                                892,
                                                                897
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "ArgumentList",
                                                                    "name": "arguments",
                                                                    "range": [
                                                                        893,
                                                                        897
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "Identifier",
                                                                            "name": "google_creds.token",
                                                                            "range": [
                                                                                894,
                                                                                896
                                                                            ],
                                                                            "children": [],
                                                                            "content": "access_token=SecretStr"
                                                                        }
                                                                    ],
                                                                    "content": "\naccess_token=SecretStr("
                                                                }
                                                            ],
                                                            "content": ",\naccess_token=SecretStr("
                                                        }
                                                    ],
                                                    "content": ".username,\naccess_token=SecretStr("
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "refresh_token",
                                                    "range": [
                                                        900,
                                                        907
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "NewExpression",
                                                            "name": "SecretStr",
                                                            "range": [
                                                                902,
                                                                907
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "ArgumentList",
                                                                    "name": "arguments",
                                                                    "range": [
                                                                        903,
                                                                        907
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "Identifier",
                                                                            "name": "google_creds.refresh_token",
                                                                            "range": [
                                                                                904,
                                                                                906
                                                                            ],
                                                                            "children": [],
                                                                            "content": "refresh_token=SecretStr"
                                                                        }
                                                                    ],
                                                                    "content": "\nrefresh_token=SecretStr("
                                                                }
                                                            ],
                                                            "content": ",\nrefresh_token=SecretStr("
                                                        }
                                                    ],
                                                    "content": "token),\nrefresh_token=SecretStr("
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "access_token_expires_at",
                                                    "range": [
                                                        910,
                                                        921
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "CallExpression",
                                                            "name": "int",
                                                            "range": [
                                                                912,
                                                                921
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "ArgumentList",
                                                                    "name": "arguments",
                                                                    "range": [
                                                                        913,
                                                                        921
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "CallExpression",
                                                                            "name": "timestamp",
                                                                            "range": [
                                                                                918,
                                                                                920
                                                                            ],
                                                                            "children": [],
                                                                            "content": "google_creds.expiry"
                                                                        }
                                                                    ],
                                                                    "content": "\naccess_token_expires_at=int(google_creds.expiry."
                                                                }
                                                            ],
                                                            "content": ",\naccess_token_expires_at=int(google_creds.expiry."
                                                        }
                                                    ],
                                                    "content": "refresh_token),\naccess_token_expires_at=int(google_creds.expiry."
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "refresh_token_expires_at",
                                                    "range": [
                                                        924,
                                                        927
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Literal",
                                                            "name": "None",
                                                            "range": [
                                                                926,
                                                                926
                                                            ],
                                                            "children": [],
                                                            "content": ","
                                                        }
                                                    ],
                                                    "content": ")),\n"
                                                },
                                                {
                                                    "type": "NamedArgument",
                                                    "name": "scopes",
                                                    "range": [
                                                        929,
                                                        934
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "Identifier",
                                                            "name": "google_creds.scopes",
                                                            "range": [
                                                                931,
                                                                933
                                                            ],
                                                            "children": [],
                                                            "content": ",\nscopes"
                                                        }
                                                    ],
                                                    "content": "=None,\nscopes="
                                                }
                                            ],
                                            "content": "\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds."
                                        }
                                    ],
                                    "content": "expiry\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds."
                                }
                            ],
                            "content": ".expiry\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds.scopes"
                        }
                    ],
                    "content": ")->OAuth2Credentials:\n#Google credentials should ALWAYS have a refresh token\nassert credentials.refresh_token\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials.scopes,\n)\n#Google's OAuth library is poorly typed so we need some of these:\nassert google_creds.refresh_token\nassert google_creds.scopes\n\ngoogle_creds.refresh(Request())\nassert google_creds.expiry\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds.scopes"
                }
            ],
            "content": "\"email\"]\n\ndef _refresh_tokens(self,credentials:OAuth2Credentials)->OAuth2Credentials:\n#Google credentials should ALWAYS have a refresh token\nassert credentials.refresh_token\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials.scopes,\n)\n#Google's OAuth library is poorly typed so we need some of these:\nassert google_creds.refresh_token\nassert google_creds.scopes\n\ngoogle_creds.refresh(Request())\nassert google_creds.expiry\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds.scopes"
        },
        {
            "type": "FunctionDecl",
            "name": "_setup_oauth_flow",
            "range": [
                939,
                1006
            ],
            "children": [
                {
                    "type": "Parameter",
                    "name": "self",
                    "range": [
                        942,
                        942
                    ],
                    "children": [],
                    "content": "\n"
                },
                {
                    "type": "Parameter",
                    "name": "scopes",
                    "range": [
                        944,
                        949
                    ],
                    "children": [
                        {
                            "type": "TypeAnnotation",
                            "name": "list[str]",
                            "range": [
                                946,
                                949
                            ],
                            "children": [],
                            "content": "self,scopes:"
                        }
                    ],
                    "content": "_setup_oauth_flow(self,scopes:"
                },
                {
                    "type": "ReturnType",
                    "name": "Flow",
                    "range": [
                        953,
                        953
                    ],
                    "children": [],
                    "content": "]"
                },
                {
                    "type": "Block",
                    "name": "",
                    "range": [
                        955,
                        1006
                    ],
                    "children": [
                        {
                            "type": "ReturnStatement",
                            "name": "",
                            "range": [
                                956,
                                1004
                            ],
                            "children": [
                                {
                                    "type": "CallExpression",
                                    "name": "Flow.from_client_config",
                                    "range": [
                                        957,
                                        1004
                                    ],
                                    "children": [
                                        {
                                            "type": "ObjectLiteral",
                                            "name": "",
                                            "range": [
                                                962,
                                                996
                                            ],
                                            "children": [
                                                {
                                                    "type": "Property",
                                                    "name": "web",
                                                    "range": [
                                                        964,
                                                        994
                                                    ],
                                                    "children": [
                                                        {
                                                            "type": "ObjectLiteral",
                                                            "name": "",
                                                            "range": [
                                                                966,
                                                                994
                                                            ],
                                                            "children": [
                                                                {
                                                                    "type": "Property",
                                                                    "name": "client_id",
                                                                    "range": [
                                                                        968,
                                                                        972
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "MemberExpression",
                                                                            "name": "self.client_id",
                                                                            "range": [
                                                                                970,
                                                                                972
                                                                            ],
                                                                            "children": [],
                                                                            "content": "{\n\"client_id\""
                                                                        }
                                                                    ],
                                                                    "content": "\"web\":{\n\"client_id\""
                                                                },
                                                                {
                                                                    "type": "Property",
                                                                    "name": "client_secret",
                                                                    "range": [
                                                                        975,
                                                                        979
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "MemberExpression",
                                                                            "name": "self.client_secret",
                                                                            "range": [
                                                                                977,
                                                                                979
                                                                            ],
                                                                            "children": [],
                                                                            "content": ",\n\"client_secret\""
                                                                        }
                                                                    ],
                                                                    "content": ".client_id,\n\"client_secret\""
                                                                },
                                                                {
                                                                    "type": "Property",
                                                                    "name": "auth_uri",
                                                                    "range": [
                                                                        982,
                                                                        984
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "StringLiteral",
                                                                            "name": "https://accounts.google.com/o/oauth2/auth",
                                                                            "range": [
                                                                                984,
                                                                                984
                                                                            ],
                                                                            "children": [],
                                                                            "content": ","
                                                                        }
                                                                    ],
                                                                    "content": ".client_secret,"
                                                                },
                                                                {
                                                                    "type": "Property",
                                                                    "name": "token_uri",
                                                                    "range": [
                                                                        987,
                                                                        991
                                                                    ],
                                                                    "children": [
                                                                        {
                                                                            "type": "MemberExpression",
                                                                            "name": "self.token_uri",
                                                                            "range": [
                                                                                989,
                                                                                991
                                                                            ],
                                                                            "children": [],
                                                                            "content": ",\n\"token_uri\""
                                                                        }
                                                                    ],
                                                                    "content": ":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\""
                                                                }
                                                            ],
                                                            "content": "{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self."
                                                        }
                                                    ],
                                                    "content": "(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self."
                                                }
                                            ],
                                            "content": ".from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,"
                                        },
                                        {
                                            "type": "Argument",
                                            "name": "scopes",
                                            "range": [
                                                999,
                                                1001
                                            ],
                                            "children": [],
                                            "content": "\n},"
                                        }
                                    ],
                                    "content": "Flow:\nreturn Flow.from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,\n}\n},\nscopes="
                                }
                            ],
                            "content": ">Flow:\nreturn Flow.from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,\n}\n},\nscopes="
                        }
                    ],
                    "content": "->Flow:\nreturn Flow.from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,\n}\n},\nscopes=scopes,"
                }
            ],
            "content": "\n)\n\ndef _setup_oauth_flow(self,scopes:list[str])->Flow:\nreturn Flow.from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,\n}\n},\nscopes=scopes,"
        }
    ],
    "content": "import logging\n\nfrom google.auth.external_account_authorized_user import(\nCredentials as ExternalAccountCredentials,\n)\nfrom google.auth.transport.requests import AuthorizedSession,Request\nfrom google.oauth2.credentials import Credentials\nfrom google_auth_oauthlib.flow import Flow\nfrom pydantic import SecretStr\n\nfrom backend.data.model import OAuth2Credentials\nfrom backend.integrations.providers import ProviderName\n\nfrom.base import BaseOAuthHandler\n\nlogger=logging.getLogger(__name__)\n\n\n#--8<--[start:GoogleOAuthHandlerExample]\nclass GoogleOAuthHandler(BaseOAuthHandler):\n\"\"\" \\n     Based on the documentation at https://developers.google.com/identity/protocols/oauth2/web-server \\n     \"\"\"#noqa\n\nPROVIDER_NAME=ProviderName.GOOGLE\nEMAIL_ENDPOINT=\"https://www.googleapis.com/oauth2/v2/userinfo\"\nDEFAULT_SCOPES=[\n\"https://www.googleapis.com/auth/userinfo.email\",\n\"https://www.googleapis.com/auth/userinfo.profile\",\n\"openid\",\n]\n#--8<--[end:GoogleOAuthHandlerExample]\n\ndef __init__(self,client_id:str,client_secret:str,redirect_uri:str):\nself.client_id=client_id\nself.client_secret=client_secret\nself.redirect_uri=redirect_uri\nself.token_uri=\"https://oauth2.googleapis.com/token\"\nself.revoke_uri=\"https://oauth2.googleapis.com/revoke\"\n\ndef get_login_url(self,scopes:list[str],state:str)->str:\nall_scopes=list(set(scopes+self.DEFAULT_SCOPES))\nlogger.debug(f \"Setting up OAuth flow with scopes: {all_scopes}\")\nflow=self._setup_oauth_flow(all_scopes)\nflow.redirect_uri=self.redirect_uri\nauthorization_url,_=flow.authorization_url(\naccess_type=\"offline\",\ninclude_granted_scopes=\"true\",\nstate=state,\nprompt=\"consent\",\n)\nreturn authorization_url\n\ndef exchange_code_for_tokens(\nself,code:str,scopes:list[str]\n)->OAuth2Credentials:\nlogger.debug(f \"Exchanging code for tokens with scopes: {scopes}\")\n\n#Use the scopes from the initial request\nflow=self._setup_oauth_flow(scopes)\nflow.redirect_uri=self.redirect_uri\n\nlogger.debug(\"Fetching token from Google\")\n\n#Disable scope check in fetch_token\nflow.oauth2session.scope=None\ntoken=flow.fetch_token(code=code)\nlogger.debug(\"Token fetched successfully\")\n\n#Get the actual scopes granted by Google\ngranted_scopes:list[str]=token.get(\"scope\",[])\n\nlogger.debug(f \"Scopes granted by Google: {granted_scopes}\")\n\ngoogle_creds=flow.credentials\nlogger.debug(f \"Received credentials: {google_creds}\")\n\nlogger.debug(\"Requesting user email\")\nusername=self._request_email(google_creds)\nlogger.debug(f \"User email retrieved: {username}\")\n\nassert google_creds.token\nassert google_creds.refresh_token\nassert google_creds.expiry\nassert granted_scopes\n\n#Create OAuth2Credentials with the granted scopes\ncredentials=OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\ntitle=None,\nusername=username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=(SecretStr(google_creds.refresh_token)),\naccess_token_expires_at=(\nint(google_creds.expiry.timestamp())if google_creds.expiry else None\n),\nrefresh_token_expires_at=None,\nscopes=granted_scopes,\n)\nlogger.debug(\nf \"OAuth2Credentials object created successfully with scopes: {credentials.scopes}\"\n)\n\nreturn credentials\n\ndef revoke_tokens(self,credentials:OAuth2Credentials)->bool:\nsession=AuthorizedSession(credentials)\nsession.post(\nself.revoke_uri,\nparams={\"token\":credentials.access_token.get_secret_value()},\nheaders={\"content-type\":\"application/x-www-form-urlencoded\"},\n)\nreturn True\n\ndef _request_email(\nself,creds:Credentials|ExternalAccountCredentials\n)->str|None:\nsession=AuthorizedSession(creds)\nresponse=session.get(self.EMAIL_ENDPOINT)\nif not response.ok:\nlogger.error(\nf \"Failed to get user email. Status code: {response.status_code}\"\n)\nreturn None\nreturn response.json()[\"email\"]\n\ndef _refresh_tokens(self,credentials:OAuth2Credentials)->OAuth2Credentials:\n#Google credentials should ALWAYS have a refresh token\nassert credentials.refresh_token\n\ngoogle_creds=Credentials(\ntoken=credentials.access_token.get_secret_value(),\nrefresh_token=credentials.refresh_token.get_secret_value(),\ntoken_uri=self.token_uri,\nclient_id=self.client_id,\nclient_secret=self.client_secret,\nscopes=credentials.scopes,\n)\n#Google's OAuth library is poorly typed so we need some of these:\nassert google_creds.refresh_token\nassert google_creds.scopes\n\ngoogle_creds.refresh(Request())\nassert google_creds.expiry\n\nreturn OAuth2Credentials(\nprovider=self.PROVIDER_NAME,\nid=credentials.id,\ntitle=credentials.title,\nusername=credentials.username,\naccess_token=SecretStr(google_creds.token),\nrefresh_token=SecretStr(google_creds.refresh_token),\naccess_token_expires_at=int(google_creds.expiry.timestamp()),\nrefresh_token_expires_at=None,\nscopes=google_creds.scopes,\n)\n\ndef _setup_oauth_flow(self,scopes:list[str])->Flow:\nreturn Flow.from_client_config(\n{\n\"web\":{\n\"client_id\":self.client_id,\n\"client_secret\":self.client_secret,\n\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\n\"token_uri\":self.token_uri,\n}\n},\nscopes=scopes,"
}