从 函数工具 导入 装饰器
从 类型 导入 任意, 可调用, 连接, 协程, 参数规范, 类型变量, 强制转换

从 后端.数据.信用 导入 获取用户信用模型
从 后端.数据.执行 导入(
    执行结果,
    Redis执行事件总线,
    创建图执行,
    获取执行结果,
    获取未完成执行,
    获取最新执行,
    更新执行状态,
    更新图执行统计,
    更新节点执行统计,
    插入执行输入,
    插入执行输出,
)
从 后端.数据.图 导入 获取图, 获取节点
从 后端.数据.用户 导入(
    获取用户集成,
    获取用户元数据,
    更新用户集成,
    更新用户元数据,
)
从 后端.工具.服务 导入 应用服务, 暴露, 注册Pydantic序列化器
从 后端.工具.设置 导入 配置

P = 参数规范("P")
R = 类型变量("R")
配置 = 配置()

类 数据库管理器(应用服务):
    定义 __初始化__(自身):
        超级().__初始化__()
        自身.使用数据库 = 真
        自身.使用Redis = 真
        自身.事件队列 = Redis执行事件总线()

    @类方法
    定义 获取端口(类) -> 整数:
        返回 配置.数据库API端口

    @暴露
    定义 发送执行更新(自身, 执行结果: 执行结果):
        自身.事件队列.发布(执行结果)

    @静态方法
    定义 暴露运行并等待(
        函数: 可调用[P, 协程[无, 无, R]]
    ) -> 可调用[连接[对象, P], R]:
        @暴露
        @装饰器(函数)
        定义 包装器(自身, *参数: P.参数, **关键字参数: P.关键字参数) -> R:
            协程 = 函数(*参数, **关键字参数)
            结果 = 自身.运行并等待(协程)
            返回 结果

        # 为裸函数上的注解注册序列化器
        注册Pydantic序列化器(函数)

        返回 包装器