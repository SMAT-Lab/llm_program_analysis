{
  "nodes": [
    {
      "id": "1",
      "type": "block",
      "statements": [
        "import logging",
        "from typing import Optional, cast",
        "from autogpt_libs.auth.models import DEFAULT_USER_ID",
        "from fastapi import HTTPException",
        "from prisma import Json",
        "from prisma.models import User",
        "from backend.data.db import prisma",
        "from backend.data.model import UserIntegrations, UserMetadata, UserMetadataRaw",
        "from backend.util.encryption import JSONCryptor",
        "logger = logging.getLogger(__name__)",
        "async def get_or_create_user(user_data: dict) -> User:\n    user_id = user_data.get('sub')\n    if not user_id:\n        raise HTTPException(status_code=401, detail='User ID not found in token')\n    user_email = user_data.get('email')\n    if not user_email:\n        raise HTTPException(status_code=401, detail='Email not found in token')\n    user = await prisma.user.find_unique(where={'id': user_id})\n    if not user:\n        user = await prisma.user.create(data={'id': user_id, 'email': user_email, 'name': user_data.get('user_metadata', {}).get('name')})\n    return User.model_validate(user)",
        "user_id = user_data.get('sub')",
        "not user_id"
      ]
    },
    {
      "id": "2",
      "type": "block",
      "statements": [
        "raise HTTPException(status_code=401, detail='User ID not found in token')"
      ]
    },
    {
      "id": "3",
      "type": "block",
      "statements": []
    },
    {
      "id": "4",
      "type": "block",
      "statements": [
        "user_email = user_data.get('email')",
        "not user_email"
      ]
    },
    {
      "id": "5",
      "type": "block",
      "statements": [
        "raise HTTPException(status_code=401, detail='Email not found in token')"
      ]
    },
    {
      "id": "6",
      "type": "block",
      "statements": []
    },
    {
      "id": "7",
      "type": "block",
      "statements": [
        "user = await prisma.user.find_unique(where={'id': user_id})",
        "not user"
      ]
    },
    {
      "id": "8",
      "type": "block",
      "statements": [
        "user = await prisma.user.create(data={'id': user_id, 'email': user_email, 'name': user_data.get('user_metadata', {}).get('name')})"
      ]
    },
    {
      "id": "9",
      "type": "block",
      "statements": []
    },
    {
      "id": "10",
      "type": "block",
      "statements": [
        "return User.model_validate(user)"
      ]
    },
    {
      "id": "11",
      "type": "block",
      "statements": [
        "async def get_user_by_id(user_id: str) -> Optional[User]:\n    user = await prisma.user.find_unique(where={'id': user_id})\n    return User.model_validate(user) if user else None",
        "user = await prisma.user.find_unique(where={'id': user_id})",
        "return User.model_validate(user) if user else None"
      ]
    },
    {
      "id": "12",
      "type": "block",
      "statements": [
        "async def create_default_user() -> Optional[User]:\n    user = await prisma.user.find_unique(where={'id': DEFAULT_USER_ID})\n    if not user:\n        user = await prisma.user.create(data={'id': DEFAULT_USER_ID, 'email': 'default@example.com', 'name': 'Default User'})\n    return User.model_validate(user)",
        "user = await prisma.user.find_unique(where={'id': DEFAULT_USER_ID})",
        "not user"
      ]
    },
    {
      "id": "13",
      "type": "block",
      "statements": [
        "user = await prisma.user.create(data={'id': DEFAULT_USER_ID, 'email': 'default@example.com', 'name': 'Default User'})"
      ]
    },
    {
      "id": "14",
      "type": "block",
      "statements": []
    },
    {
      "id": "15",
      "type": "block",
      "statements": [
        "return User.model_validate(user)"
      ]
    },
    {
      "id": "16",
      "type": "block",
      "statements": [
        "async def get_user_metadata(user_id: str) -> UserMetadata:\n    user = await User.prisma().find_unique_or_raise(where={'id': user_id})\n    metadata = cast(UserMetadataRaw, user.metadata)\n    return UserMetadata.model_validate(metadata)",
        "user = await User.prisma().find_unique_or_raise(where={'id': user_id})",
        "metadata = cast(UserMetadataRaw, user.metadata)",
        "return UserMetadata.model_validate(metadata)"
      ]
    },
    {
      "id": "17",
      "type": "block",
      "statements": [
        "async def update_user_metadata(user_id: str, metadata: UserMetadata):\n    await User.prisma().update(where={'id': user_id}, data={'metadata': Json(metadata.model_dump())})",
        "await User.prisma().update(where={'id': user_id}, data={'metadata': Json(metadata.model_dump())})",
        "async def get_user_integrations(user_id: str) -> UserIntegrations:\n    user = await User.prisma().find_unique_or_raise(where={'id': user_id})\n    encrypted_integrations = user.integrations\n    if not encrypted_integrations:\n        return UserIntegrations()\n    else:\n        return UserIntegrations.model_validate(JSONCryptor().decrypt(encrypted_integrations))",
        "user = await User.prisma().find_unique_or_raise(where={'id': user_id})",
        "encrypted_integrations = user.integrations",
        "not encrypted_integrations"
      ]
    },
    {
      "id": "18",
      "type": "block",
      "statements": [
        "return UserIntegrations()"
      ]
    },
    {
      "id": "19",
      "type": "block",
      "statements": [
        "return UserIntegrations.model_validate(JSONCryptor().decrypt(encrypted_integrations))"
      ]
    },
    {
      "id": "20",
      "type": "block",
      "statements": [
        "async def update_user_integrations(user_id: str, data: UserIntegrations):\n    encrypted_data = JSONCryptor().encrypt(data.model_dump())\n    await User.prisma().update(where={'id': user_id}, data={'integrations': encrypted_data})",
        "encrypted_data = JSONCryptor().encrypt(data.model_dump())",
        "await User.prisma().update(where={'id': user_id}, data={'integrations': encrypted_data})",
        "async def migrate_and_encrypt_user_integrations():\n    \"\"\"Migrate integration credentials and OAuth states from metadata to integrations column.\"\"\"\n    users = await User.prisma().find_many(where={'metadata': {'path': ['integration_credentials'], 'not': Json({'a': 'yolo'})}})\n    logger.info(f'Migrating integration credentials for {len(users)} users')\n    for user in users:\n        raw_metadata = cast(UserMetadataRaw, user.metadata)\n        metadata = UserMetadata.model_validate(raw_metadata)\n        integrations = await get_user_integrations(user_id=user.id)\n        if metadata.integration_credentials and (not integrations.credentials):\n            integrations.credentials = metadata.integration_credentials\n        if metadata.integration_oauth_states:\n            integrations.oauth_states = metadata.integration_oauth_states\n        await update_user_integrations(user_id=user.id, data=integrations)\n        raw_metadata = dict(raw_metadata)\n        raw_metadata.pop('integration_credentials', None)\n        raw_metadata.pop('integration_oauth_states', None)\n        await User.prisma().update(where={'id': user.id}, data={'metadata': Json(raw_metadata)})",
        "'Migrate integration credentials and OAuth states from metadata to integrations column.'",
        "users = await User.prisma().find_many(where={'metadata': {'path': ['integration_credentials'], 'not': Json({'a': 'yolo'})}})",
        "logger.info(f'Migrating integration credentials for {len(users)} users')"
      ]
    },
    {
      "id": "21",
      "type": "block",
      "statements": [
        "user",
        "users"
      ]
    },
    {
      "id": "22",
      "type": "block",
      "statements": [
        "raw_metadata = cast(UserMetadataRaw, user.metadata)",
        "metadata = UserMetadata.model_validate(raw_metadata)",
        "integrations = await get_user_integrations(user_id=user.id)",
        "metadata.integration_credentials and (not integrations.credentials)"
      ]
    },
    {
      "id": "23",
      "type": "block",
      "statements": []
    },
    {
      "id": "24",
      "type": "block",
      "statements": [
        "integrations.credentials = metadata.integration_credentials"
      ]
    },
    {
      "id": "25",
      "type": "block",
      "statements": []
    },
    {
      "id": "26",
      "type": "block",
      "statements": [
        "metadata.integration_oauth_states"
      ]
    },
    {
      "id": "27",
      "type": "block",
      "statements": [
        "integrations.oauth_states = metadata.integration_oauth_states"
      ]
    },
    {
      "id": "28",
      "type": "block",
      "statements": []
    },
    {
      "id": "29",
      "type": "block",
      "statements": [
        "await update_user_integrations(user_id=user.id, data=integrations)",
        "raw_metadata = dict(raw_metadata)",
        "raw_metadata.pop('integration_credentials', None)",
        "raw_metadata.pop('integration_oauth_states', None)",
        "await User.prisma().update(where={'id': user.id}, data={'metadata': Json(raw_metadata)})"
      ]
    }
  ],
  "edges": [
    {
      "source": "1",
      "target": "2",
      "type": "true"
    },
    {
      "source": "1",
      "target": "3",
      "type": "false"
    },
    {
      "source": "2",
      "target": "4",
      "type": "next"
    },
    {
      "source": "3",
      "target": "4",
      "type": "next"
    },
    {
      "source": "4",
      "target": "5",
      "type": "true"
    },
    {
      "source": "4",
      "target": "6",
      "type": "false"
    },
    {
      "source": "5",
      "target": "7",
      "type": "next"
    },
    {
      "source": "6",
      "target": "7",
      "type": "next"
    },
    {
      "source": "7",
      "target": "8",
      "type": "true"
    },
    {
      "source": "7",
      "target": "9",
      "type": "false"
    },
    {
      "source": "8",
      "target": "10",
      "type": "next"
    },
    {
      "source": "9",
      "target": "10",
      "type": "next"
    },
    {
      "source": "12",
      "target": "13",
      "type": "true"
    },
    {
      "source": "12",
      "target": "14",
      "type": "false"
    },
    {
      "source": "13",
      "target": "15",
      "type": "next"
    },
    {
      "source": "14",
      "target": "15",
      "type": "next"
    },
    {
      "source": "17",
      "target": "18",
      "type": "true"
    },
    {
      "source": "17",
      "target": "19",
      "type": "false"
    },
    {
      "source": "20",
      "target": "21",
      "type": "next"
    },
    {
      "source": "21",
      "target": "22",
      "type": "true"
    },
    {
      "source": "21",
      "target": "23",
      "type": "false"
    },
    {
      "source": "22",
      "target": "24",
      "type": "true"
    },
    {
      "source": "22",
      "target": "25",
      "type": "false"
    },
    {
      "source": "24",
      "target": "26",
      "type": "next"
    },
    {
      "source": "25",
      "target": "26",
      "type": "next"
    },
    {
      "source": "26",
      "target": "27",
      "type": "true"
    },
    {
      "source": "26",
      "target": "28",
      "type": "false"
    },
    {
      "source": "27",
      "target": "29",
      "type": "next"
    },
    {
      "source": "28",
      "target": "29",
      "type": "next"
    },
    {
      "source": "29",
      "target": "21",
      "type": "next"
    }
  ]
}