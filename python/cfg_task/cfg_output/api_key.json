{
  "nodes": [
    {
      "id": "1",
      "type": "block",
      "statements": [
        "import logging",
        "import uuid",
        "from datetime import datetime, timezone",
        "from typing import List, Optional",
        "from autogpt_libs.api_key.key_manager import APIKeyManager",
        "from prisma.enums import APIKeyPermission, APIKeyStatus",
        "from prisma.errors import PrismaError",
        "from prisma.models import APIKey as PrismaAPIKey",
        "from prisma.types import APIKeyCreateInput, APIKeyUpdateInput, APIKeyWhereInput, APIKeyWhereUniqueInput",
        "from pydantic import BaseModel",
        "from backend.data.db import BaseDbModel",
        "logger = logging.getLogger(__name__)",
        "class APIKeyError(Exception):\n    \"\"\"Base exception for API key operations\"\"\"\n    pass",
        "'Base exception for API key operations'",
        "pass",
        "class APIKeyNotFoundError(APIKeyError):\n    \"\"\"Raised when an API key is not found\"\"\"\n    pass",
        "'Raised when an API key is not found'",
        "pass",
        "class APIKeyPermissionError(APIKeyError):\n    \"\"\"Raised when there are permission issues with API key operations\"\"\"\n    pass",
        "'Raised when there are permission issues with API key operations'",
        "pass",
        "class APIKeyValidationError(APIKeyError):\n    \"\"\"Raised when API key validation fails\"\"\"\n    pass",
        "'Raised when API key validation fails'",
        "pass",
        "class APIKey(BaseDbModel):\n    name: str\n    prefix: str\n    key: str\n    status: APIKeyStatus = APIKeyStatus.ACTIVE\n    permissions: List[APIKeyPermission]\n    postfix: str\n    created_at: datetime\n    last_used_at: Optional[datetime] = None\n    revoked_at: Optional[datetime] = None\n    description: Optional[str] = None\n    user_id: str\n\n    @staticmethod\n    def from_db(api_key: PrismaAPIKey):\n        try:\n            return APIKey(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, key=api_key.key, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\n        except Exception as e:\n            logger.error(f'Error creating APIKey from db: {str(e)}')\n            raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "name: str",
        "prefix: str",
        "key: str",
        "status: APIKeyStatus = APIKeyStatus.ACTIVE",
        "permissions: List[APIKeyPermission]",
        "postfix: str",
        "created_at: datetime",
        "last_used_at: Optional[datetime] = None",
        "revoked_at: Optional[datetime] = None",
        "description: Optional[str] = None",
        "user_id: str",
        "@staticmethod\ndef from_db(api_key: PrismaAPIKey):\n    try:\n        return APIKey(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, key=api_key.key, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\n    except Exception as e:\n        logger.error(f'Error creating APIKey from db: {str(e)}')\n        raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "try:\n    return APIKey(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, key=api_key.key, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\nexcept Exception as e:\n    logger.error(f'Error creating APIKey from db: {str(e)}')\n    raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "return APIKey(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, key=api_key.key, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)"
      ]
    },
    {
      "id": "2",
      "type": "block",
      "statements": [
        "logger.error(f'Error creating APIKey from db: {str(e)}')",
        "raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "class APIKeyWithoutHash(BaseModel):\n    id: str\n    name: str\n    prefix: str\n    postfix: str\n    status: APIKeyStatus\n    permissions: List[APIKeyPermission]\n    created_at: datetime\n    last_used_at: Optional[datetime]\n    revoked_at: Optional[datetime]\n    description: Optional[str]\n    user_id: str\n\n    @staticmethod\n    def from_db(api_key: PrismaAPIKey):\n        try:\n            return APIKeyWithoutHash(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\n        except Exception as e:\n            logger.error(f'Error creating APIKeyWithoutHash from db: {str(e)}')\n            raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "id: str",
        "name: str",
        "prefix: str",
        "postfix: str",
        "status: APIKeyStatus",
        "permissions: List[APIKeyPermission]",
        "created_at: datetime",
        "last_used_at: Optional[datetime]",
        "revoked_at: Optional[datetime]",
        "description: Optional[str]",
        "user_id: str",
        "@staticmethod\ndef from_db(api_key: PrismaAPIKey):\n    try:\n        return APIKeyWithoutHash(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\n    except Exception as e:\n        logger.error(f'Error creating APIKeyWithoutHash from db: {str(e)}')\n        raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "try:\n    return APIKeyWithoutHash(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)\nexcept Exception as e:\n    logger.error(f'Error creating APIKeyWithoutHash from db: {str(e)}')\n    raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "return APIKeyWithoutHash(id=api_key.id, name=api_key.name, prefix=api_key.prefix, postfix=api_key.postfix, status=APIKeyStatus(api_key.status), permissions=[APIKeyPermission(p) for p in api_key.permissions], created_at=api_key.createdAt, last_used_at=api_key.lastUsedAt, revoked_at=api_key.revokedAt, description=api_key.description, user_id=api_key.userId)"
      ]
    },
    {
      "id": "3",
      "type": "block",
      "statements": [
        "logger.error(f'Error creating APIKeyWithoutHash from db: {str(e)}')",
        "raise APIKeyError(f'Failed to create API key object: {str(e)}')",
        "async def generate_api_key(name: str, user_id: str, permissions: List[APIKeyPermission], description: Optional[str]=None) -> tuple[APIKeyWithoutHash, str]:\n    \"\"\"\n    Generate a new API key and store it in the database.\n    Returns the API key object (without hash) and the plain text key.\n    \"\"\"\n    try:\n        api_manager = APIKeyManager()\n        key = api_manager.generate_api_key()\n        api_key = await PrismaAPIKey.prisma().create(data=APIKeyCreateInput(id=str(uuid.uuid4()), name=name, prefix=key.prefix, postfix=key.postfix, key=key.hash, permissions=[p for p in permissions], description=description, userId=user_id))\n        api_key_without_hash = APIKeyWithoutHash.from_db(api_key)\n        return (api_key_without_hash, key.raw)\n    except PrismaError as e:\n        logger.error(f'Database error while generating API key: {str(e)}')\n        raise APIKeyError(f'Failed to generate API key: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while generating API key: {str(e)}')\n        raise APIKeyError(f'Failed to generate API key: {str(e)}')",
        "'\\n    Generate a new API key and store it in the database.\\n    Returns the API key object (without hash) and the plain text key.\\n    '",
        "try:\n    api_manager = APIKeyManager()\n    key = api_manager.generate_api_key()\n    api_key = await PrismaAPIKey.prisma().create(data=APIKeyCreateInput(id=str(uuid.uuid4()), name=name, prefix=key.prefix, postfix=key.postfix, key=key.hash, permissions=[p for p in permissions], description=description, userId=user_id))\n    api_key_without_hash = APIKeyWithoutHash.from_db(api_key)\n    return (api_key_without_hash, key.raw)\nexcept PrismaError as e:\n    logger.error(f'Database error while generating API key: {str(e)}')\n    raise APIKeyError(f'Failed to generate API key: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while generating API key: {str(e)}')\n    raise APIKeyError(f'Failed to generate API key: {str(e)}')",
        "api_manager = APIKeyManager()",
        "key = api_manager.generate_api_key()",
        "api_key = await PrismaAPIKey.prisma().create(data=APIKeyCreateInput(id=str(uuid.uuid4()), name=name, prefix=key.prefix, postfix=key.postfix, key=key.hash, permissions=[p for p in permissions], description=description, userId=user_id))",
        "api_key_without_hash = APIKeyWithoutHash.from_db(api_key)",
        "return (api_key_without_hash, key.raw)"
      ]
    },
    {
      "id": "4",
      "type": "block",
      "statements": [
        "logger.error(f'Database error while generating API key: {str(e)}')",
        "raise APIKeyError(f'Failed to generate API key: {str(e)}')",
        "logger.error(f'Unexpected error while generating API key: {str(e)}')",
        "raise APIKeyError(f'Failed to generate API key: {str(e)}')",
        "async def validate_api_key(plain_text_key: str) -> Optional[APIKey]:\n    \"\"\"\n    Validate an API key and return the API key object if valid.\n    \"\"\"\n    try:\n        if not plain_text_key.startswith(APIKeyManager.PREFIX):\n            logger.warning('Invalid API key format')\n            return None\n        prefix = plain_text_key[:APIKeyManager.PREFIX_LENGTH]\n        api_manager = APIKeyManager()\n        api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(prefix=prefix, status=APIKeyStatus.ACTIVE))\n        if not api_key:\n            logger.warning(f'No active API key found with prefix {prefix}')\n            return None\n        is_valid = api_manager.verify_api_key(plain_text_key, api_key.key)\n        if not is_valid:\n            logger.warning('API key verification failed')\n            return None\n        return APIKey.from_db(api_key)\n    except Exception as e:\n        logger.error(f'Error validating API key: {str(e)}')\n        raise APIKeyValidationError(f'Failed to validate API key: {str(e)}')",
        "'\\n    Validate an API key and return the API key object if valid.\\n    '",
        "try:\n    if not plain_text_key.startswith(APIKeyManager.PREFIX):\n        logger.warning('Invalid API key format')\n        return None\n    prefix = plain_text_key[:APIKeyManager.PREFIX_LENGTH]\n    api_manager = APIKeyManager()\n    api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(prefix=prefix, status=APIKeyStatus.ACTIVE))\n    if not api_key:\n        logger.warning(f'No active API key found with prefix {prefix}')\n        return None\n    is_valid = api_manager.verify_api_key(plain_text_key, api_key.key)\n    if not is_valid:\n        logger.warning('API key verification failed')\n        return None\n    return APIKey.from_db(api_key)\nexcept Exception as e:\n    logger.error(f'Error validating API key: {str(e)}')\n    raise APIKeyValidationError(f'Failed to validate API key: {str(e)}')",
        "not plain_text_key.startswith(APIKeyManager.PREFIX)"
      ]
    },
    {
      "id": "5",
      "type": "block",
      "statements": [
        "logger.warning('Invalid API key format')",
        "return None"
      ]
    },
    {
      "id": "6",
      "type": "block",
      "statements": []
    },
    {
      "id": "7",
      "type": "block",
      "statements": [
        "prefix = plain_text_key[:APIKeyManager.PREFIX_LENGTH]",
        "api_manager = APIKeyManager()",
        "api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(prefix=prefix, status=APIKeyStatus.ACTIVE))",
        "not api_key"
      ]
    },
    {
      "id": "8",
      "type": "block",
      "statements": [
        "logger.warning(f'No active API key found with prefix {prefix}')",
        "return None"
      ]
    },
    {
      "id": "9",
      "type": "block",
      "statements": []
    },
    {
      "id": "10",
      "type": "block",
      "statements": [
        "is_valid = api_manager.verify_api_key(plain_text_key, api_key.key)",
        "not is_valid"
      ]
    },
    {
      "id": "11",
      "type": "block",
      "statements": [
        "logger.warning('API key verification failed')",
        "return None"
      ]
    },
    {
      "id": "12",
      "type": "block",
      "statements": []
    },
    {
      "id": "13",
      "type": "block",
      "statements": [
        "return APIKey.from_db(api_key)"
      ]
    },
    {
      "id": "14",
      "type": "block",
      "statements": [
        "logger.error(f'Error validating API key: {str(e)}')",
        "raise APIKeyValidationError(f'Failed to validate API key: {str(e)}')",
        "async def revoke_api_key(key_id: str, user_id: str) -> Optional[APIKeyWithoutHash]:\n    try:\n        api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n        if not api_key:\n            raise APIKeyNotFoundError(f'API key with id {key_id} not found')\n        if api_key.userId != user_id:\n            raise APIKeyPermissionError('You do not have permission to revoke this API key.')\n        where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n        updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.REVOKED, revokedAt=datetime.now(timezone.utc)))\n        if updated_api_key:\n            return APIKeyWithoutHash.from_db(updated_api_key)\n        return None\n    except (APIKeyNotFoundError, APIKeyPermissionError) as e:\n        raise e\n    except PrismaError as e:\n        logger.error(f'Database error while revoking API key: {str(e)}')\n        raise APIKeyError(f'Failed to revoke API key: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while revoking API key: {str(e)}')\n        raise APIKeyError(f'Failed to revoke API key: {str(e)}')",
        "try:\n    api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n    if not api_key:\n        raise APIKeyNotFoundError(f'API key with id {key_id} not found')\n    if api_key.userId != user_id:\n        raise APIKeyPermissionError('You do not have permission to revoke this API key.')\n    where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n    updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.REVOKED, revokedAt=datetime.now(timezone.utc)))\n    if updated_api_key:\n        return APIKeyWithoutHash.from_db(updated_api_key)\n    return None\nexcept (APIKeyNotFoundError, APIKeyPermissionError) as e:\n    raise e\nexcept PrismaError as e:\n    logger.error(f'Database error while revoking API key: {str(e)}')\n    raise APIKeyError(f'Failed to revoke API key: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while revoking API key: {str(e)}')\n    raise APIKeyError(f'Failed to revoke API key: {str(e)}')",
        "api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})",
        "not api_key"
      ]
    },
    {
      "id": "15",
      "type": "block",
      "statements": [
        "raise APIKeyNotFoundError(f'API key with id {key_id} not found')"
      ]
    },
    {
      "id": "16",
      "type": "block",
      "statements": []
    },
    {
      "id": "17",
      "type": "block",
      "statements": [
        "api_key.userId NotEq user_id"
      ]
    },
    {
      "id": "18",
      "type": "block",
      "statements": [
        "raise APIKeyPermissionError('You do not have permission to revoke this API key.')"
      ]
    },
    {
      "id": "19",
      "type": "block",
      "statements": []
    },
    {
      "id": "20",
      "type": "block",
      "statements": [
        "where_clause: APIKeyWhereUniqueInput = {'id': key_id}",
        "updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.REVOKED, revokedAt=datetime.now(timezone.utc)))",
        "updated_api_key"
      ]
    },
    {
      "id": "21",
      "type": "block",
      "statements": [
        "return APIKeyWithoutHash.from_db(updated_api_key)"
      ]
    },
    {
      "id": "22",
      "type": "block",
      "statements": []
    },
    {
      "id": "23",
      "type": "block",
      "statements": [
        "return None"
      ]
    },
    {
      "id": "24",
      "type": "block",
      "statements": [
        "raise e",
        "logger.error(f'Database error while revoking API key: {str(e)}')",
        "raise APIKeyError(f'Failed to revoke API key: {str(e)}')",
        "logger.error(f'Unexpected error while revoking API key: {str(e)}')",
        "raise APIKeyError(f'Failed to revoke API key: {str(e)}')",
        "async def list_user_api_keys(user_id: str) -> List[APIKeyWithoutHash]:\n    try:\n        where_clause: APIKeyWhereInput = {'userId': user_id}\n        api_keys = await PrismaAPIKey.prisma().find_many(where=where_clause, order={'createdAt': 'desc'})\n        return [APIKeyWithoutHash.from_db(key) for key in api_keys]\n    except PrismaError as e:\n        logger.error(f'Database error while listing API keys: {str(e)}')\n        raise APIKeyError(f'Failed to list API keys: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while listing API keys: {str(e)}')\n        raise APIKeyError(f'Failed to list API keys: {str(e)}')",
        "try:\n    where_clause: APIKeyWhereInput = {'userId': user_id}\n    api_keys = await PrismaAPIKey.prisma().find_many(where=where_clause, order={'createdAt': 'desc'})\n    return [APIKeyWithoutHash.from_db(key) for key in api_keys]\nexcept PrismaError as e:\n    logger.error(f'Database error while listing API keys: {str(e)}')\n    raise APIKeyError(f'Failed to list API keys: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while listing API keys: {str(e)}')\n    raise APIKeyError(f'Failed to list API keys: {str(e)}')",
        "where_clause: APIKeyWhereInput = {'userId': user_id}",
        "api_keys = await PrismaAPIKey.prisma().find_many(where=where_clause, order={'createdAt': 'desc'})",
        "return [APIKeyWithoutHash.from_db(key) for key in api_keys]"
      ]
    },
    {
      "id": "25",
      "type": "block",
      "statements": [
        "logger.error(f'Database error while listing API keys: {str(e)}')",
        "raise APIKeyError(f'Failed to list API keys: {str(e)}')",
        "logger.error(f'Unexpected error while listing API keys: {str(e)}')",
        "raise APIKeyError(f'Failed to list API keys: {str(e)}')",
        "async def suspend_api_key(key_id: str, user_id: str) -> Optional[APIKeyWithoutHash]:\n    try:\n        api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n        if not api_key:\n            raise APIKeyNotFoundError(f'API key with id {key_id} not found')\n        if api_key.userId != user_id:\n            raise APIKeyPermissionError('You do not have permission to suspend this API key.')\n        where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n        updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.SUSPENDED))\n        if updated_api_key:\n            return APIKeyWithoutHash.from_db(updated_api_key)\n        return None\n    except (APIKeyNotFoundError, APIKeyPermissionError) as e:\n        raise e\n    except PrismaError as e:\n        logger.error(f'Database error while suspending API key: {str(e)}')\n        raise APIKeyError(f'Failed to suspend API key: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while suspending API key: {str(e)}')\n        raise APIKeyError(f'Failed to suspend API key: {str(e)}')",
        "try:\n    api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n    if not api_key:\n        raise APIKeyNotFoundError(f'API key with id {key_id} not found')\n    if api_key.userId != user_id:\n        raise APIKeyPermissionError('You do not have permission to suspend this API key.')\n    where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n    updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.SUSPENDED))\n    if updated_api_key:\n        return APIKeyWithoutHash.from_db(updated_api_key)\n    return None\nexcept (APIKeyNotFoundError, APIKeyPermissionError) as e:\n    raise e\nexcept PrismaError as e:\n    logger.error(f'Database error while suspending API key: {str(e)}')\n    raise APIKeyError(f'Failed to suspend API key: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while suspending API key: {str(e)}')\n    raise APIKeyError(f'Failed to suspend API key: {str(e)}')",
        "api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})",
        "not api_key"
      ]
    },
    {
      "id": "26",
      "type": "block",
      "statements": [
        "raise APIKeyNotFoundError(f'API key with id {key_id} not found')"
      ]
    },
    {
      "id": "27",
      "type": "block",
      "statements": []
    },
    {
      "id": "28",
      "type": "block",
      "statements": [
        "api_key.userId NotEq user_id"
      ]
    },
    {
      "id": "29",
      "type": "block",
      "statements": [
        "raise APIKeyPermissionError('You do not have permission to suspend this API key.')"
      ]
    },
    {
      "id": "30",
      "type": "block",
      "statements": []
    },
    {
      "id": "31",
      "type": "block",
      "statements": [
        "where_clause: APIKeyWhereUniqueInput = {'id': key_id}",
        "updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(status=APIKeyStatus.SUSPENDED))",
        "updated_api_key"
      ]
    },
    {
      "id": "32",
      "type": "block",
      "statements": [
        "return APIKeyWithoutHash.from_db(updated_api_key)"
      ]
    },
    {
      "id": "33",
      "type": "block",
      "statements": []
    },
    {
      "id": "34",
      "type": "block",
      "statements": [
        "return None"
      ]
    },
    {
      "id": "35",
      "type": "block",
      "statements": [
        "raise e",
        "logger.error(f'Database error while suspending API key: {str(e)}')",
        "raise APIKeyError(f'Failed to suspend API key: {str(e)}')",
        "logger.error(f'Unexpected error while suspending API key: {str(e)}')",
        "raise APIKeyError(f'Failed to suspend API key: {str(e)}')",
        "def has_permission(api_key: APIKey, required_permission: APIKeyPermission) -> bool:\n    try:\n        return required_permission in api_key.permissions\n    except Exception as e:\n        logger.error(f'Error checking API key permissions: {str(e)}')\n        return False",
        "try:\n    return required_permission in api_key.permissions\nexcept Exception as e:\n    logger.error(f'Error checking API key permissions: {str(e)}')\n    return False",
        "return required_permission in api_key.permissions"
      ]
    },
    {
      "id": "36",
      "type": "block",
      "statements": [
        "logger.error(f'Error checking API key permissions: {str(e)}')",
        "return False"
      ]
    },
    {
      "id": "37",
      "type": "block",
      "statements": [
        "async def get_api_key_by_id(key_id: str, user_id: str) -> Optional[APIKeyWithoutHash]:\n    try:\n        api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(id=key_id, userId=user_id))\n        if not api_key:\n            return None\n        return APIKeyWithoutHash.from_db(api_key)\n    except PrismaError as e:\n        logger.error(f'Database error while getting API key: {str(e)}')\n        raise APIKeyError(f'Failed to get API key: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while getting API key: {str(e)}')\n        raise APIKeyError(f'Failed to get API key: {str(e)}')",
        "try:\n    api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(id=key_id, userId=user_id))\n    if not api_key:\n        return None\n    return APIKeyWithoutHash.from_db(api_key)\nexcept PrismaError as e:\n    logger.error(f'Database error while getting API key: {str(e)}')\n    raise APIKeyError(f'Failed to get API key: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while getting API key: {str(e)}')\n    raise APIKeyError(f'Failed to get API key: {str(e)}')",
        "api_key = await PrismaAPIKey.prisma().find_first(where=APIKeyWhereInput(id=key_id, userId=user_id))",
        "not api_key"
      ]
    },
    {
      "id": "38",
      "type": "block",
      "statements": [
        "return None"
      ]
    },
    {
      "id": "39",
      "type": "block",
      "statements": []
    },
    {
      "id": "40",
      "type": "block",
      "statements": [
        "return APIKeyWithoutHash.from_db(api_key)"
      ]
    },
    {
      "id": "41",
      "type": "block",
      "statements": [
        "logger.error(f'Database error while getting API key: {str(e)}')",
        "raise APIKeyError(f'Failed to get API key: {str(e)}')",
        "logger.error(f'Unexpected error while getting API key: {str(e)}')",
        "raise APIKeyError(f'Failed to get API key: {str(e)}')",
        "async def update_api_key_permissions(key_id: str, user_id: str, permissions: List[APIKeyPermission]) -> Optional[APIKeyWithoutHash]:\n    \"\"\"\n    Update the permissions of an API key.\n    \"\"\"\n    try:\n        api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n        if api_key is None:\n            raise APIKeyNotFoundError('No such API key found.')\n        if api_key.userId != user_id:\n            raise APIKeyPermissionError('You do not have permission to update this API key.')\n        where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n        updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(permissions=permissions))\n        if updated_api_key:\n            return APIKeyWithoutHash.from_db(updated_api_key)\n        return None\n    except (APIKeyNotFoundError, APIKeyPermissionError) as e:\n        raise e\n    except PrismaError as e:\n        logger.error(f'Database error while updating API key permissions: {str(e)}')\n        raise APIKeyError(f'Failed to update API key permissions: {str(e)}')\n    except Exception as e:\n        logger.error(f'Unexpected error while updating API key permissions: {str(e)}')\n        raise APIKeyError(f'Failed to update API key permissions: {str(e)}')",
        "'\\n    Update the permissions of an API key.\\n    '",
        "try:\n    api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})\n    if api_key is None:\n        raise APIKeyNotFoundError('No such API key found.')\n    if api_key.userId != user_id:\n        raise APIKeyPermissionError('You do not have permission to update this API key.')\n    where_clause: APIKeyWhereUniqueInput = {'id': key_id}\n    updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(permissions=permissions))\n    if updated_api_key:\n        return APIKeyWithoutHash.from_db(updated_api_key)\n    return None\nexcept (APIKeyNotFoundError, APIKeyPermissionError) as e:\n    raise e\nexcept PrismaError as e:\n    logger.error(f'Database error while updating API key permissions: {str(e)}')\n    raise APIKeyError(f'Failed to update API key permissions: {str(e)}')\nexcept Exception as e:\n    logger.error(f'Unexpected error while updating API key permissions: {str(e)}')\n    raise APIKeyError(f'Failed to update API key permissions: {str(e)}')",
        "api_key = await PrismaAPIKey.prisma().find_unique(where={'id': key_id})",
        "api_key Is None"
      ]
    },
    {
      "id": "42",
      "type": "block",
      "statements": [
        "raise APIKeyNotFoundError('No such API key found.')"
      ]
    },
    {
      "id": "43",
      "type": "block",
      "statements": []
    },
    {
      "id": "44",
      "type": "block",
      "statements": [
        "api_key.userId NotEq user_id"
      ]
    },
    {
      "id": "45",
      "type": "block",
      "statements": [
        "raise APIKeyPermissionError('You do not have permission to update this API key.')"
      ]
    },
    {
      "id": "46",
      "type": "block",
      "statements": []
    },
    {
      "id": "47",
      "type": "block",
      "statements": [
        "where_clause: APIKeyWhereUniqueInput = {'id': key_id}",
        "updated_api_key = await PrismaAPIKey.prisma().update(where=where_clause, data=APIKeyUpdateInput(permissions=permissions))",
        "updated_api_key"
      ]
    },
    {
      "id": "48",
      "type": "block",
      "statements": [
        "return APIKeyWithoutHash.from_db(updated_api_key)"
      ]
    },
    {
      "id": "49",
      "type": "block",
      "statements": []
    },
    {
      "id": "50",
      "type": "block",
      "statements": [
        "return None"
      ]
    },
    {
      "id": "51",
      "type": "block",
      "statements": [
        "raise e",
        "logger.error(f'Database error while updating API key permissions: {str(e)}')",
        "raise APIKeyError(f'Failed to update API key permissions: {str(e)}')",
        "logger.error(f'Unexpected error while updating API key permissions: {str(e)}')",
        "raise APIKeyError(f'Failed to update API key permissions: {str(e)}')"
      ]
    }
  ],
  "edges": [
    {
      "source": "4",
      "target": "5",
      "type": "true"
    },
    {
      "source": "4",
      "target": "6",
      "type": "false"
    },
    {
      "source": "6",
      "target": "7",
      "type": "next"
    },
    {
      "source": "7",
      "target": "8",
      "type": "true"
    },
    {
      "source": "7",
      "target": "9",
      "type": "false"
    },
    {
      "source": "9",
      "target": "10",
      "type": "next"
    },
    {
      "source": "10",
      "target": "11",
      "type": "true"
    },
    {
      "source": "10",
      "target": "12",
      "type": "false"
    },
    {
      "source": "12",
      "target": "13",
      "type": "next"
    },
    {
      "source": "14",
      "target": "15",
      "type": "true"
    },
    {
      "source": "14",
      "target": "16",
      "type": "false"
    },
    {
      "source": "15",
      "target": "17",
      "type": "next"
    },
    {
      "source": "16",
      "target": "17",
      "type": "next"
    },
    {
      "source": "17",
      "target": "18",
      "type": "true"
    },
    {
      "source": "17",
      "target": "19",
      "type": "false"
    },
    {
      "source": "18",
      "target": "20",
      "type": "next"
    },
    {
      "source": "19",
      "target": "20",
      "type": "next"
    },
    {
      "source": "20",
      "target": "21",
      "type": "true"
    },
    {
      "source": "20",
      "target": "22",
      "type": "false"
    },
    {
      "source": "22",
      "target": "23",
      "type": "next"
    },
    {
      "source": "25",
      "target": "26",
      "type": "true"
    },
    {
      "source": "25",
      "target": "27",
      "type": "false"
    },
    {
      "source": "26",
      "target": "28",
      "type": "next"
    },
    {
      "source": "27",
      "target": "28",
      "type": "next"
    },
    {
      "source": "28",
      "target": "29",
      "type": "true"
    },
    {
      "source": "28",
      "target": "30",
      "type": "false"
    },
    {
      "source": "29",
      "target": "31",
      "type": "next"
    },
    {
      "source": "30",
      "target": "31",
      "type": "next"
    },
    {
      "source": "31",
      "target": "32",
      "type": "true"
    },
    {
      "source": "31",
      "target": "33",
      "type": "false"
    },
    {
      "source": "33",
      "target": "34",
      "type": "next"
    },
    {
      "source": "37",
      "target": "38",
      "type": "true"
    },
    {
      "source": "37",
      "target": "39",
      "type": "false"
    },
    {
      "source": "39",
      "target": "40",
      "type": "next"
    },
    {
      "source": "41",
      "target": "42",
      "type": "true"
    },
    {
      "source": "41",
      "target": "43",
      "type": "false"
    },
    {
      "source": "42",
      "target": "44",
      "type": "next"
    },
    {
      "source": "43",
      "target": "44",
      "type": "next"
    },
    {
      "source": "44",
      "target": "45",
      "type": "true"
    },
    {
      "source": "44",
      "target": "46",
      "type": "false"
    },
    {
      "source": "45",
      "target": "47",
      "type": "next"
    },
    {
      "source": "46",
      "target": "47",
      "type": "next"
    },
    {
      "source": "47",
      "target": "48",
      "type": "true"
    },
    {
      "source": "47",
      "target": "49",
      "type": "false"
    },
    {
      "source": "49",
      "target": "50",
      "type": "next"
    }
  ]
}