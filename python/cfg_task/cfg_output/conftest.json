{
  "nodes": [
    {
      "id": "1",
      "type": "block",
      "statements": [
        "import logging",
        "import pytest",
        "from backend.util.test import SpinTestServer",
        "logger = logging.getLogger(__name__)",
        "ch = logging.StreamHandler()",
        "ch.setLevel(logging.INFO)",
        "formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')",
        "ch.setFormatter(formatter)",
        "logger.addHandler(ch)",
        "@pytest.fixture(scope='session')\nasync def server():\n    async with SpinTestServer() as server:\n        yield server",
        "async with SpinTestServer() as server:\n    yield server",
        "(yield server)",
        "@pytest.fixture(scope='session', autouse=True)\nasync def graph_cleanup(server):\n    created_graph_ids = []\n    original_create_graph = server.agent_server.test_create_graph\n\n    async def create_graph_wrapper(*args, **kwargs):\n        created_graph = await original_create_graph(*args, **kwargs)\n        user_id = kwargs.get('user_id', args[2] if len(args) > 2 else None)\n        created_graph_ids.append((created_graph.id, user_id))\n        return created_graph\n    try:\n        server.agent_server.test_create_graph = create_graph_wrapper\n        yield\n    finally:\n        server.agent_server.test_create_graph = original_create_graph\n        for (graph_id, user_id) in created_graph_ids:\n            if user_id:\n                resp = await server.agent_server.test_delete_graph(graph_id, user_id)\n                num_deleted = resp['version_counts']\n                assert num_deleted > 0, f'Graph {graph_id} was not deleted.'",
        "created_graph_ids = []",
        "original_create_graph = server.agent_server.test_create_graph",
        "async def create_graph_wrapper(*args, **kwargs):\n    created_graph = await original_create_graph(*args, **kwargs)\n    user_id = kwargs.get('user_id', args[2] if len(args) > 2 else None)\n    created_graph_ids.append((created_graph.id, user_id))\n    return created_graph",
        "created_graph = await original_create_graph(*args, **kwargs)",
        "user_id = kwargs.get('user_id', args[2] if len(args) > 2 else None)",
        "created_graph_ids.append((created_graph.id, user_id))",
        "return created_graph"
      ]
    },
    {
      "id": "2",
      "type": "block",
      "statements": [
        "try:\n    server.agent_server.test_create_graph = create_graph_wrapper\n    yield\nfinally:\n    server.agent_server.test_create_graph = original_create_graph\n    for (graph_id, user_id) in created_graph_ids:\n        if user_id:\n            resp = await server.agent_server.test_delete_graph(graph_id, user_id)\n            num_deleted = resp['version_counts']\n            assert num_deleted > 0, f'Graph {graph_id} was not deleted.'",
        "server.agent_server.test_create_graph = create_graph_wrapper",
        "(yield)",
        "server.agent_server.test_create_graph = original_create_graph"
      ]
    },
    {
      "id": "3",
      "type": "block",
      "statements": [
        "(graph_id, user_id)",
        "created_graph_ids"
      ]
    },
    {
      "id": "4",
      "type": "block",
      "statements": [
        "user_id"
      ]
    },
    {
      "id": "5",
      "type": "block",
      "statements": []
    },
    {
      "id": "6",
      "type": "block",
      "statements": [
        "resp = await server.agent_server.test_delete_graph(graph_id, user_id)",
        "num_deleted = resp['version_counts']",
        "assert num_deleted > 0, f'Graph {graph_id} was not deleted.'"
      ]
    },
    {
      "id": "7",
      "type": "block",
      "statements": []
    },
    {
      "id": "8",
      "type": "block",
      "statements": []
    }
  ],
  "edges": [
    {
      "source": "2",
      "target": "3",
      "type": "next"
    },
    {
      "source": "3",
      "target": "4",
      "type": "true"
    },
    {
      "source": "3",
      "target": "5",
      "type": "false"
    },
    {
      "source": "4",
      "target": "6",
      "type": "true"
    },
    {
      "source": "4",
      "target": "7",
      "type": "false"
    },
    {
      "source": "6",
      "target": "8",
      "type": "next"
    },
    {
      "source": "7",
      "target": "8",
      "type": "next"
    },
    {
      "source": "8",
      "target": "3",
      "type": "next"
    }
  ]
}