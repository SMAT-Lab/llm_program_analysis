{
    "nodes": [
        {
            "id": "chunk_0_GlobalBlock_1",
            "code": "from datetime import datetime\n"
        },
        {
            "id": "chunk_0_GlobalBlock_2",
            "code": "import pytest\n"
        },
        {
            "id": "chunk_0_GlobalBlock_3",
            "code": "from prisma.models import CreditTransaction\n"
        },
        {
            "id": "chunk_0_GlobalBlock_4",
            "code": "from backend.blocks.llm import AITextGeneratorBlock\n"
        },
        {
            "id": "chunk_0_GlobalBlock_5",
            "code": "from backend.data.credit import UserCredit\n"
        },
        {
            "id": "chunk_0_GlobalBlock_6",
            "code": "from backend.data.user import DEFAULT_USER_ID\n"
        },
        {
            "id": "chunk_0_GlobalBlock_7",
            "code": "from backend.integrations.credentials_store import openai_credentials\n"
        },
        {
            "id": "chunk_0_GlobalBlock_8",
            "code": "from backend.util.test import SpinTestServer\n"
        },
        {
            "id": "chunk_0_GlobalBlock_9",
            "code": "REFILL_VALUE = 1000\nuser_credit = UserCredit(REFILL_VALUE)\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_1",
            "code": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_usage(server: SpinTestServer):\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_2",
            "code": "    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_3",
            "code": "    spending_amount_1 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\n            \"model\": \"gpt-4-turbo\",\n            \"credentials\": {\n                \"id\": openai_credentials.id,\n                \"provider\": openai_credentials.provider,\n                \"type\": openai_credentials.type,\n            },\n        },\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_4",
            "code": "    assert spending_amount_1 > 0\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_5",
            "code": "    spending_amount_2 = await user_credit.spend_credits(\n        DEFAULT_USER_ID,\n        current_credit,\n        AITextGeneratorBlock().id,\n        {\"model\": \"gpt-4-turbo\", \"api_key\": \"owned_api_key\"},\n        0.0,\n        0.0,\n        validate_balance=False,\n    )\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_6",
            "code": "    assert spending_amount_2 == 0\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_7",
            "code": "    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
        },
        {
            "id": "chunk_1_test_block_credit_usage_8",
            "code": "    assert new_credit == current_credit - spending_amount_1 - spending_amount_2\n"
        },
        {
            "id": "chunk_2_test_block_credit_top_up_1",
            "code": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_top_up(server: SpinTestServer):\n"
        },
        {
            "id": "chunk_2_test_block_credit_top_up_2",
            "code": "    current_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
        },
        {
            "id": "chunk_2_test_block_credit_top_up_3",
            "code": "    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n"
        },
        {
            "id": "chunk_2_test_block_credit_top_up_4",
            "code": "    new_credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert new_credit == current_credit + 100\n"
        },
        {
            "id": "chunk_3_test_block_credit_reset_1",
            "code": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_block_credit_reset(server: SpinTestServer):\n"
        },
        {
            "id": "chunk_3_test_block_credit_reset_2",
            "code": "    month1 = datetime(2022, 1, 15)\n    month2 = datetime(2022, 2, 15)\n"
        },
        {
            "id": "chunk_3_test_block_credit_reset_3",
            "code": "    user_credit.time_now = lambda: month2\n    month2credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n"
        },
        {
            "id": "chunk_3_test_block_credit_reset_4",
            "code": "    user_credit.time_now = lambda: month1\n    month1credit = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    await user_credit.top_up_credits(DEFAULT_USER_ID, 100)\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month1credit + 100\n"
        },
        {
            "id": "chunk_3_test_block_credit_reset_5",
            "code": "    user_credit.time_now = lambda: month2\n    assert await user_credit.get_or_refill_credit(DEFAULT_USER_ID) == month2credit\n"
        },
        {
            "id": "chunk_4_test_credit_refill_1",
            "code": "@pytest.mark.asyncio(scope=\"session\")\nasync def test_credit_refill(server: SpinTestServer):\n"
        },
        {
            "id": "chunk_4_test_credit_refill_2",
            "code": "    # Clear all transactions within the month\n    await CreditTransaction.prisma().update_many(\n        where={\n            \"userId\": DEFAULT_USER_ID,\n            \"createdAt\": {\n                \"gte\": datetime(2022, 2, 1),\n                \"lt\": datetime(2022, 3, 1),\n            },\n        },\n        data={\"isActive\": False},\n    )\n"
        },
        {
            "id": "chunk_4_test_credit_refill_3",
            "code": "    user_credit.time_now = lambda: datetime(2022, 2, 15)\n"
        },
        {
            "id": "chunk_4_test_credit_refill_4",
            "code": "    balance = await user_credit.get_or_refill_credit(DEFAULT_USER_ID)\n    assert balance == REFILL_VALUE\n"
        }
    ],
    "edges": [
        {
            "from": "chunk_0_GlobalBlock_1",
            "to": "chunk_0_GlobalBlock_2"
        },
        {
            "from": "chunk_0_GlobalBlock_2",
            "to": "chunk_0_GlobalBlock_3"
        },
        {
            "from": "chunk_0_GlobalBlock_3",
            "to": "chunk_0_GlobalBlock_4"
        },
        {
            "from": "chunk_0_GlobalBlock_4",
            "to": "chunk_0_GlobalBlock_5"
        },
        {
            "from": "chunk_0_GlobalBlock_5",
            "to": "chunk_0_GlobalBlock_6"
        },
        {
            "from": "chunk_0_GlobalBlock_6",
            "to": "chunk_0_GlobalBlock_7"
        },
        {
            "from": "chunk_0_GlobalBlock_7",
            "to": "chunk_0_GlobalBlock_8"
        },
        {
            "from": "chunk_0_GlobalBlock_8",
            "to": "chunk_0_GlobalBlock_9"
        },
        {
            "from": "chunk_1_test_block_credit_usage_1",
            "to": "chunk_1_test_block_credit_usage_2"
        },
        {
            "from": "chunk_1_test_block_credit_usage_2",
            "to": "chunk_1_test_block_credit_usage_3"
        },
        {
            "from": "chunk_1_test_block_credit_usage_3",
            "to": "chunk_1_test_block_credit_usage_4"
        },
        {
            "from": "chunk_1_test_block_credit_usage_4",
            "to": "chunk_1_test_block_credit_usage_5"
        },
        {
            "from": "chunk_1_test_block_credit_usage_5",
            "to": "chunk_1_test_block_credit_usage_6"
        },
        {
            "from": "chunk_1_test_block_credit_usage_6",
            "to": "chunk_1_test_block_credit_usage_7"
        },
        {
            "from": "chunk_1_test_block_credit_usage_7",
            "to": "chunk_1_test_block_credit_usage_8"
        },
        {
            "from": "chunk_2_test_block_credit_top_up_1",
            "to": "chunk_2_test_block_credit_top_up_2"
        },
        {
            "from": "chunk_2_test_block_credit_top_up_2",
            "to": "chunk_2_test_block_credit_top_up_3"
        },
        {
            "from": "chunk_2_test_block_credit_top_up_3",
            "to": "chunk_2_test_block_credit_top_up_4"
        },
        {
            "from": "chunk_3_test_block_credit_reset_1",
            "to": "chunk_3_test_block_credit_reset_2"
        },
        {
            "from": "chunk_3_test_block_credit_reset_2",
            "to": "chunk_3_test_block_credit_reset_3"
        },
        {
            "from": "chunk_3_test_block_credit_reset_3",
            "to": "chunk_3_test_block_credit_reset_4"
        },
        {
            "from": "chunk_3_test_block_credit_reset_4",
            "to": "chunk_3_test_block_credit_reset_5"
        },
        {
            "from": "chunk_4_test_credit_refill_1",
            "to": "chunk_4_test_credit_refill_2"
        },
        {
            "from": "chunk_4_test_credit_refill_2",
            "to": "chunk_4_test_credit_refill_3"
        },
        {
            "from": "chunk_4_test_credit_refill_3",
            "to": "chunk_4_test_credit_refill_4"
        }
    ]
}