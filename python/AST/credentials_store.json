{
  "value": "import secrets\nfrom datetime import datetime, timedelta, timezone\nfrom typing import TYPE_CHECKING\n\nfrom pydantic import SecretStr\n\nif TYPE_CHECKING:\n    from backend.executor.database import DatabaseManager\n\nfrom autogpt_libs.utils.cache import thread_cached\nfrom autogpt_libs.utils.synchronize import RedisKeyedMutex\n\nfrom backend.data.model import (\n    APIKeyCredentials,\n    Credentials,\n    OAuth2Credentials,\n    OAuthState,\n    UserIntegrations,\n)\nfrom backend.util.settings import Settings\n\nsettings = Settings()\n\nrevid_credentials = APIKeyCredentials(\n    id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\",\n    provider=\"revid\",\n    api_key=SecretStr(settings.secrets.revid_api_key),\n    title=\"Use Credits for Revid\",\n    expires_at=None,\n)\nideogram_credentials = APIKeyCredentials(\n    id=\"760f84fc-b270-42de-91f6-08efe1b512d0\",\n    provider=\"ideogram\",\n    api_key=SecretStr(settings.secrets.ideogram_api_key),\n    title=\"Use Credits for Ideogram\",\n    expires_at=None,\n)\nreplicate_credentials = APIKeyCredentials(\n    id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\",\n    provider=\"replicate\",\n    api_key=SecretStr(settings.secrets.replicate_api_key),\n    title=\"Use Credits for Replicate\",\n    expires_at=None,\n)\nopenai_credentials = APIKeyCredentials(\n    id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\",\n    provider=\"openai\",\n    api_key=SecretStr(settings.secrets.openai_api_key),\n    title=\"Use Credits for OpenAI\",\n    expires_at=None,\n)\nanthropic_credentials = APIKeyCredentials(\n    id=\"24e5d942-d9e3-4798-8151-90143ee55629\",\n    provider=\"anthropic\",\n    api_key=SecretStr(settings.secrets.anthropic_api_key),\n    title=\"Use Credits for Anthropic\",\n    expires_at=None,\n)\ngroq_credentials = APIKeyCredentials(\n    id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\",\n    provider=\"groq\",\n    api_key=SecretStr(settings.secrets.groq_api_key),\n    title=\"Use Credits for Groq\",\n    expires_at=None,\n)\ndid_credentials = APIKeyCredentials(\n    id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\",\n    provider=\"d_id\",\n    api_key=SecretStr(settings.secrets.did_api_key),\n    title=\"Use Credits for D-ID\",\n    expires_at=None,\n)\njina_credentials = APIKeyCredentials(\n    id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\",\n    provider=\"jina\",\n    api_key=SecretStr(settings.secrets.jina_api_key),\n    title=\"Use Credits for Jina\",\n    expires_at=None,\n)\nunreal_credentials = APIKeyCredentials(\n    id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\",\n    provider=\"unreal\",\n    api_key=SecretStr(settings.secrets.unreal_speech_api_key),\n    title=\"Use Credits for Unreal\",\n    expires_at=None,\n)\nopen_router_credentials = APIKeyCredentials(\n    id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\",\n    provider=\"open_router\",\n    api_key=SecretStr(settings.secrets.open_router_api_key),\n    title=\"Use Credits for Open Router\",\n    expires_at=None,\n)\n\n\nDEFAULT_CREDENTIALS = [\n    revid_credentials,\n    ideogram_credentials,\n    replicate_credentials,\n    openai_credentials,\n    anthropic_credentials,\n    groq_credentials,\n    did_credentials,\n    jina_credentials,\n    unreal_credentials,\n    open_router_credentials,\n]\n\n\nclass IntegrationCredentialsStore:\n    def __init__(self):\n        from backend.data.redis import get_redis\n\n        self.locks = RedisKeyedMutex(get_redis())\n\n    @property\n    @thread_cached\n    def db_manager(self) -> \"DatabaseManager\":\n        from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)\n\n    def add_creds(self, user_id: str, credentials: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )\n\n    def get_all_creds(self, user_id: str) -> list[Credentials]:\n        users_credentials = self._get_user_integrations(user_id).credentials\n        all_credentials = users_credentials\n        if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)\n        if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)\n        if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)\n        if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)\n        if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)\n        if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)\n        if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)\n        if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)\n        if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)\n        if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)\n        return all_credentials\n\n    def get_creds_by_id(self, user_id: str, credentials_id: str) -> Credentials | None:\n        all_credentials = self.get_all_creds(user_id)\n        return next((c for c in all_credentials if c.id == credentials_id), None)\n\n    def get_creds_by_provider(self, user_id: str, provider: str) -> list[Credentials]:\n        credentials = self.get_all_creds(user_id)\n        return [c for c in credentials if c.provider == provider]\n\n    def get_authorized_providers(self, user_id: str) -> list[str]:\n        credentials = self.get_all_creds(user_id)\n        return list(set(c.provider for c in credentials))\n\n    def update_creds(self, user_id: str, updated: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)\n\n    def delete_creds_by_id(self, user_id: str, credentials_id: str) -> None:\n        with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)\n\n    def store_state_token(self, user_id: str, provider: str, scopes: list[str]) -> str:\n        token = secrets.token_urlsafe(32)\n        expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)\n\n        state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )\n\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )\n\n        return token\n\n    def get_any_valid_scopes_from_state_token(\n        self, user_id: str, token: str, provider: str\n    ) -> list[str]:\n        \"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"\n        user_integrations = self._get_user_integrations(user_id)\n        oauth_states = user_integrations.oauth_states\n\n        now = datetime.now(timezone.utc)\n        valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )\n\n        if valid_state:\n            return valid_state.scopes\n\n        return []\n\n    def verify_state_token(self, user_id: str, token: str, provider: str) -> bool:\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True\n\n        return False\n\n    def _set_user_integration_creds(\n        self, user_id: str, credentials: list[Credentials]\n    ) -> None:\n        integrations = self._get_user_integrations(user_id)\n        # Remove default credentials from the list\n        credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]\n        integrations.credentials = credentials\n        self.db_manager.update_user_integrations(user_id, integrations)\n\n    def _get_user_integrations(self, user_id: str) -> UserIntegrations:\n        integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )\n        return integrations\n\n    def locked_user_integrations(self, user_id: str):\n        key = (f\"user:{user_id}\", \"integrations\")\n        return self.locks.locked(key)",
  "children": [
    {
      "value": "import secrets",
      "children": [
        {
          "value": "secrets",
          "children": [
            {
              "value": "secrets",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from datetime import datetime, timedelta, timezone",
      "children": [
        {
          "value": "datetime",
          "children": [
            {
              "value": "datetime",
              "children": []
            }
          ]
        },
        {
          "value": "datetime",
          "children": [
            {
              "value": "datetime",
              "children": []
            }
          ]
        },
        {
          "value": "timedelta",
          "children": [
            {
              "value": "timedelta",
              "children": []
            }
          ]
        },
        {
          "value": "timezone",
          "children": [
            {
              "value": "timezone",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from typing import TYPE_CHECKING",
      "children": [
        {
          "value": "typing",
          "children": [
            {
              "value": "typing",
              "children": []
            }
          ]
        },
        {
          "value": "TYPE_CHECKING",
          "children": [
            {
              "value": "TYPE_CHECKING",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from pydantic import SecretStr",
      "children": [
        {
          "value": "pydantic",
          "children": [
            {
              "value": "pydantic",
              "children": []
            }
          ]
        },
        {
          "value": "SecretStr",
          "children": [
            {
              "value": "SecretStr",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "if TYPE_CHECKING:\n    from backend.executor.database import DatabaseManager",
      "children": [
        {
          "value": "TYPE_CHECKING",
          "children": []
        },
        {
          "value": "from backend.executor.database import DatabaseManager",
          "children": [
            {
              "value": "from backend.executor.database import DatabaseManager",
              "children": [
                {
                  "value": "backend.executor.database",
                  "children": [
                    {
                      "value": "backend",
                      "children": []
                    },
                    {
                      "value": "executor",
                      "children": []
                    },
                    {
                      "value": "database",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "DatabaseManager",
                  "children": [
                    {
                      "value": "DatabaseManager",
                      "children": []
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "from autogpt_libs.utils.cache import thread_cached",
      "children": [
        {
          "value": "autogpt_libs.utils.cache",
          "children": [
            {
              "value": "autogpt_libs",
              "children": []
            },
            {
              "value": "utils",
              "children": []
            },
            {
              "value": "cache",
              "children": []
            }
          ]
        },
        {
          "value": "thread_cached",
          "children": [
            {
              "value": "thread_cached",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from autogpt_libs.utils.synchronize import RedisKeyedMutex",
      "children": [
        {
          "value": "autogpt_libs.utils.synchronize",
          "children": [
            {
              "value": "autogpt_libs",
              "children": []
            },
            {
              "value": "utils",
              "children": []
            },
            {
              "value": "synchronize",
              "children": []
            }
          ]
        },
        {
          "value": "RedisKeyedMutex",
          "children": [
            {
              "value": "RedisKeyedMutex",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from backend.data.model import (\n    APIKeyCredentials,\n    Credentials,\n    OAuth2Credentials,\n    OAuthState,\n    UserIntegrations,\n)",
      "children": [
        {
          "value": "backend.data.model",
          "children": [
            {
              "value": "backend",
              "children": []
            },
            {
              "value": "data",
              "children": []
            },
            {
              "value": "model",
              "children": []
            }
          ]
        },
        {
          "value": "APIKeyCredentials",
          "children": [
            {
              "value": "APIKeyCredentials",
              "children": []
            }
          ]
        },
        {
          "value": "Credentials",
          "children": [
            {
              "value": "Credentials",
              "children": []
            }
          ]
        },
        {
          "value": "OAuth2Credentials",
          "children": [
            {
              "value": "OAuth2Credentials",
              "children": []
            }
          ]
        },
        {
          "value": "OAuthState",
          "children": [
            {
              "value": "OAuthState",
              "children": []
            }
          ]
        },
        {
          "value": "UserIntegrations",
          "children": [
            {
              "value": "UserIntegrations",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "from backend.util.settings import Settings",
      "children": [
        {
          "value": "backend.util.settings",
          "children": [
            {
              "value": "backend",
              "children": []
            },
            {
              "value": "util",
              "children": []
            },
            {
              "value": "settings",
              "children": []
            }
          ]
        },
        {
          "value": "Settings",
          "children": [
            {
              "value": "Settings",
              "children": []
            }
          ]
        }
      ]
    },
    {
      "value": "settings = Settings()",
      "children": [
        {
          "value": "settings = Settings()",
          "children": [
            {
              "value": "settings",
              "children": []
            },
            {
              "value": "Settings()",
              "children": [
                {
                  "value": "Settings",
                  "children": []
                },
                {
                  "value": "()",
                  "children": []
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "revid_credentials = APIKeyCredentials(\n    id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\",\n    provider=\"revid\",\n    api_key=SecretStr(settings.secrets.revid_api_key),\n    title=\"Use Credits for Revid\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "revid_credentials = APIKeyCredentials(\n    id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\",\n    provider=\"revid\",\n    api_key=SecretStr(settings.secrets.revid_api_key),\n    title=\"Use Credits for Revid\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "revid_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\",\n    provider=\"revid\",\n    api_key=SecretStr(settings.secrets.revid_api_key),\n    title=\"Use Credits for Revid\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\",\n    provider=\"revid\",\n    api_key=SecretStr(settings.secrets.revid_api_key),\n    title=\"Use Credits for Revid\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"fdb7f412-f519-48d1-9b5f-d2f73d0e01fe\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "fdb7f412-f519-48d1-9b5f-d2f73d0e01fe",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"revid\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"revid\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "revid",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.revid_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.revid_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.revid_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.revid_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "revid_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Revid\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Revid\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Revid",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "ideogram_credentials = APIKeyCredentials(\n    id=\"760f84fc-b270-42de-91f6-08efe1b512d0\",\n    provider=\"ideogram\",\n    api_key=SecretStr(settings.secrets.ideogram_api_key),\n    title=\"Use Credits for Ideogram\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "ideogram_credentials = APIKeyCredentials(\n    id=\"760f84fc-b270-42de-91f6-08efe1b512d0\",\n    provider=\"ideogram\",\n    api_key=SecretStr(settings.secrets.ideogram_api_key),\n    title=\"Use Credits for Ideogram\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "ideogram_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"760f84fc-b270-42de-91f6-08efe1b512d0\",\n    provider=\"ideogram\",\n    api_key=SecretStr(settings.secrets.ideogram_api_key),\n    title=\"Use Credits for Ideogram\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"760f84fc-b270-42de-91f6-08efe1b512d0\",\n    provider=\"ideogram\",\n    api_key=SecretStr(settings.secrets.ideogram_api_key),\n    title=\"Use Credits for Ideogram\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"760f84fc-b270-42de-91f6-08efe1b512d0\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"760f84fc-b270-42de-91f6-08efe1b512d0\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "760f84fc-b270-42de-91f6-08efe1b512d0",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"ideogram\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"ideogram\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "ideogram",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.ideogram_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.ideogram_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.ideogram_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.ideogram_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "ideogram_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Ideogram\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Ideogram\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Ideogram",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "replicate_credentials = APIKeyCredentials(\n    id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\",\n    provider=\"replicate\",\n    api_key=SecretStr(settings.secrets.replicate_api_key),\n    title=\"Use Credits for Replicate\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "replicate_credentials = APIKeyCredentials(\n    id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\",\n    provider=\"replicate\",\n    api_key=SecretStr(settings.secrets.replicate_api_key),\n    title=\"Use Credits for Replicate\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "replicate_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\",\n    provider=\"replicate\",\n    api_key=SecretStr(settings.secrets.replicate_api_key),\n    title=\"Use Credits for Replicate\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\",\n    provider=\"replicate\",\n    api_key=SecretStr(settings.secrets.replicate_api_key),\n    title=\"Use Credits for Replicate\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"6b9fc200-4726-4973-86c9-cd526f5ce5db\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"6b9fc200-4726-4973-86c9-cd526f5ce5db\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "6b9fc200-4726-4973-86c9-cd526f5ce5db",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"replicate\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"replicate\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "replicate",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.replicate_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.replicate_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.replicate_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.replicate_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "replicate_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Replicate\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Replicate\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Replicate",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "openai_credentials = APIKeyCredentials(\n    id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\",\n    provider=\"openai\",\n    api_key=SecretStr(settings.secrets.openai_api_key),\n    title=\"Use Credits for OpenAI\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "openai_credentials = APIKeyCredentials(\n    id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\",\n    provider=\"openai\",\n    api_key=SecretStr(settings.secrets.openai_api_key),\n    title=\"Use Credits for OpenAI\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "openai_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\",\n    provider=\"openai\",\n    api_key=SecretStr(settings.secrets.openai_api_key),\n    title=\"Use Credits for OpenAI\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\",\n    provider=\"openai\",\n    api_key=SecretStr(settings.secrets.openai_api_key),\n    title=\"Use Credits for OpenAI\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"53c25cb8-e3ee-465c-a4d1-e75a4c899c2a\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "53c25cb8-e3ee-465c-a4d1-e75a4c899c2a",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"openai\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"openai\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "openai",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.openai_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.openai_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.openai_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.openai_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "openai_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for OpenAI\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for OpenAI\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for OpenAI",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "anthropic_credentials = APIKeyCredentials(\n    id=\"24e5d942-d9e3-4798-8151-90143ee55629\",\n    provider=\"anthropic\",\n    api_key=SecretStr(settings.secrets.anthropic_api_key),\n    title=\"Use Credits for Anthropic\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "anthropic_credentials = APIKeyCredentials(\n    id=\"24e5d942-d9e3-4798-8151-90143ee55629\",\n    provider=\"anthropic\",\n    api_key=SecretStr(settings.secrets.anthropic_api_key),\n    title=\"Use Credits for Anthropic\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "anthropic_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"24e5d942-d9e3-4798-8151-90143ee55629\",\n    provider=\"anthropic\",\n    api_key=SecretStr(settings.secrets.anthropic_api_key),\n    title=\"Use Credits for Anthropic\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"24e5d942-d9e3-4798-8151-90143ee55629\",\n    provider=\"anthropic\",\n    api_key=SecretStr(settings.secrets.anthropic_api_key),\n    title=\"Use Credits for Anthropic\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"24e5d942-d9e3-4798-8151-90143ee55629\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"24e5d942-d9e3-4798-8151-90143ee55629\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "24e5d942-d9e3-4798-8151-90143ee55629",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"anthropic\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"anthropic\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "anthropic",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.anthropic_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.anthropic_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.anthropic_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.anthropic_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "anthropic_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Anthropic\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Anthropic\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Anthropic",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "groq_credentials = APIKeyCredentials(\n    id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\",\n    provider=\"groq\",\n    api_key=SecretStr(settings.secrets.groq_api_key),\n    title=\"Use Credits for Groq\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "groq_credentials = APIKeyCredentials(\n    id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\",\n    provider=\"groq\",\n    api_key=SecretStr(settings.secrets.groq_api_key),\n    title=\"Use Credits for Groq\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "groq_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\",\n    provider=\"groq\",\n    api_key=SecretStr(settings.secrets.groq_api_key),\n    title=\"Use Credits for Groq\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\",\n    provider=\"groq\",\n    api_key=SecretStr(settings.secrets.groq_api_key),\n    title=\"Use Credits for Groq\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"4ec22295-8f97-4dd1-b42b-2c6957a02545\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"4ec22295-8f97-4dd1-b42b-2c6957a02545\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "4ec22295-8f97-4dd1-b42b-2c6957a02545",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"groq\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"groq\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "groq",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.groq_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.groq_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.groq_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.groq_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "groq_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Groq\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Groq\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Groq",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "did_credentials = APIKeyCredentials(\n    id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\",\n    provider=\"d_id\",\n    api_key=SecretStr(settings.secrets.did_api_key),\n    title=\"Use Credits for D-ID\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "did_credentials = APIKeyCredentials(\n    id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\",\n    provider=\"d_id\",\n    api_key=SecretStr(settings.secrets.did_api_key),\n    title=\"Use Credits for D-ID\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "did_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\",\n    provider=\"d_id\",\n    api_key=SecretStr(settings.secrets.did_api_key),\n    title=\"Use Credits for D-ID\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\",\n    provider=\"d_id\",\n    api_key=SecretStr(settings.secrets.did_api_key),\n    title=\"Use Credits for D-ID\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"7f7b0654-c36b-4565-8fa7-9a52575dfae2\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "7f7b0654-c36b-4565-8fa7-9a52575dfae2",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"d_id\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"d_id\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "d_id",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.did_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.did_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.did_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.did_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "did_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for D-ID\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for D-ID\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for D-ID",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "jina_credentials = APIKeyCredentials(\n    id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\",\n    provider=\"jina\",\n    api_key=SecretStr(settings.secrets.jina_api_key),\n    title=\"Use Credits for Jina\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "jina_credentials = APIKeyCredentials(\n    id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\",\n    provider=\"jina\",\n    api_key=SecretStr(settings.secrets.jina_api_key),\n    title=\"Use Credits for Jina\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "jina_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\",\n    provider=\"jina\",\n    api_key=SecretStr(settings.secrets.jina_api_key),\n    title=\"Use Credits for Jina\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\",\n    provider=\"jina\",\n    api_key=SecretStr(settings.secrets.jina_api_key),\n    title=\"Use Credits for Jina\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"7f26de70-ba0d-494e-ba76-238e65e7b45f\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"7f26de70-ba0d-494e-ba76-238e65e7b45f\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "7f26de70-ba0d-494e-ba76-238e65e7b45f",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"jina\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"jina\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "jina",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.jina_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.jina_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.jina_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.jina_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "jina_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Jina\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Jina\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Jina",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "unreal_credentials = APIKeyCredentials(\n    id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\",\n    provider=\"unreal\",\n    api_key=SecretStr(settings.secrets.unreal_speech_api_key),\n    title=\"Use Credits for Unreal\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "unreal_credentials = APIKeyCredentials(\n    id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\",\n    provider=\"unreal\",\n    api_key=SecretStr(settings.secrets.unreal_speech_api_key),\n    title=\"Use Credits for Unreal\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "unreal_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\",\n    provider=\"unreal\",\n    api_key=SecretStr(settings.secrets.unreal_speech_api_key),\n    title=\"Use Credits for Unreal\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\",\n    provider=\"unreal\",\n    api_key=SecretStr(settings.secrets.unreal_speech_api_key),\n    title=\"Use Credits for Unreal\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"66f20754-1b81-48e4-91d0-f4f0dd82145f\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"66f20754-1b81-48e4-91d0-f4f0dd82145f\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "66f20754-1b81-48e4-91d0-f4f0dd82145f",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"unreal\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"unreal\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "unreal",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.unreal_speech_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.unreal_speech_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.unreal_speech_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.unreal_speech_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "unreal_speech_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Unreal\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Unreal\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Unreal",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "open_router_credentials = APIKeyCredentials(\n    id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\",\n    provider=\"open_router\",\n    api_key=SecretStr(settings.secrets.open_router_api_key),\n    title=\"Use Credits for Open Router\",\n    expires_at=None,\n)",
      "children": [
        {
          "value": "open_router_credentials = APIKeyCredentials(\n    id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\",\n    provider=\"open_router\",\n    api_key=SecretStr(settings.secrets.open_router_api_key),\n    title=\"Use Credits for Open Router\",\n    expires_at=None,\n)",
          "children": [
            {
              "value": "open_router_credentials",
              "children": []
            },
            {
              "value": "APIKeyCredentials(\n    id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\",\n    provider=\"open_router\",\n    api_key=SecretStr(settings.secrets.open_router_api_key),\n    title=\"Use Credits for Open Router\",\n    expires_at=None,\n)",
              "children": [
                {
                  "value": "APIKeyCredentials",
                  "children": []
                },
                {
                  "value": "(\n    id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\",\n    provider=\"open_router\",\n    api_key=SecretStr(settings.secrets.open_router_api_key),\n    title=\"Use Credits for Open Router\",\n    expires_at=None,\n)",
                  "children": [
                    {
                      "value": "id=\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\"",
                      "children": [
                        {
                          "value": "id",
                          "children": []
                        },
                        {
                          "value": "\"b5a0e27d-0c98-4df3-a4b9-10193e1f3c40\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "b5a0e27d-0c98-4df3-a4b9-10193e1f3c40",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider=\"open_router\"",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "\"open_router\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "open_router",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "api_key=SecretStr(settings.secrets.open_router_api_key)",
                      "children": [
                        {
                          "value": "api_key",
                          "children": []
                        },
                        {
                          "value": "SecretStr(settings.secrets.open_router_api_key)",
                          "children": [
                            {
                              "value": "SecretStr",
                              "children": []
                            },
                            {
                              "value": "(settings.secrets.open_router_api_key)",
                              "children": [
                                {
                                  "value": "settings.secrets.open_router_api_key",
                                  "children": [
                                    {
                                      "value": "settings.secrets",
                                      "children": [
                                        {
                                          "value": "settings",
                                          "children": []
                                        },
                                        {
                                          "value": "secrets",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "open_router_api_key",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "title=\"Use Credits for Open Router\"",
                      "children": [
                        {
                          "value": "title",
                          "children": []
                        },
                        {
                          "value": "\"Use Credits for Open Router\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "Use Credits for Open Router",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at=None",
                      "children": [
                        {
                          "value": "expires_at",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "DEFAULT_CREDENTIALS = [\n    revid_credentials,\n    ideogram_credentials,\n    replicate_credentials,\n    openai_credentials,\n    anthropic_credentials,\n    groq_credentials,\n    did_credentials,\n    jina_credentials,\n    unreal_credentials,\n    open_router_credentials,\n]",
      "children": [
        {
          "value": "DEFAULT_CREDENTIALS = [\n    revid_credentials,\n    ideogram_credentials,\n    replicate_credentials,\n    openai_credentials,\n    anthropic_credentials,\n    groq_credentials,\n    did_credentials,\n    jina_credentials,\n    unreal_credentials,\n    open_router_credentials,\n]",
          "children": [
            {
              "value": "DEFAULT_CREDENTIALS",
              "children": []
            },
            {
              "value": "[\n    revid_credentials,\n    ideogram_credentials,\n    replicate_credentials,\n    openai_credentials,\n    anthropic_credentials,\n    groq_credentials,\n    did_credentials,\n    jina_credentials,\n    unreal_credentials,\n    open_router_credentials,\n]",
              "children": [
                {
                  "value": "revid_credentials",
                  "children": []
                },
                {
                  "value": "ideogram_credentials",
                  "children": []
                },
                {
                  "value": "replicate_credentials",
                  "children": []
                },
                {
                  "value": "openai_credentials",
                  "children": []
                },
                {
                  "value": "anthropic_credentials",
                  "children": []
                },
                {
                  "value": "groq_credentials",
                  "children": []
                },
                {
                  "value": "did_credentials",
                  "children": []
                },
                {
                  "value": "jina_credentials",
                  "children": []
                },
                {
                  "value": "unreal_credentials",
                  "children": []
                },
                {
                  "value": "open_router_credentials",
                  "children": []
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "value": "class IntegrationCredentialsStore:\n    def __init__(self):\n        from backend.data.redis import get_redis\n\n        self.locks = RedisKeyedMutex(get_redis())\n\n    @property\n    @thread_cached\n    def db_manager(self) -> \"DatabaseManager\":\n        from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)\n\n    def add_creds(self, user_id: str, credentials: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )\n\n    def get_all_creds(self, user_id: str) -> list[Credentials]:\n        users_credentials = self._get_user_integrations(user_id).credentials\n        all_credentials = users_credentials\n        if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)\n        if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)\n        if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)\n        if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)\n        if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)\n        if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)\n        if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)\n        if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)\n        if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)\n        if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)\n        return all_credentials\n\n    def get_creds_by_id(self, user_id: str, credentials_id: str) -> Credentials | None:\n        all_credentials = self.get_all_creds(user_id)\n        return next((c for c in all_credentials if c.id == credentials_id), None)\n\n    def get_creds_by_provider(self, user_id: str, provider: str) -> list[Credentials]:\n        credentials = self.get_all_creds(user_id)\n        return [c for c in credentials if c.provider == provider]\n\n    def get_authorized_providers(self, user_id: str) -> list[str]:\n        credentials = self.get_all_creds(user_id)\n        return list(set(c.provider for c in credentials))\n\n    def update_creds(self, user_id: str, updated: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)\n\n    def delete_creds_by_id(self, user_id: str, credentials_id: str) -> None:\n        with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)\n\n    def store_state_token(self, user_id: str, provider: str, scopes: list[str]) -> str:\n        token = secrets.token_urlsafe(32)\n        expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)\n\n        state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )\n\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )\n\n        return token\n\n    def get_any_valid_scopes_from_state_token(\n        self, user_id: str, token: str, provider: str\n    ) -> list[str]:\n        \"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"\n        user_integrations = self._get_user_integrations(user_id)\n        oauth_states = user_integrations.oauth_states\n\n        now = datetime.now(timezone.utc)\n        valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )\n\n        if valid_state:\n            return valid_state.scopes\n\n        return []\n\n    def verify_state_token(self, user_id: str, token: str, provider: str) -> bool:\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True\n\n        return False\n\n    def _set_user_integration_creds(\n        self, user_id: str, credentials: list[Credentials]\n    ) -> None:\n        integrations = self._get_user_integrations(user_id)\n        # Remove default credentials from the list\n        credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]\n        integrations.credentials = credentials\n        self.db_manager.update_user_integrations(user_id, integrations)\n\n    def _get_user_integrations(self, user_id: str) -> UserIntegrations:\n        integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )\n        return integrations\n\n    def locked_user_integrations(self, user_id: str):\n        key = (f\"user:{user_id}\", \"integrations\")\n        return self.locks.locked(key)",
      "children": [
        {
          "value": "IntegrationCredentialsStore",
          "children": []
        },
        {
          "value": "def __init__(self):\n        from backend.data.redis import get_redis\n\n        self.locks = RedisKeyedMutex(get_redis())\n\n    @property\n    @thread_cached\n    def db_manager(self) -> \"DatabaseManager\":\n        from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)\n\n    def add_creds(self, user_id: str, credentials: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )\n\n    def get_all_creds(self, user_id: str) -> list[Credentials]:\n        users_credentials = self._get_user_integrations(user_id).credentials\n        all_credentials = users_credentials\n        if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)\n        if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)\n        if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)\n        if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)\n        if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)\n        if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)\n        if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)\n        if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)\n        if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)\n        if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)\n        return all_credentials\n\n    def get_creds_by_id(self, user_id: str, credentials_id: str) -> Credentials | None:\n        all_credentials = self.get_all_creds(user_id)\n        return next((c for c in all_credentials if c.id == credentials_id), None)\n\n    def get_creds_by_provider(self, user_id: str, provider: str) -> list[Credentials]:\n        credentials = self.get_all_creds(user_id)\n        return [c for c in credentials if c.provider == provider]\n\n    def get_authorized_providers(self, user_id: str) -> list[str]:\n        credentials = self.get_all_creds(user_id)\n        return list(set(c.provider for c in credentials))\n\n    def update_creds(self, user_id: str, updated: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)\n\n    def delete_creds_by_id(self, user_id: str, credentials_id: str) -> None:\n        with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)\n\n    def store_state_token(self, user_id: str, provider: str, scopes: list[str]) -> str:\n        token = secrets.token_urlsafe(32)\n        expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)\n\n        state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )\n\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )\n\n        return token\n\n    def get_any_valid_scopes_from_state_token(\n        self, user_id: str, token: str, provider: str\n    ) -> list[str]:\n        \"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"\n        user_integrations = self._get_user_integrations(user_id)\n        oauth_states = user_integrations.oauth_states\n\n        now = datetime.now(timezone.utc)\n        valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )\n\n        if valid_state:\n            return valid_state.scopes\n\n        return []\n\n    def verify_state_token(self, user_id: str, token: str, provider: str) -> bool:\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True\n\n        return False\n\n    def _set_user_integration_creds(\n        self, user_id: str, credentials: list[Credentials]\n    ) -> None:\n        integrations = self._get_user_integrations(user_id)\n        # Remove default credentials from the list\n        credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]\n        integrations.credentials = credentials\n        self.db_manager.update_user_integrations(user_id, integrations)\n\n    def _get_user_integrations(self, user_id: str) -> UserIntegrations:\n        integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )\n        return integrations\n\n    def locked_user_integrations(self, user_id: str):\n        key = (f\"user:{user_id}\", \"integrations\")\n        return self.locks.locked(key)",
          "children": [
            {
              "value": "def __init__(self):\n        from backend.data.redis import get_redis\n\n        self.locks = RedisKeyedMutex(get_redis())",
              "children": [
                {
                  "value": "__init__",
                  "children": []
                },
                {
                  "value": "(self)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "from backend.data.redis import get_redis\n\n        self.locks = RedisKeyedMutex(get_redis())",
                  "children": [
                    {
                      "value": "from backend.data.redis import get_redis",
                      "children": [
                        {
                          "value": "backend.data.redis",
                          "children": [
                            {
                              "value": "backend",
                              "children": []
                            },
                            {
                              "value": "data",
                              "children": []
                            },
                            {
                              "value": "redis",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "get_redis",
                          "children": [
                            {
                              "value": "get_redis",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "self.locks = RedisKeyedMutex(get_redis())",
                      "children": [
                        {
                          "value": "self.locks = RedisKeyedMutex(get_redis())",
                          "children": [
                            {
                              "value": "self.locks",
                              "children": [
                                {
                                  "value": "self",
                                  "children": []
                                },
                                {
                                  "value": "locks",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "RedisKeyedMutex(get_redis())",
                              "children": [
                                {
                                  "value": "RedisKeyedMutex",
                                  "children": []
                                },
                                {
                                  "value": "(get_redis())",
                                  "children": [
                                    {
                                      "value": "get_redis()",
                                      "children": [
                                        {
                                          "value": "get_redis",
                                          "children": []
                                        },
                                        {
                                          "value": "()",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "@property\n    @thread_cached\n    def db_manager(self) -> \"DatabaseManager\":\n        from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)",
              "children": [
                {
                  "value": "@property",
                  "children": [
                    {
                      "value": "property",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "@thread_cached",
                  "children": [
                    {
                      "value": "thread_cached",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "def db_manager(self) -> \"DatabaseManager\":\n        from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)",
                  "children": [
                    {
                      "value": "db_manager",
                      "children": []
                    },
                    {
                      "value": "(self)",
                      "children": [
                        {
                          "value": "self",
                          "children": []
                        }
                      ]
                    },
                    {
                      "value": "\"DatabaseManager\"",
                      "children": [
                        {
                          "value": "\"DatabaseManager\"",
                          "children": [
                            {
                              "value": "\"",
                              "children": []
                            },
                            {
                              "value": "DatabaseManager",
                              "children": []
                            },
                            {
                              "value": "\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "from backend.executor.database import DatabaseManager\n        from backend.util.service import get_service_client\n\n        return get_service_client(DatabaseManager)",
                      "children": [
                        {
                          "value": "from backend.executor.database import DatabaseManager",
                          "children": [
                            {
                              "value": "backend.executor.database",
                              "children": [
                                {
                                  "value": "backend",
                                  "children": []
                                },
                                {
                                  "value": "executor",
                                  "children": []
                                },
                                {
                                  "value": "database",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "DatabaseManager",
                              "children": [
                                {
                                  "value": "DatabaseManager",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "from backend.util.service import get_service_client",
                          "children": [
                            {
                              "value": "backend.util.service",
                              "children": [
                                {
                                  "value": "backend",
                                  "children": []
                                },
                                {
                                  "value": "util",
                                  "children": []
                                },
                                {
                                  "value": "service",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "get_service_client",
                              "children": [
                                {
                                  "value": "get_service_client",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "return get_service_client(DatabaseManager)",
                          "children": [
                            {
                              "value": "get_service_client(DatabaseManager)",
                              "children": [
                                {
                                  "value": "get_service_client",
                                  "children": []
                                },
                                {
                                  "value": "(DatabaseManager)",
                                  "children": [
                                    {
                                      "value": "DatabaseManager",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def add_creds(self, user_id: str, credentials: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
              "children": [
                {
                  "value": "add_creds",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, credentials: Credentials)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "credentials: Credentials",
                      "children": [
                        {
                          "value": "credentials",
                          "children": []
                        },
                        {
                          "value": "Credentials",
                          "children": [
                            {
                              "value": "Credentials",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "None",
                  "children": [
                    {
                      "value": "None",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                  "children": [
                    {
                      "value": "with self.locked_user_integrations(user_id):\n            if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                      "children": [
                        {
                          "value": "self.locked_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "self.locked_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self.locked_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self.locked_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "locked_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )\n            self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                          "children": [
                            {
                              "value": "if self.get_creds_by_id(user_id, credentials.id):\n                raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )",
                              "children": [
                                {
                                  "value": "self.get_creds_by_id(user_id, credentials.id)",
                                  "children": [
                                    {
                                      "value": "self.get_creds_by_id",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "get_creds_by_id",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id, credentials.id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        },
                                        {
                                          "value": "credentials.id",
                                          "children": [
                                            {
                                              "value": "credentials",
                                              "children": []
                                            },
                                            {
                                              "value": "id",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )",
                                  "children": [
                                    {
                                      "value": "raise ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )",
                                      "children": [
                                        {
                                          "value": "ValueError(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )",
                                          "children": [
                                            {
                                              "value": "ValueError",
                                              "children": []
                                            },
                                            {
                                              "value": "(\n                    f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"\n                )",
                                              "children": [
                                                {
                                                  "value": "f\"Can not re-create existing credentials #{credentials.id} \"\n                    f\"for user #{user_id}\"",
                                                  "children": [
                                                    {
                                                      "value": "f\"Can not re-create existing credentials #{credentials.id} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "Can not re-create existing credentials #",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{credentials.id}",
                                                          "children": [
                                                            {
                                                              "value": "credentials.id",
                                                              "children": [
                                                                {
                                                                  "value": "credentials",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "id",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"for user #{user_id}\"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "for user #",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{user_id}",
                                                          "children": [
                                                            {
                                                              "value": "user_id",
                                                              "children": []
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                              "children": [
                                {
                                  "value": "self._set_user_integration_creds(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                                  "children": [
                                    {
                                      "value": "self._set_user_integration_creds",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "_set_user_integration_creds",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(\n                user_id, [*self.get_all_creds(user_id), credentials]\n            )",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        },
                                        {
                                          "value": "[*self.get_all_creds(user_id), credentials]",
                                          "children": [
                                            {
                                              "value": "*self.get_all_creds(user_id)",
                                              "children": [
                                                {
                                                  "value": "self.get_all_creds(user_id)",
                                                  "children": [
                                                    {
                                                      "value": "self.get_all_creds",
                                                      "children": [
                                                        {
                                                          "value": "self",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "get_all_creds",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "(user_id)",
                                                      "children": [
                                                        {
                                                          "value": "user_id",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "value": "credentials",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def get_all_creds(self, user_id: str) -> list[Credentials]:\n        users_credentials = self._get_user_integrations(user_id).credentials\n        all_credentials = users_credentials\n        if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)\n        if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)\n        if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)\n        if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)\n        if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)\n        if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)\n        if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)\n        if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)\n        if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)\n        if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)\n        return all_credentials",
              "children": [
                {
                  "value": "get_all_creds",
                  "children": []
                },
                {
                  "value": "(self, user_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "list[Credentials]",
                  "children": [
                    {
                      "value": "list[Credentials]",
                      "children": [
                        {
                          "value": "list",
                          "children": []
                        },
                        {
                          "value": "[Credentials]",
                          "children": [
                            {
                              "value": "Credentials",
                              "children": [
                                {
                                  "value": "Credentials",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "users_credentials = self._get_user_integrations(user_id).credentials\n        all_credentials = users_credentials\n        if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)\n        if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)\n        if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)\n        if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)\n        if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)\n        if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)\n        if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)\n        if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)\n        if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)\n        if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)\n        return all_credentials",
                  "children": [
                    {
                      "value": "users_credentials = self._get_user_integrations(user_id).credentials",
                      "children": [
                        {
                          "value": "users_credentials = self._get_user_integrations(user_id).credentials",
                          "children": [
                            {
                              "value": "users_credentials",
                              "children": []
                            },
                            {
                              "value": "self._get_user_integrations(user_id).credentials",
                              "children": [
                                {
                                  "value": "self._get_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self._get_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "_get_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "credentials",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "all_credentials = users_credentials",
                      "children": [
                        {
                          "value": "all_credentials = users_credentials",
                          "children": [
                            {
                              "value": "all_credentials",
                              "children": []
                            },
                            {
                              "value": "users_credentials",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.revid_api_key:\n            all_credentials.append(revid_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.revid_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "revid_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(revid_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(revid_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(revid_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(revid_credentials)",
                                      "children": [
                                        {
                                          "value": "revid_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.ideogram_api_key:\n            all_credentials.append(ideogram_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.ideogram_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "ideogram_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(ideogram_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(ideogram_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(ideogram_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(ideogram_credentials)",
                                      "children": [
                                        {
                                          "value": "ideogram_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.groq_api_key:\n            all_credentials.append(groq_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.groq_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "groq_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(groq_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(groq_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(groq_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(groq_credentials)",
                                      "children": [
                                        {
                                          "value": "groq_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.replicate_api_key:\n            all_credentials.append(replicate_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.replicate_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "replicate_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(replicate_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(replicate_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(replicate_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(replicate_credentials)",
                                      "children": [
                                        {
                                          "value": "replicate_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.openai_api_key:\n            all_credentials.append(openai_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.openai_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "openai_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(openai_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(openai_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(openai_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(openai_credentials)",
                                      "children": [
                                        {
                                          "value": "openai_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.anthropic_api_key:\n            all_credentials.append(anthropic_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.anthropic_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "anthropic_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(anthropic_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(anthropic_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(anthropic_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(anthropic_credentials)",
                                      "children": [
                                        {
                                          "value": "anthropic_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.did_api_key:\n            all_credentials.append(did_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.did_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "did_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(did_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(did_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(did_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(did_credentials)",
                                      "children": [
                                        {
                                          "value": "did_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.jina_api_key:\n            all_credentials.append(jina_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.jina_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "jina_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(jina_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(jina_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(jina_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(jina_credentials)",
                                      "children": [
                                        {
                                          "value": "jina_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.unreal_speech_api_key:\n            all_credentials.append(unreal_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.unreal_speech_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "unreal_speech_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(unreal_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(unreal_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(unreal_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(unreal_credentials)",
                                      "children": [
                                        {
                                          "value": "unreal_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if settings.secrets.open_router_api_key:\n            all_credentials.append(open_router_credentials)",
                      "children": [
                        {
                          "value": "settings.secrets.open_router_api_key",
                          "children": [
                            {
                              "value": "settings.secrets",
                              "children": [
                                {
                                  "value": "settings",
                                  "children": []
                                },
                                {
                                  "value": "secrets",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "open_router_api_key",
                              "children": []
                            }
                          ]
                        },
                        {
                          "value": "all_credentials.append(open_router_credentials)",
                          "children": [
                            {
                              "value": "all_credentials.append(open_router_credentials)",
                              "children": [
                                {
                                  "value": "all_credentials.append(open_router_credentials)",
                                  "children": [
                                    {
                                      "value": "all_credentials.append",
                                      "children": [
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(open_router_credentials)",
                                      "children": [
                                        {
                                          "value": "open_router_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return all_credentials",
                      "children": [
                        {
                          "value": "all_credentials",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def get_creds_by_id(self, user_id: str, credentials_id: str) -> Credentials | None:\n        all_credentials = self.get_all_creds(user_id)\n        return next((c for c in all_credentials if c.id == credentials_id), None)",
              "children": [
                {
                  "value": "get_creds_by_id",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, credentials_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "credentials_id: str",
                      "children": [
                        {
                          "value": "credentials_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "Credentials | None",
                  "children": [
                    {
                      "value": "Credentials | None",
                      "children": [
                        {
                          "value": "Credentials",
                          "children": []
                        },
                        {
                          "value": "None",
                          "children": []
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "all_credentials = self.get_all_creds(user_id)\n        return next((c for c in all_credentials if c.id == credentials_id), None)",
                  "children": [
                    {
                      "value": "all_credentials = self.get_all_creds(user_id)",
                      "children": [
                        {
                          "value": "all_credentials = self.get_all_creds(user_id)",
                          "children": [
                            {
                              "value": "all_credentials",
                              "children": []
                            },
                            {
                              "value": "self.get_all_creds(user_id)",
                              "children": [
                                {
                                  "value": "self.get_all_creds",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "get_all_creds",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(user_id)",
                                  "children": [
                                    {
                                      "value": "user_id",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return next((c for c in all_credentials if c.id == credentials_id), None)",
                      "children": [
                        {
                          "value": "next((c for c in all_credentials if c.id == credentials_id), None)",
                          "children": [
                            {
                              "value": "next",
                              "children": []
                            },
                            {
                              "value": "((c for c in all_credentials if c.id == credentials_id), None)",
                              "children": [
                                {
                                  "value": "(c for c in all_credentials if c.id == credentials_id)",
                                  "children": [
                                    {
                                      "value": "c",
                                      "children": []
                                    },
                                    {
                                      "value": "for c in all_credentials",
                                      "children": [
                                        {
                                          "value": "c",
                                          "children": []
                                        },
                                        {
                                          "value": "all_credentials",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "if c.id == credentials_id",
                                      "children": [
                                        {
                                          "value": "c.id == credentials_id",
                                          "children": [
                                            {
                                              "value": "c.id",
                                              "children": [
                                                {
                                                  "value": "c",
                                                  "children": []
                                                },
                                                {
                                                  "value": "id",
                                                  "children": []
                                                }
                                              ]
                                            },
                                            {
                                              "value": "credentials_id",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "None",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def get_creds_by_provider(self, user_id: str, provider: str) -> list[Credentials]:\n        credentials = self.get_all_creds(user_id)\n        return [c for c in credentials if c.provider == provider]",
              "children": [
                {
                  "value": "get_creds_by_provider",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, provider: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider: str",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "list[Credentials]",
                  "children": [
                    {
                      "value": "list[Credentials]",
                      "children": [
                        {
                          "value": "list",
                          "children": []
                        },
                        {
                          "value": "[Credentials]",
                          "children": [
                            {
                              "value": "Credentials",
                              "children": [
                                {
                                  "value": "Credentials",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "credentials = self.get_all_creds(user_id)\n        return [c for c in credentials if c.provider == provider]",
                  "children": [
                    {
                      "value": "credentials = self.get_all_creds(user_id)",
                      "children": [
                        {
                          "value": "credentials = self.get_all_creds(user_id)",
                          "children": [
                            {
                              "value": "credentials",
                              "children": []
                            },
                            {
                              "value": "self.get_all_creds(user_id)",
                              "children": [
                                {
                                  "value": "self.get_all_creds",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "get_all_creds",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(user_id)",
                                  "children": [
                                    {
                                      "value": "user_id",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return [c for c in credentials if c.provider == provider]",
                      "children": [
                        {
                          "value": "[c for c in credentials if c.provider == provider]",
                          "children": [
                            {
                              "value": "c",
                              "children": []
                            },
                            {
                              "value": "for c in credentials",
                              "children": [
                                {
                                  "value": "c",
                                  "children": []
                                },
                                {
                                  "value": "credentials",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "if c.provider == provider",
                              "children": [
                                {
                                  "value": "c.provider == provider",
                                  "children": [
                                    {
                                      "value": "c.provider",
                                      "children": [
                                        {
                                          "value": "c",
                                          "children": []
                                        },
                                        {
                                          "value": "provider",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "provider",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def get_authorized_providers(self, user_id: str) -> list[str]:\n        credentials = self.get_all_creds(user_id)\n        return list(set(c.provider for c in credentials))",
              "children": [
                {
                  "value": "get_authorized_providers",
                  "children": []
                },
                {
                  "value": "(self, user_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "list[str]",
                  "children": [
                    {
                      "value": "list[str]",
                      "children": [
                        {
                          "value": "list",
                          "children": []
                        },
                        {
                          "value": "[str]",
                          "children": [
                            {
                              "value": "str",
                              "children": [
                                {
                                  "value": "str",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "credentials = self.get_all_creds(user_id)\n        return list(set(c.provider for c in credentials))",
                  "children": [
                    {
                      "value": "credentials = self.get_all_creds(user_id)",
                      "children": [
                        {
                          "value": "credentials = self.get_all_creds(user_id)",
                          "children": [
                            {
                              "value": "credentials",
                              "children": []
                            },
                            {
                              "value": "self.get_all_creds(user_id)",
                              "children": [
                                {
                                  "value": "self.get_all_creds",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "get_all_creds",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(user_id)",
                                  "children": [
                                    {
                                      "value": "user_id",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return list(set(c.provider for c in credentials))",
                      "children": [
                        {
                          "value": "list(set(c.provider for c in credentials))",
                          "children": [
                            {
                              "value": "list",
                              "children": []
                            },
                            {
                              "value": "(set(c.provider for c in credentials))",
                              "children": [
                                {
                                  "value": "set(c.provider for c in credentials)",
                                  "children": [
                                    {
                                      "value": "set",
                                      "children": []
                                    },
                                    {
                                      "value": "(c.provider for c in credentials)",
                                      "children": [
                                        {
                                          "value": "c.provider",
                                          "children": [
                                            {
                                              "value": "c",
                                              "children": []
                                            },
                                            {
                                              "value": "provider",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "for c in credentials",
                                          "children": [
                                            {
                                              "value": "c",
                                              "children": []
                                            },
                                            {
                                              "value": "credentials",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def update_creds(self, user_id: str, updated: Credentials) -> None:\n        with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)",
              "children": [
                {
                  "value": "update_creds",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, updated: Credentials)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "updated: Credentials",
                      "children": [
                        {
                          "value": "updated",
                          "children": []
                        },
                        {
                          "value": "Credentials",
                          "children": [
                            {
                              "value": "Credentials",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "None",
                  "children": [
                    {
                      "value": "None",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)",
                  "children": [
                    {
                      "value": "with self.locked_user_integrations(user_id):\n            current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)",
                      "children": [
                        {
                          "value": "self.locked_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "self.locked_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self.locked_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self.locked_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "locked_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "current = self.get_creds_by_id(user_id, updated.id)\n            if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )\n            if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )\n\n            # Ensure no scopes are removed when updating credentials\n            if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )\n\n            # Update the credentials\n            updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]\n            self._set_user_integration_creds(user_id, updated_credentials_list)",
                          "children": [
                            {
                              "value": "current = self.get_creds_by_id(user_id, updated.id)",
                              "children": [
                                {
                                  "value": "current = self.get_creds_by_id(user_id, updated.id)",
                                  "children": [
                                    {
                                      "value": "current",
                                      "children": []
                                    },
                                    {
                                      "value": "self.get_creds_by_id(user_id, updated.id)",
                                      "children": [
                                        {
                                          "value": "self.get_creds_by_id",
                                          "children": [
                                            {
                                              "value": "self",
                                              "children": []
                                            },
                                            {
                                              "value": "get_creds_by_id",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "(user_id, updated.id)",
                                          "children": [
                                            {
                                              "value": "user_id",
                                              "children": []
                                            },
                                            {
                                              "value": "updated.id",
                                              "children": [
                                                {
                                                  "value": "updated",
                                                  "children": []
                                                },
                                                {
                                                  "value": "id",
                                                  "children": []
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "if not current:\n                raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )",
                              "children": [
                                {
                                  "value": "not current",
                                  "children": [
                                    {
                                      "value": "current",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )",
                                  "children": [
                                    {
                                      "value": "raise ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )",
                                      "children": [
                                        {
                                          "value": "ValueError(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )",
                                          "children": [
                                            {
                                              "value": "ValueError",
                                              "children": []
                                            },
                                            {
                                              "value": "(\n                    f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"\n                )",
                                              "children": [
                                                {
                                                  "value": "f\"Credentials with ID {updated.id} \"\n                    f\"for user with ID {user_id} not found\"",
                                                  "children": [
                                                    {
                                                      "value": "f\"Credentials with ID {updated.id} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "Credentials with ID",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{updated.id}",
                                                          "children": [
                                                            {
                                                              "value": "updated.id",
                                                              "children": [
                                                                {
                                                                  "value": "updated",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "id",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"for user with ID {user_id} not found\"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "for user with ID",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{user_id}",
                                                          "children": [
                                                            {
                                                              "value": "user_id",
                                                              "children": []
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "not found",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "if type(current) is not type(updated):\n                raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )",
                              "children": [
                                {
                                  "value": "type(current) is not type(updated)",
                                  "children": [
                                    {
                                      "value": "type(current)",
                                      "children": [
                                        {
                                          "value": "type",
                                          "children": []
                                        },
                                        {
                                          "value": "(current)",
                                          "children": [
                                            {
                                              "value": "current",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "type(updated)",
                                      "children": [
                                        {
                                          "value": "type",
                                          "children": []
                                        },
                                        {
                                          "value": "(updated)",
                                          "children": [
                                            {
                                              "value": "updated",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )",
                                  "children": [
                                    {
                                      "value": "raise TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )",
                                      "children": [
                                        {
                                          "value": "TypeError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )",
                                          "children": [
                                            {
                                              "value": "TypeError",
                                              "children": []
                                            },
                                            {
                                              "value": "(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"\n                )",
                                              "children": [
                                                {
                                                  "value": "f\"Can not update credentials with ID {updated.id} \"\n                    f\"from type {type(current)} \"\n                    f\"to type {type(updated)}\"",
                                                  "children": [
                                                    {
                                                      "value": "f\"Can not update credentials with ID {updated.id} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "Can not update credentials with ID",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{updated.id}",
                                                          "children": [
                                                            {
                                                              "value": "updated.id",
                                                              "children": [
                                                                {
                                                                  "value": "updated",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "id",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"from type {type(current)} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "from type",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{type(current)}",
                                                          "children": [
                                                            {
                                                              "value": "type(current)",
                                                              "children": [
                                                                {
                                                                  "value": "type",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "(current)",
                                                                  "children": [
                                                                    {
                                                                      "value": "current",
                                                                      "children": []
                                                                    }
                                                                  ]
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"to type {type(updated)}\"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "to type",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{type(updated)}",
                                                          "children": [
                                                            {
                                                              "value": "type(updated)",
                                                              "children": [
                                                                {
                                                                  "value": "type",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "(updated)",
                                                                  "children": [
                                                                    {
                                                                      "value": "updated",
                                                                      "children": []
                                                                    }
                                                                  ]
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "# Ensure no scopes are removed when updating credentials",
                              "children": []
                            },
                            {
                              "value": "if (\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            ):\n                raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )",
                              "children": [
                                {
                                  "value": "(\n                isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)\n            )",
                                  "children": [
                                    {
                                      "value": "isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)\n                and not set(updated.scopes).issuperset(current.scopes)",
                                      "children": [
                                        {
                                          "value": "isinstance(updated, OAuth2Credentials)\n                and isinstance(current, OAuth2Credentials)",
                                          "children": [
                                            {
                                              "value": "isinstance(updated, OAuth2Credentials)",
                                              "children": [
                                                {
                                                  "value": "isinstance",
                                                  "children": []
                                                },
                                                {
                                                  "value": "(updated, OAuth2Credentials)",
                                                  "children": [
                                                    {
                                                      "value": "updated",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "OAuth2Credentials",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "value": "isinstance(current, OAuth2Credentials)",
                                              "children": [
                                                {
                                                  "value": "isinstance",
                                                  "children": []
                                                },
                                                {
                                                  "value": "(current, OAuth2Credentials)",
                                                  "children": [
                                                    {
                                                      "value": "current",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "OAuth2Credentials",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        },
                                        {
                                          "value": "not set(updated.scopes).issuperset(current.scopes)",
                                          "children": [
                                            {
                                              "value": "set(updated.scopes).issuperset(current.scopes)",
                                              "children": [
                                                {
                                                  "value": "set(updated.scopes).issuperset",
                                                  "children": [
                                                    {
                                                      "value": "set(updated.scopes)",
                                                      "children": [
                                                        {
                                                          "value": "set",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "(updated.scopes)",
                                                          "children": [
                                                            {
                                                              "value": "updated.scopes",
                                                              "children": [
                                                                {
                                                                  "value": "updated",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "scopes",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "issuperset",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "(current.scopes)",
                                                  "children": [
                                                    {
                                                      "value": "current.scopes",
                                                      "children": [
                                                        {
                                                          "value": "current",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "scopes",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )",
                                  "children": [
                                    {
                                      "value": "raise ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )",
                                      "children": [
                                        {
                                          "value": "ValueError(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )",
                                          "children": [
                                            {
                                              "value": "ValueError",
                                              "children": []
                                            },
                                            {
                                              "value": "(\n                    f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"\n                )",
                                              "children": [
                                                {
                                                  "value": "f\"Can not update credentials with ID {updated.id} \"\n                    f\"and scopes {current.scopes} \"\n                    f\"to more restrictive set of scopes {updated.scopes}\"",
                                                  "children": [
                                                    {
                                                      "value": "f\"Can not update credentials with ID {updated.id} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "Can not update credentials with ID",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{updated.id}",
                                                          "children": [
                                                            {
                                                              "value": "updated.id",
                                                              "children": [
                                                                {
                                                                  "value": "updated",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "id",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"and scopes {current.scopes} \"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "and scopes",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{current.scopes}",
                                                          "children": [
                                                            {
                                                              "value": "current.scopes",
                                                              "children": [
                                                                {
                                                                  "value": "current",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "scopes",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "f\"to more restrictive set of scopes {updated.scopes}\"",
                                                      "children": [
                                                        {
                                                          "value": "f\"",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "to more restrictive set of scopes",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "{updated.scopes}",
                                                          "children": [
                                                            {
                                                              "value": "updated.scopes",
                                                              "children": [
                                                                {
                                                                  "value": "updated",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "scopes",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "\"",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "# Update the credentials",
                              "children": []
                            },
                            {
                              "value": "updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]",
                              "children": [
                                {
                                  "value": "updated_credentials_list = [\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]",
                                  "children": [
                                    {
                                      "value": "updated_credentials_list",
                                      "children": []
                                    },
                                    {
                                      "value": "[\n                updated if c.id == updated.id else c\n                for c in self.get_all_creds(user_id)\n            ]",
                                      "children": [
                                        {
                                          "value": "updated if c.id == updated.id else c",
                                          "children": [
                                            {
                                              "value": "updated",
                                              "children": []
                                            },
                                            {
                                              "value": "c.id == updated.id",
                                              "children": [
                                                {
                                                  "value": "c.id",
                                                  "children": [
                                                    {
                                                      "value": "c",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "id",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "updated.id",
                                                  "children": [
                                                    {
                                                      "value": "updated",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "id",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "value": "c",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "for c in self.get_all_creds(user_id)",
                                          "children": [
                                            {
                                              "value": "c",
                                              "children": []
                                            },
                                            {
                                              "value": "self.get_all_creds(user_id)",
                                              "children": [
                                                {
                                                  "value": "self.get_all_creds",
                                                  "children": [
                                                    {
                                                      "value": "self",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "get_all_creds",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "(user_id)",
                                                  "children": [
                                                    {
                                                      "value": "user_id",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "self._set_user_integration_creds(user_id, updated_credentials_list)",
                              "children": [
                                {
                                  "value": "self._set_user_integration_creds(user_id, updated_credentials_list)",
                                  "children": [
                                    {
                                      "value": "self._set_user_integration_creds",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "_set_user_integration_creds",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id, updated_credentials_list)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        },
                                        {
                                          "value": "updated_credentials_list",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def delete_creds_by_id(self, user_id: str, credentials_id: str) -> None:\n        with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)",
              "children": [
                {
                  "value": "delete_creds_by_id",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, credentials_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "credentials_id: str",
                      "children": [
                        {
                          "value": "credentials_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "None",
                  "children": [
                    {
                      "value": "None",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)",
                  "children": [
                    {
                      "value": "with self.locked_user_integrations(user_id):\n            filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)",
                      "children": [
                        {
                          "value": "self.locked_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "self.locked_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self.locked_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self.locked_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "locked_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]\n            self._set_user_integration_creds(user_id, filtered_credentials)",
                          "children": [
                            {
                              "value": "filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]",
                              "children": [
                                {
                                  "value": "filtered_credentials = [\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]",
                                  "children": [
                                    {
                                      "value": "filtered_credentials",
                                      "children": []
                                    },
                                    {
                                      "value": "[\n                c for c in self.get_all_creds(user_id) if c.id != credentials_id\n            ]",
                                      "children": [
                                        {
                                          "value": "c",
                                          "children": []
                                        },
                                        {
                                          "value": "for c in self.get_all_creds(user_id)",
                                          "children": [
                                            {
                                              "value": "c",
                                              "children": []
                                            },
                                            {
                                              "value": "self.get_all_creds(user_id)",
                                              "children": [
                                                {
                                                  "value": "self.get_all_creds",
                                                  "children": [
                                                    {
                                                      "value": "self",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "get_all_creds",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "(user_id)",
                                                  "children": [
                                                    {
                                                      "value": "user_id",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        },
                                        {
                                          "value": "if c.id != credentials_id",
                                          "children": [
                                            {
                                              "value": "c.id != credentials_id",
                                              "children": [
                                                {
                                                  "value": "c.id",
                                                  "children": [
                                                    {
                                                      "value": "c",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "id",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "credentials_id",
                                                  "children": []
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "self._set_user_integration_creds(user_id, filtered_credentials)",
                              "children": [
                                {
                                  "value": "self._set_user_integration_creds(user_id, filtered_credentials)",
                                  "children": [
                                    {
                                      "value": "self._set_user_integration_creds",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "_set_user_integration_creds",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id, filtered_credentials)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        },
                                        {
                                          "value": "filtered_credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def store_state_token(self, user_id: str, provider: str, scopes: list[str]) -> str:\n        token = secrets.token_urlsafe(32)\n        expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)\n\n        state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )\n\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )\n\n        return token",
              "children": [
                {
                  "value": "store_state_token",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, provider: str, scopes: list[str])",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider: str",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "scopes: list[str]",
                      "children": [
                        {
                          "value": "scopes",
                          "children": []
                        },
                        {
                          "value": "list[str]",
                          "children": [
                            {
                              "value": "list[str]",
                              "children": [
                                {
                                  "value": "list",
                                  "children": []
                                },
                                {
                                  "value": "[str]",
                                  "children": [
                                    {
                                      "value": "str",
                                      "children": [
                                        {
                                          "value": "str",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "str",
                  "children": [
                    {
                      "value": "str",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "token = secrets.token_urlsafe(32)\n        expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)\n\n        state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )\n\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )\n\n        return token",
                  "children": [
                    {
                      "value": "token = secrets.token_urlsafe(32)",
                      "children": [
                        {
                          "value": "token = secrets.token_urlsafe(32)",
                          "children": [
                            {
                              "value": "token",
                              "children": []
                            },
                            {
                              "value": "secrets.token_urlsafe(32)",
                              "children": [
                                {
                                  "value": "secrets.token_urlsafe",
                                  "children": [
                                    {
                                      "value": "secrets",
                                      "children": []
                                    },
                                    {
                                      "value": "token_urlsafe",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(32)",
                                  "children": [
                                    {
                                      "value": "32",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)",
                      "children": [
                        {
                          "value": "expires_at = datetime.now(timezone.utc) + timedelta(minutes=10)",
                          "children": [
                            {
                              "value": "expires_at",
                              "children": []
                            },
                            {
                              "value": "datetime.now(timezone.utc) + timedelta(minutes=10)",
                              "children": [
                                {
                                  "value": "datetime.now(timezone.utc)",
                                  "children": [
                                    {
                                      "value": "datetime.now",
                                      "children": [
                                        {
                                          "value": "datetime",
                                          "children": []
                                        },
                                        {
                                          "value": "now",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(timezone.utc)",
                                      "children": [
                                        {
                                          "value": "timezone.utc",
                                          "children": [
                                            {
                                              "value": "timezone",
                                              "children": []
                                            },
                                            {
                                              "value": "utc",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "value": "timedelta(minutes=10)",
                                  "children": [
                                    {
                                      "value": "timedelta",
                                      "children": []
                                    },
                                    {
                                      "value": "(minutes=10)",
                                      "children": [
                                        {
                                          "value": "minutes=10",
                                          "children": [
                                            {
                                              "value": "minutes",
                                              "children": []
                                            },
                                            {
                                              "value": "10",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )",
                      "children": [
                        {
                          "value": "state = OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )",
                          "children": [
                            {
                              "value": "state",
                              "children": []
                            },
                            {
                              "value": "OAuthState(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )",
                              "children": [
                                {
                                  "value": "OAuthState",
                                  "children": []
                                },
                                {
                                  "value": "(\n            token=token,\n            provider=provider,\n            expires_at=int(expires_at.timestamp()),\n            scopes=scopes,\n        )",
                                  "children": [
                                    {
                                      "value": "token=token",
                                      "children": [
                                        {
                                          "value": "token",
                                          "children": []
                                        },
                                        {
                                          "value": "token",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "provider=provider",
                                      "children": [
                                        {
                                          "value": "provider",
                                          "children": []
                                        },
                                        {
                                          "value": "provider",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "expires_at=int(expires_at.timestamp())",
                                      "children": [
                                        {
                                          "value": "expires_at",
                                          "children": []
                                        },
                                        {
                                          "value": "int(expires_at.timestamp())",
                                          "children": [
                                            {
                                              "value": "int",
                                              "children": []
                                            },
                                            {
                                              "value": "(expires_at.timestamp())",
                                              "children": [
                                                {
                                                  "value": "expires_at.timestamp()",
                                                  "children": [
                                                    {
                                                      "value": "expires_at.timestamp",
                                                      "children": [
                                                        {
                                                          "value": "expires_at",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "timestamp",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "()",
                                                      "children": []
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "scopes=scopes",
                                      "children": [
                                        {
                                          "value": "scopes",
                                          "children": []
                                        },
                                        {
                                          "value": "scopes",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )",
                      "children": [
                        {
                          "value": "self.locked_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "self.locked_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self.locked_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self.locked_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "locked_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n            oauth_states.append(state)\n            user_integrations.oauth_states = oauth_states\n\n            self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )",
                          "children": [
                            {
                              "value": "user_integrations = self._get_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "user_integrations = self._get_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "user_integrations",
                                      "children": []
                                    },
                                    {
                                      "value": "self._get_user_integrations(user_id)",
                                      "children": [
                                        {
                                          "value": "self._get_user_integrations",
                                          "children": [
                                            {
                                              "value": "self",
                                              "children": []
                                            },
                                            {
                                              "value": "_get_user_integrations",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "(user_id)",
                                          "children": [
                                            {
                                              "value": "user_id",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "oauth_states = user_integrations.oauth_states",
                              "children": [
                                {
                                  "value": "oauth_states = user_integrations.oauth_states",
                                  "children": [
                                    {
                                      "value": "oauth_states",
                                      "children": []
                                    },
                                    {
                                      "value": "user_integrations.oauth_states",
                                      "children": [
                                        {
                                          "value": "user_integrations",
                                          "children": []
                                        },
                                        {
                                          "value": "oauth_states",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "oauth_states.append(state)",
                              "children": [
                                {
                                  "value": "oauth_states.append(state)",
                                  "children": [
                                    {
                                      "value": "oauth_states.append",
                                      "children": [
                                        {
                                          "value": "oauth_states",
                                          "children": []
                                        },
                                        {
                                          "value": "append",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(state)",
                                      "children": [
                                        {
                                          "value": "state",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "user_integrations.oauth_states = oauth_states",
                              "children": [
                                {
                                  "value": "user_integrations.oauth_states = oauth_states",
                                  "children": [
                                    {
                                      "value": "user_integrations.oauth_states",
                                      "children": [
                                        {
                                          "value": "user_integrations",
                                          "children": []
                                        },
                                        {
                                          "value": "oauth_states",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "oauth_states",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )",
                              "children": [
                                {
                                  "value": "self.db_manager.update_user_integrations(\n                user_id=user_id, data=user_integrations\n            )",
                                  "children": [
                                    {
                                      "value": "self.db_manager.update_user_integrations",
                                      "children": [
                                        {
                                          "value": "self.db_manager",
                                          "children": [
                                            {
                                              "value": "self",
                                              "children": []
                                            },
                                            {
                                              "value": "db_manager",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "update_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(\n                user_id=user_id, data=user_integrations\n            )",
                                      "children": [
                                        {
                                          "value": "user_id=user_id",
                                          "children": [
                                            {
                                              "value": "user_id",
                                              "children": []
                                            },
                                            {
                                              "value": "user_id",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "data=user_integrations",
                                          "children": [
                                            {
                                              "value": "data",
                                              "children": []
                                            },
                                            {
                                              "value": "user_integrations",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return token",
                      "children": [
                        {
                          "value": "token",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def get_any_valid_scopes_from_state_token(\n        self, user_id: str, token: str, provider: str\n    ) -> list[str]:\n        \"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"\n        user_integrations = self._get_user_integrations(user_id)\n        oauth_states = user_integrations.oauth_states\n\n        now = datetime.now(timezone.utc)\n        valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )\n\n        if valid_state:\n            return valid_state.scopes\n\n        return []",
              "children": [
                {
                  "value": "get_any_valid_scopes_from_state_token",
                  "children": []
                },
                {
                  "value": "(\n        self, user_id: str, token: str, provider: str\n    )",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "token: str",
                      "children": [
                        {
                          "value": "token",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider: str",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "list[str]",
                  "children": [
                    {
                      "value": "list[str]",
                      "children": [
                        {
                          "value": "list",
                          "children": []
                        },
                        {
                          "value": "[str]",
                          "children": [
                            {
                              "value": "str",
                              "children": [
                                {
                                  "value": "str",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "\"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"\n        user_integrations = self._get_user_integrations(user_id)\n        oauth_states = user_integrations.oauth_states\n\n        now = datetime.now(timezone.utc)\n        valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )\n\n        if valid_state:\n            return valid_state.scopes\n\n        return []",
                  "children": [
                    {
                      "value": "\"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"",
                      "children": [
                        {
                          "value": "\"\"\"\n        Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.\n        \"\"\"",
                          "children": [
                            {
                              "value": "\"\"\"",
                              "children": []
                            },
                            {
                              "value": "Get the valid scopes from the OAuth state token. This will return any valid scopes\n        from any OAuth state token for the given provider. If no valid scopes are found,\n        an empty list is returned. DO NOT RELY ON THIS TOKEN TO AUTHENTICATE A USER, AS IT\n        IS TO CHECK IF THE USER HAS GIVEN PERMISSIONS TO THE APPLICATION BEFORE EXCHANGING\n        THE CODE FOR TOKENS.",
                              "children": []
                            },
                            {
                              "value": "\"\"\"",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "user_integrations = self._get_user_integrations(user_id)",
                      "children": [
                        {
                          "value": "user_integrations = self._get_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "user_integrations",
                              "children": []
                            },
                            {
                              "value": "self._get_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self._get_user_integrations",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "_get_user_integrations",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(user_id)",
                                  "children": [
                                    {
                                      "value": "user_id",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "oauth_states = user_integrations.oauth_states",
                      "children": [
                        {
                          "value": "oauth_states = user_integrations.oauth_states",
                          "children": [
                            {
                              "value": "oauth_states",
                              "children": []
                            },
                            {
                              "value": "user_integrations.oauth_states",
                              "children": [
                                {
                                  "value": "user_integrations",
                                  "children": []
                                },
                                {
                                  "value": "oauth_states",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "now = datetime.now(timezone.utc)",
                      "children": [
                        {
                          "value": "now = datetime.now(timezone.utc)",
                          "children": [
                            {
                              "value": "now",
                              "children": []
                            },
                            {
                              "value": "datetime.now(timezone.utc)",
                              "children": [
                                {
                                  "value": "datetime.now",
                                  "children": [
                                    {
                                      "value": "datetime",
                                      "children": []
                                    },
                                    {
                                      "value": "now",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(timezone.utc)",
                                  "children": [
                                    {
                                      "value": "timezone.utc",
                                      "children": [
                                        {
                                          "value": "timezone",
                                          "children": []
                                        },
                                        {
                                          "value": "utc",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )",
                      "children": [
                        {
                          "value": "valid_state = next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )",
                          "children": [
                            {
                              "value": "valid_state",
                              "children": []
                            },
                            {
                              "value": "next(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )",
                              "children": [
                                {
                                  "value": "next",
                                  "children": []
                                },
                                {
                                  "value": "(\n            (\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            ),\n            None,\n        )",
                                  "children": [
                                    {
                                      "value": "(\n                state\n                for state in oauth_states\n                if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()\n            )",
                                      "children": [
                                        {
                                          "value": "state",
                                          "children": []
                                        },
                                        {
                                          "value": "for state in oauth_states",
                                          "children": [
                                            {
                                              "value": "state",
                                              "children": []
                                            },
                                            {
                                              "value": "oauth_states",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "if state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()",
                                          "children": [
                                            {
                                              "value": "state.token == token\n                and state.provider == provider\n                and state.expires_at > now.timestamp()",
                                              "children": [
                                                {
                                                  "value": "state.token == token\n                and state.provider == provider",
                                                  "children": [
                                                    {
                                                      "value": "state.token == token",
                                                      "children": [
                                                        {
                                                          "value": "state.token",
                                                          "children": [
                                                            {
                                                              "value": "state",
                                                              "children": []
                                                            },
                                                            {
                                                              "value": "token",
                                                              "children": []
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "token",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "state.provider == provider",
                                                      "children": [
                                                        {
                                                          "value": "state.provider",
                                                          "children": [
                                                            {
                                                              "value": "state",
                                                              "children": []
                                                            },
                                                            {
                                                              "value": "provider",
                                                              "children": []
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "provider",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "state.expires_at > now.timestamp()",
                                                  "children": [
                                                    {
                                                      "value": "state.expires_at",
                                                      "children": [
                                                        {
                                                          "value": "state",
                                                          "children": []
                                                        },
                                                        {
                                                          "value": "expires_at",
                                                          "children": []
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "value": "now.timestamp()",
                                                      "children": [
                                                        {
                                                          "value": "now.timestamp",
                                                          "children": [
                                                            {
                                                              "value": "now",
                                                              "children": []
                                                            },
                                                            {
                                                              "value": "timestamp",
                                                              "children": []
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "()",
                                                          "children": []
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "None",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "if valid_state:\n            return valid_state.scopes",
                      "children": [
                        {
                          "value": "valid_state",
                          "children": []
                        },
                        {
                          "value": "return valid_state.scopes",
                          "children": [
                            {
                              "value": "return valid_state.scopes",
                              "children": [
                                {
                                  "value": "valid_state.scopes",
                                  "children": [
                                    {
                                      "value": "valid_state",
                                      "children": []
                                    },
                                    {
                                      "value": "scopes",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return []",
                      "children": [
                        {
                          "value": "[]",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def verify_state_token(self, user_id: str, token: str, provider: str) -> bool:\n        with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True\n\n        return False",
              "children": [
                {
                  "value": "verify_state_token",
                  "children": []
                },
                {
                  "value": "(self, user_id: str, token: str, provider: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "token: str",
                      "children": [
                        {
                          "value": "token",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "provider: str",
                      "children": [
                        {
                          "value": "provider",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "bool",
                  "children": [
                    {
                      "value": "bool",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True\n\n        return False",
                  "children": [
                    {
                      "value": "with self.locked_user_integrations(user_id):\n            user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True",
                      "children": [
                        {
                          "value": "self.locked_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "self.locked_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self.locked_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "self.locked_user_integrations",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "locked_user_integrations",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "(user_id)",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "value": "user_integrations = self._get_user_integrations(user_id)\n            oauth_states = user_integrations.oauth_states\n\n            now = datetime.now(timezone.utc)\n            valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )\n\n            if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True",
                          "children": [
                            {
                              "value": "user_integrations = self._get_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "user_integrations = self._get_user_integrations(user_id)",
                                  "children": [
                                    {
                                      "value": "user_integrations",
                                      "children": []
                                    },
                                    {
                                      "value": "self._get_user_integrations(user_id)",
                                      "children": [
                                        {
                                          "value": "self._get_user_integrations",
                                          "children": [
                                            {
                                              "value": "self",
                                              "children": []
                                            },
                                            {
                                              "value": "_get_user_integrations",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "(user_id)",
                                          "children": [
                                            {
                                              "value": "user_id",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "oauth_states = user_integrations.oauth_states",
                              "children": [
                                {
                                  "value": "oauth_states = user_integrations.oauth_states",
                                  "children": [
                                    {
                                      "value": "oauth_states",
                                      "children": []
                                    },
                                    {
                                      "value": "user_integrations.oauth_states",
                                      "children": [
                                        {
                                          "value": "user_integrations",
                                          "children": []
                                        },
                                        {
                                          "value": "oauth_states",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "now = datetime.now(timezone.utc)",
                              "children": [
                                {
                                  "value": "now = datetime.now(timezone.utc)",
                                  "children": [
                                    {
                                      "value": "now",
                                      "children": []
                                    },
                                    {
                                      "value": "datetime.now(timezone.utc)",
                                      "children": [
                                        {
                                          "value": "datetime.now",
                                          "children": [
                                            {
                                              "value": "datetime",
                                              "children": []
                                            },
                                            {
                                              "value": "now",
                                              "children": []
                                            }
                                          ]
                                        },
                                        {
                                          "value": "(timezone.utc)",
                                          "children": [
                                            {
                                              "value": "timezone.utc",
                                              "children": [
                                                {
                                                  "value": "timezone",
                                                  "children": []
                                                },
                                                {
                                                  "value": "utc",
                                                  "children": []
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )",
                              "children": [
                                {
                                  "value": "valid_state = next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )",
                                  "children": [
                                    {
                                      "value": "valid_state",
                                      "children": []
                                    },
                                    {
                                      "value": "next(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )",
                                      "children": [
                                        {
                                          "value": "next",
                                          "children": []
                                        },
                                        {
                                          "value": "(\n                (\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                ),\n                None,\n            )",
                                          "children": [
                                            {
                                              "value": "(\n                    state\n                    for state in oauth_states\n                    if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()\n                )",
                                              "children": [
                                                {
                                                  "value": "state",
                                                  "children": []
                                                },
                                                {
                                                  "value": "for state in oauth_states",
                                                  "children": [
                                                    {
                                                      "value": "state",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "oauth_states",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "if state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()",
                                                  "children": [
                                                    {
                                                      "value": "state.token == token\n                    and state.provider == provider\n                    and state.expires_at > now.timestamp()",
                                                      "children": [
                                                        {
                                                          "value": "state.token == token\n                    and state.provider == provider",
                                                          "children": [
                                                            {
                                                              "value": "state.token == token",
                                                              "children": [
                                                                {
                                                                  "value": "state.token",
                                                                  "children": [
                                                                    {
                                                                      "value": "state",
                                                                      "children": []
                                                                    },
                                                                    {
                                                                      "value": "token",
                                                                      "children": []
                                                                    }
                                                                  ]
                                                                },
                                                                {
                                                                  "value": "token",
                                                                  "children": []
                                                                }
                                                              ]
                                                            },
                                                            {
                                                              "value": "state.provider == provider",
                                                              "children": [
                                                                {
                                                                  "value": "state.provider",
                                                                  "children": [
                                                                    {
                                                                      "value": "state",
                                                                      "children": []
                                                                    },
                                                                    {
                                                                      "value": "provider",
                                                                      "children": []
                                                                    }
                                                                  ]
                                                                },
                                                                {
                                                                  "value": "provider",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "value": "state.expires_at > now.timestamp()",
                                                          "children": [
                                                            {
                                                              "value": "state.expires_at",
                                                              "children": [
                                                                {
                                                                  "value": "state",
                                                                  "children": []
                                                                },
                                                                {
                                                                  "value": "expires_at",
                                                                  "children": []
                                                                }
                                                              ]
                                                            },
                                                            {
                                                              "value": "now.timestamp()",
                                                              "children": [
                                                                {
                                                                  "value": "now.timestamp",
                                                                  "children": [
                                                                    {
                                                                      "value": "now",
                                                                      "children": []
                                                                    },
                                                                    {
                                                                      "value": "timestamp",
                                                                      "children": []
                                                                    }
                                                                  ]
                                                                },
                                                                {
                                                                  "value": "()",
                                                                  "children": []
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "value": "None",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "value": "if valid_state:\n                # Remove the used state\n                oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True",
                              "children": [
                                {
                                  "value": "valid_state",
                                  "children": []
                                },
                                {
                                  "value": "# Remove the used state",
                                  "children": []
                                },
                                {
                                  "value": "oauth_states.remove(valid_state)\n                user_integrations.oauth_states = oauth_states\n                self.db_manager.update_user_integrations(user_id, user_integrations)\n                return True",
                                  "children": [
                                    {
                                      "value": "oauth_states.remove(valid_state)",
                                      "children": [
                                        {
                                          "value": "oauth_states.remove(valid_state)",
                                          "children": [
                                            {
                                              "value": "oauth_states.remove",
                                              "children": [
                                                {
                                                  "value": "oauth_states",
                                                  "children": []
                                                },
                                                {
                                                  "value": "remove",
                                                  "children": []
                                                }
                                              ]
                                            },
                                            {
                                              "value": "(valid_state)",
                                              "children": [
                                                {
                                                  "value": "valid_state",
                                                  "children": []
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "user_integrations.oauth_states = oauth_states",
                                      "children": [
                                        {
                                          "value": "user_integrations.oauth_states = oauth_states",
                                          "children": [
                                            {
                                              "value": "user_integrations.oauth_states",
                                              "children": [
                                                {
                                                  "value": "user_integrations",
                                                  "children": []
                                                },
                                                {
                                                  "value": "oauth_states",
                                                  "children": []
                                                }
                                              ]
                                            },
                                            {
                                              "value": "oauth_states",
                                              "children": []
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "self.db_manager.update_user_integrations(user_id, user_integrations)",
                                      "children": [
                                        {
                                          "value": "self.db_manager.update_user_integrations(user_id, user_integrations)",
                                          "children": [
                                            {
                                              "value": "self.db_manager.update_user_integrations",
                                              "children": [
                                                {
                                                  "value": "self.db_manager",
                                                  "children": [
                                                    {
                                                      "value": "self",
                                                      "children": []
                                                    },
                                                    {
                                                      "value": "db_manager",
                                                      "children": []
                                                    }
                                                  ]
                                                },
                                                {
                                                  "value": "update_user_integrations",
                                                  "children": []
                                                }
                                              ]
                                            },
                                            {
                                              "value": "(user_id, user_integrations)",
                                              "children": [
                                                {
                                                  "value": "user_id",
                                                  "children": []
                                                },
                                                {
                                                  "value": "user_integrations",
                                                  "children": []
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "value": "return True",
                                      "children": [
                                        {
                                          "value": "True",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return False",
                      "children": [
                        {
                          "value": "False",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def _set_user_integration_creds(\n        self, user_id: str, credentials: list[Credentials]\n    ) -> None:\n        integrations = self._get_user_integrations(user_id)\n        # Remove default credentials from the list\n        credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]\n        integrations.credentials = credentials\n        self.db_manager.update_user_integrations(user_id, integrations)",
              "children": [
                {
                  "value": "_set_user_integration_creds",
                  "children": []
                },
                {
                  "value": "(\n        self, user_id: str, credentials: list[Credentials]\n    )",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "credentials: list[Credentials]",
                      "children": [
                        {
                          "value": "credentials",
                          "children": []
                        },
                        {
                          "value": "list[Credentials]",
                          "children": [
                            {
                              "value": "list[Credentials]",
                              "children": [
                                {
                                  "value": "list",
                                  "children": []
                                },
                                {
                                  "value": "[Credentials]",
                                  "children": [
                                    {
                                      "value": "Credentials",
                                      "children": [
                                        {
                                          "value": "Credentials",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "None",
                  "children": [
                    {
                      "value": "None",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "integrations = self._get_user_integrations(user_id)\n        # Remove default credentials from the list\n        credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]\n        integrations.credentials = credentials\n        self.db_manager.update_user_integrations(user_id, integrations)",
                  "children": [
                    {
                      "value": "integrations = self._get_user_integrations(user_id)",
                      "children": [
                        {
                          "value": "integrations = self._get_user_integrations(user_id)",
                          "children": [
                            {
                              "value": "integrations",
                              "children": []
                            },
                            {
                              "value": "self._get_user_integrations(user_id)",
                              "children": [
                                {
                                  "value": "self._get_user_integrations",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "_get_user_integrations",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(user_id)",
                                  "children": [
                                    {
                                      "value": "user_id",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "# Remove default credentials from the list",
                      "children": []
                    },
                    {
                      "value": "credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]",
                      "children": [
                        {
                          "value": "credentials = [c for c in credentials if c not in DEFAULT_CREDENTIALS]",
                          "children": [
                            {
                              "value": "credentials",
                              "children": []
                            },
                            {
                              "value": "[c for c in credentials if c not in DEFAULT_CREDENTIALS]",
                              "children": [
                                {
                                  "value": "c",
                                  "children": []
                                },
                                {
                                  "value": "for c in credentials",
                                  "children": [
                                    {
                                      "value": "c",
                                      "children": []
                                    },
                                    {
                                      "value": "credentials",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "if c not in DEFAULT_CREDENTIALS",
                                  "children": [
                                    {
                                      "value": "c not in DEFAULT_CREDENTIALS",
                                      "children": [
                                        {
                                          "value": "c",
                                          "children": []
                                        },
                                        {
                                          "value": "DEFAULT_CREDENTIALS",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "integrations.credentials = credentials",
                      "children": [
                        {
                          "value": "integrations.credentials = credentials",
                          "children": [
                            {
                              "value": "integrations.credentials",
                              "children": [
                                {
                                  "value": "integrations",
                                  "children": []
                                },
                                {
                                  "value": "credentials",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "credentials",
                              "children": []
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "self.db_manager.update_user_integrations(user_id, integrations)",
                      "children": [
                        {
                          "value": "self.db_manager.update_user_integrations(user_id, integrations)",
                          "children": [
                            {
                              "value": "self.db_manager.update_user_integrations",
                              "children": [
                                {
                                  "value": "self.db_manager",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "db_manager",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "update_user_integrations",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "(user_id, integrations)",
                              "children": [
                                {
                                  "value": "user_id",
                                  "children": []
                                },
                                {
                                  "value": "integrations",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def _get_user_integrations(self, user_id: str) -> UserIntegrations:\n        integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )\n        return integrations",
              "children": [
                {
                  "value": "_get_user_integrations",
                  "children": []
                },
                {
                  "value": "(self, user_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "UserIntegrations",
                  "children": [
                    {
                      "value": "UserIntegrations",
                      "children": []
                    }
                  ]
                },
                {
                  "value": "integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )\n        return integrations",
                  "children": [
                    {
                      "value": "integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )",
                      "children": [
                        {
                          "value": "integrations: UserIntegrations = self.db_manager.get_user_integrations(\n            user_id=user_id\n        )",
                          "children": [
                            {
                              "value": "integrations",
                              "children": []
                            },
                            {
                              "value": "UserIntegrations",
                              "children": [
                                {
                                  "value": "UserIntegrations",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "self.db_manager.get_user_integrations(\n            user_id=user_id\n        )",
                              "children": [
                                {
                                  "value": "self.db_manager.get_user_integrations",
                                  "children": [
                                    {
                                      "value": "self.db_manager",
                                      "children": [
                                        {
                                          "value": "self",
                                          "children": []
                                        },
                                        {
                                          "value": "db_manager",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "get_user_integrations",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "(\n            user_id=user_id\n        )",
                                  "children": [
                                    {
                                      "value": "user_id=user_id",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        },
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return integrations",
                      "children": [
                        {
                          "value": "integrations",
                          "children": []
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "value": "def locked_user_integrations(self, user_id: str):\n        key = (f\"user:{user_id}\", \"integrations\")\n        return self.locks.locked(key)",
              "children": [
                {
                  "value": "locked_user_integrations",
                  "children": []
                },
                {
                  "value": "(self, user_id: str)",
                  "children": [
                    {
                      "value": "self",
                      "children": []
                    },
                    {
                      "value": "user_id: str",
                      "children": [
                        {
                          "value": "user_id",
                          "children": []
                        },
                        {
                          "value": "str",
                          "children": [
                            {
                              "value": "str",
                              "children": []
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "value": "key = (f\"user:{user_id}\", \"integrations\")\n        return self.locks.locked(key)",
                  "children": [
                    {
                      "value": "key = (f\"user:{user_id}\", \"integrations\")",
                      "children": [
                        {
                          "value": "key = (f\"user:{user_id}\", \"integrations\")",
                          "children": [
                            {
                              "value": "key",
                              "children": []
                            },
                            {
                              "value": "(f\"user:{user_id}\", \"integrations\")",
                              "children": [
                                {
                                  "value": "f\"user:{user_id}\"",
                                  "children": [
                                    {
                                      "value": "f\"",
                                      "children": []
                                    },
                                    {
                                      "value": "user:",
                                      "children": []
                                    },
                                    {
                                      "value": "{user_id}",
                                      "children": [
                                        {
                                          "value": "user_id",
                                          "children": []
                                        }
                                      ]
                                    },
                                    {
                                      "value": "\"",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "\"integrations\"",
                                  "children": [
                                    {
                                      "value": "\"",
                                      "children": []
                                    },
                                    {
                                      "value": "integrations",
                                      "children": []
                                    },
                                    {
                                      "value": "\"",
                                      "children": []
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "value": "return self.locks.locked(key)",
                      "children": [
                        {
                          "value": "self.locks.locked(key)",
                          "children": [
                            {
                              "value": "self.locks.locked",
                              "children": [
                                {
                                  "value": "self.locks",
                                  "children": [
                                    {
                                      "value": "self",
                                      "children": []
                                    },
                                    {
                                      "value": "locks",
                                      "children": []
                                    }
                                  ]
                                },
                                {
                                  "value": "locked",
                                  "children": []
                                }
                              ]
                            },
                            {
                              "value": "(key)",
                              "children": [
                                {
                                  "value": "key",
                                  "children": []
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}